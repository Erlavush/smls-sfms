--- START FILE: .gitignore ---
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/versions

# testing
/coverage

# Local Uploads (Development Only!)
/public/uploads/

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# env files (can opt-in for committing if needed)
.env*

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts


--- END FILE: .gitignore ---

--- START FILE: eslint.config.mjs ---
import { dirname } from "path";
import { fileURLToPath } from "url";
import { FlatCompat } from "@eslint/eslintrc";

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const compat = new FlatCompat({
  baseDirectory: __dirname,
});

const eslintConfig = [
  ...compat.extends("next/core-web-vitals", "next/typescript"),
];

export default eslintConfig;


--- END FILE: eslint.config.mjs ---

--- START FILE: next-env.d.ts ---
/// <reference types="next" />
/// <reference types="next/image-types/global" />

// NOTE: This file should not be edited
// see https://nextjs.org/docs/app/api-reference/config/typescript for more information.


--- END FILE: next-env.d.ts ---

--- START FILE: next.config.ts ---
// next.config.ts
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  // The 'images' configuration block
  images: {
    // Keep your existing SVG settings if needed
    dangerouslyAllowSVG: true,
    contentSecurityPolicy: "default-src 'self'; script-src 'none'; sandbox;",

    // Configure allowed external image domains here
    remotePatterns: [
      // Keep existing patterns if you still need them (e.g., for ucarecdn)
      {
        protocol: 'https',
        hostname: 'ucarecdn.com', // Google logo source
        port: '',
        pathname: '/**', // Allow any path on this host
      },

      // --- THIS IS THE NEW PATTERN YOU NEED TO ADD ---
      {
        protocol: 'https',                // Protocol used by the site (usually https)
        hostname: 'www.spcdavao.edu.ph',  // The specific domain name
        port: '',                         // Leave empty for default ports (80/443)
        pathname: '/wp-content/uploads/**', // Allow images specifically from the uploads path
                                          // Using '/**' would allow any path, '/wp-content/uploads/**' is slightly more specific/secure
      },
      // --- END OF NEW PATTERN ---

      // Add any other domains you might need here in the future
    ],
  },
  // Add other Next.js configurations here if you have them (e.g., reactStrictMode)
};

// Export the configuration object
export default nextConfig;


--- END FILE: next.config.ts ---

--- START FILE: package.json ---
{
  "name": "smls-sfms",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint"
  },
  "dependencies": {
    "@heroicons/react": "^2.2.0",
    "@next-auth/prisma-adapter": "^1.0.7",
    "@prisma/client": "^6.6.0",
    "bcrypt": "^5.1.1",
    "next": "15.3.1",
    "next-auth": "^4.24.11",
    "react": "^19.0.0",
    "react-dom": "^19.0.0",
    "uuid": "^11.1.0"
  },
  "devDependencies": {
    "@eslint/eslintrc": "^3",
    "@types/bcrypt": "^5.0.2",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "@types/uuid": "^10.0.0",
    "autoprefixer": "^10.4.21",
    "eslint": "^9",
    "eslint-config-next": "15.3.1",
    "postcss": "^8.5.3",
    "prisma": "^6.6.0",
    "tailwindcss": "^3.4.17",
    "typescript": "^5"
  }
}


--- END FILE: package.json ---

--- START FILE: postcss.config.mjs ---
// postcss.config.mjs (Using export default for ES Module compatibility)
const config = {
  plugins: {
    tailwindcss: {}, // For v3
    autoprefixer: {}, // For v3
  }
};
export default config; // Use export default


--- END FILE: postcss.config.mjs ---

--- START FILE: README.md ---
# SMLS-SFMS: Automated Skills and Faculty Management System


To develop an automated system for managing faculty CVs, skills, credentials, and documents for the School of Medical Laboratory Science (SMLS) at San Pedro College, replacing manual processes.

## TECHS USED

*   **Framework:** Next.js (App Router)
*   **Language:** TypeScript
*   **Styling:** Tailwind CSS (v3)
*   **Database:** SQLite (via Prisma)
*   **Authentication:** NextAuth.js (Credentials, Prisma Adapter)

##

## Current STATUS

*   Core project setup complete.
*   Authentication (Login, Roles, Route Protection) implemented.
*   Faculty profile page allows viewing data.
*   Edit mode for profile implemented with local state management.
*   Basic Add/Delete/Save (including file uploads/deletes for new items) functional for **Academic Qualifications** section via server actions and FormData.
*   Other sections and Admin features are under development.


--- END FILE: README.md ---

--- START FILE: tailwind.config.ts ---
// tailwind.config.ts (Should be okay for v3)
import type { Config } from 'tailwindcss'

const config: Config = {
  content: [
    './src/pages/**/*.{js,ts,jsx,tsx,mdx}',
    './src/components/**/*.{js,ts,jsx,tsx,mdx}',
    './src/app/**/*.{js,ts,jsx,tsx,mdx}',
  ],
  theme: {
    extend: {
      // Keep extensions minimal for now
    },
  },
  plugins: [],
}
export default config


--- END FILE: tailwind.config.ts ---

--- START FILE: tsconfig.json ---
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  "exclude": ["node_modules"]
}


--- END FILE: tsconfig.json ---

--- START FILE: prisma\schema.prisma ---
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Define the possible roles for users
enum Role {
  FACULTY
  ADMIN
}

// Define the User model
model User {
  id        String   @id @default(cuid()) // Unique ID for the user (using cuid)
  name      String?                       // User's name (optional for now)
  email     String   @unique                 // User's email, must be unique
  password  String                        // Hashed password (we will hash it before saving)
  role      Role     @default(FACULTY)     // User's role (defaults to FACULTY)
  createdAt DateTime @default(now())         // Timestamp when the user was created
  updatedAt DateTime @updatedAt            // Timestamp when the user was last updated

  // --- Relationships to CV Models (One User has Many...) ---
  academicQualifications AcademicQualification[]
  professionalLicenses   ProfessionalLicense[]
  workExperiences        WorkExperience[]
  professionalAffiliations ProfessionalAffiliation[]
  awardsRecognitions     AwardRecognition[]
  professionalDevelopments ProfessionalDevelopment[]
  communityInvolvements  CommunityInvolvement[]
  publications           Publication[]
  conferencePresentations ConferencePresentation[]
  // --- End Relationships ---
}

// --- CV Related Models ---

model AcademicQualification {
  id          String   @id @default(cuid())
  degree      String
  institution String
  program     String
  yearCompleted Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Supporting document field
  diplomaFileUrl String? // Optional field to store URL/path of uploaded diploma/transcript
}

model ProfessionalLicense {
  id          String   @id @default(cuid())
  examination String   // e.g., "Medical Technologist Licensure Examination"
  monthYear   String   // e.g., "August 2023"
  licenseNumber String @unique // License number should be unique
  expiration  DateTime // Date the license expires (REQUIRED)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relation to User
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // --- ADDED: Supporting document field ---
  licenseFileUrl String?
}

model WorkExperience {
  id         String   @id @default(cuid())
  institution String   // e.g., "San Pedro College", "Davao Doctors Hospital"
  position   String   // e.g., "Faculty", "Medical Technologist"
  natureOfWork String?  // Optional description
  inclusiveYears String // e.g., "2020-Present", "2018-2020"
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relation to User
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // --- ADDED: Supporting document field ---
  proofUrl String?
}

model ProfessionalAffiliation {
  id        String   @id @default(cuid())
  organization String // e.g., "PAMET", "PASMETH"
  position  String?  // Optional: "Member", "Officer", etc.
  inclusiveYears String // e.g., "2019-Present"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relation to User
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // --- ADDED: Supporting document field ---
  membershipProofUrl String?
}

model AwardRecognition {
  id             String   @id @default(cuid())
  awardName      String   // Name of the award/recognition
  awardingBody   String   // Organization/Institution that gave the award
  yearReceived   Int      // Year the award was received
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

   // Relation to User
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // --- ADDED: Supporting document field ---
  certificateUrl String?
}

model ProfessionalDevelopment {
  id          String   @id @default(cuid())
  title       String
  organizer   String
  dateLocation String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Supporting document field
  certificateFileUrl String? // Optional field to store URL/path of uploaded certificate
}

model CommunityInvolvement {
  id          String   @id @default(cuid())
  engagementTitle String // e.g., "Medical Mission Barangay X", "Blood Donation Drive"
  role        String   // e.g., "Volunteer", "Organizer"
  locationDate String  // e.g., "Barangay X / May 5, 2024"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

   // Relation to User
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // --- ADDED: Supporting document field ---
  proofUrl String?
}

// --- Research Related Models ---
model Publication {
  id            String   @id @default(cuid())
  researchTitle String
  journal       String   // Name of the journal
  datePublished DateTime // Date of publication
  doiLink       String?  // Optional: Link to DOI
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

   // Relation to User
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // --- ADDED: Supporting document field ---
  pdfUrl String? // Optional: URL/path to uploaded PDF copy
}

model ConferencePresentation {
  id            String   @id @default(cuid())
  paperTitle    String
  eventName     String   // Name of the conference/event
  dateLocation  String   // e.g., "June 2024 / Manila"
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relation to User
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // --- ADDED: Supporting document field ---
  proofUrl String? // Optional: URL/path to certificate/program page
}

// --- Add other models below as needed ---


--- END FILE: prisma\schema.prisma ---

--- START FILE: prisma\migrations\migration_lock.toml ---
# Please do not edit this file manually
# It should be added in your version-control system (e.g., Git)
provider = "sqlite"


--- END FILE: prisma\migrations\migration_lock.toml ---

--- START FILE: prisma\migrations\20250426170451_init_user_model\migration.sql ---
-- CreateTable
CREATE TABLE "User" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "name" TEXT,
    "email" TEXT NOT NULL,
    "password" TEXT NOT NULL,
    "role" TEXT NOT NULL DEFAULT 'FACULTY',
    "createdAt" DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" DATETIME NOT NULL
);

-- CreateIndex
CREATE UNIQUE INDEX "User_email_key" ON "User"("email");


--- END FILE: prisma\migrations\20250426170451_init_user_model\migration.sql ---

--- START FILE: prisma\migrations\20250427041822_add_cv_models\migration.sql ---
-- CreateTable
CREATE TABLE "AcademicQualification" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "degree" TEXT NOT NULL,
    "institution" TEXT NOT NULL,
    "program" TEXT NOT NULL,
    "yearCompleted" INTEGER NOT NULL,
    "createdAt" DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" DATETIME NOT NULL,
    "userId" TEXT NOT NULL,
    CONSTRAINT "AcademicQualification_userId_fkey" FOREIGN KEY ("userId") REFERENCES "User" ("id") ON DELETE CASCADE ON UPDATE CASCADE
);

-- CreateTable
CREATE TABLE "ProfessionalLicense" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "examination" TEXT NOT NULL,
    "monthYear" TEXT NOT NULL,
    "licenseNumber" TEXT NOT NULL,
    "expiration" DATETIME NOT NULL,
    "createdAt" DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" DATETIME NOT NULL,
    "userId" TEXT NOT NULL,
    CONSTRAINT "ProfessionalLicense_userId_fkey" FOREIGN KEY ("userId") REFERENCES "User" ("id") ON DELETE CASCADE ON UPDATE CASCADE
);

-- CreateTable
CREATE TABLE "WorkExperience" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "institution" TEXT NOT NULL,
    "position" TEXT NOT NULL,
    "natureOfWork" TEXT,
    "inclusiveYears" TEXT NOT NULL,
    "createdAt" DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" DATETIME NOT NULL,
    "userId" TEXT NOT NULL,
    CONSTRAINT "WorkExperience_userId_fkey" FOREIGN KEY ("userId") REFERENCES "User" ("id") ON DELETE CASCADE ON UPDATE CASCADE
);

-- CreateTable
CREATE TABLE "ProfessionalAffiliation" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "organization" TEXT NOT NULL,
    "position" TEXT,
    "inclusiveYears" TEXT NOT NULL,
    "createdAt" DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" DATETIME NOT NULL,
    "userId" TEXT NOT NULL,
    CONSTRAINT "ProfessionalAffiliation_userId_fkey" FOREIGN KEY ("userId") REFERENCES "User" ("id") ON DELETE CASCADE ON UPDATE CASCADE
);

-- CreateTable
CREATE TABLE "AwardRecognition" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "awardName" TEXT NOT NULL,
    "awardingBody" TEXT NOT NULL,
    "yearReceived" INTEGER NOT NULL,
    "createdAt" DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" DATETIME NOT NULL,
    "userId" TEXT NOT NULL,
    CONSTRAINT "AwardRecognition_userId_fkey" FOREIGN KEY ("userId") REFERENCES "User" ("id") ON DELETE CASCADE ON UPDATE CASCADE
);

-- CreateTable
CREATE TABLE "ProfessionalDevelopment" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "title" TEXT NOT NULL,
    "organizer" TEXT NOT NULL,
    "dateLocation" TEXT NOT NULL,
    "createdAt" DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" DATETIME NOT NULL,
    "userId" TEXT NOT NULL,
    CONSTRAINT "ProfessionalDevelopment_userId_fkey" FOREIGN KEY ("userId") REFERENCES "User" ("id") ON DELETE CASCADE ON UPDATE CASCADE
);

-- CreateTable
CREATE TABLE "CommunityInvolvement" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "engagementTitle" TEXT NOT NULL,
    "role" TEXT NOT NULL,
    "locationDate" TEXT NOT NULL,
    "createdAt" DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" DATETIME NOT NULL,
    "userId" TEXT NOT NULL,
    CONSTRAINT "CommunityInvolvement_userId_fkey" FOREIGN KEY ("userId") REFERENCES "User" ("id") ON DELETE CASCADE ON UPDATE CASCADE
);

-- CreateTable
CREATE TABLE "Publication" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "researchTitle" TEXT NOT NULL,
    "journal" TEXT NOT NULL,
    "datePublished" DATETIME NOT NULL,
    "createdAt" DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" DATETIME NOT NULL,
    "userId" TEXT NOT NULL,
    CONSTRAINT "Publication_userId_fkey" FOREIGN KEY ("userId") REFERENCES "User" ("id") ON DELETE CASCADE ON UPDATE CASCADE
);

-- CreateTable
CREATE TABLE "ConferencePresentation" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "paperTitle" TEXT NOT NULL,
    "eventName" TEXT NOT NULL,
    "dateLocation" TEXT NOT NULL,
    "createdAt" DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" DATETIME NOT NULL,
    "userId" TEXT NOT NULL,
    CONSTRAINT "ConferencePresentation_userId_fkey" FOREIGN KEY ("userId") REFERENCES "User" ("id") ON DELETE CASCADE ON UPDATE CASCADE
);

-- CreateIndex
CREATE UNIQUE INDEX "ProfessionalLicense_licenseNumber_key" ON "ProfessionalLicense"("licenseNumber");


--- END FILE: prisma\migrations\20250427041822_add_cv_models\migration.sql ---

--- START FILE: prisma\migrations\20250427044318_add_document_url_fields\migration.sql ---
-- AlterTable
ALTER TABLE "AcademicQualification" ADD COLUMN "diplomaFileUrl" TEXT;

-- AlterTable
ALTER TABLE "ProfessionalDevelopment" ADD COLUMN "certificateFileUrl" TEXT;


--- END FILE: prisma\migrations\20250427044318_add_document_url_fields\migration.sql ---

--- START FILE: prisma\migrations\20250427131008_add_document_urls_to_models\migration.sql ---
-- AlterTable
ALTER TABLE "AwardRecognition" ADD COLUMN "certificateUrl" TEXT;

-- AlterTable
ALTER TABLE "CommunityInvolvement" ADD COLUMN "proofUrl" TEXT;

-- AlterTable
ALTER TABLE "ConferencePresentation" ADD COLUMN "proofUrl" TEXT;

-- AlterTable
ALTER TABLE "ProfessionalAffiliation" ADD COLUMN "membershipProofUrl" TEXT;

-- AlterTable
ALTER TABLE "ProfessionalLicense" ADD COLUMN "licenseFileUrl" TEXT;

-- AlterTable
ALTER TABLE "Publication" ADD COLUMN "doiLink" TEXT;
ALTER TABLE "Publication" ADD COLUMN "pdfUrl" TEXT;

-- AlterTable
ALTER TABLE "WorkExperience" ADD COLUMN "proofUrl" TEXT;


--- END FILE: prisma\migrations\20250427131008_add_document_urls_to_models\migration.sql ---

--- START FILE: src\middleware.ts ---
// src/middleware.ts
import { withAuth } from "next-auth/middleware";
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';
import type { JWT } from "next-auth/jwt";

// Export the default middleware function configured with withAuth
export default withAuth(
    // `withAuth` augments your `Request` with the user's token.
    // This inner function runs ONLY if the user is authenticated (token exists).
    function middleware(req) {
        const token = req.nextauth.token as JWT & { role?: string }; // Token is guaranteed here
        const { pathname } = req.nextUrl;

        // --- NEW: Redirect authenticated users from homepage ---
        // If the user is authenticated (which they are if this function runs)
        // and they are trying to access the root path ('/'), redirect them.
        if (pathname === '/') {
            const userRole = token.role; // Get role from token
            // Determine target dashboard based on role
            const targetUrl = userRole === 'ADMIN' ? '/admin/dashboard' : '/dashboard';
            console.log(`Authenticated user on '/', redirecting to ${targetUrl}`);
            // Redirect to the appropriate dashboard
            return NextResponse.redirect(new URL(targetUrl, req.url));
        }
        // --- END NEW ---

        // --- Role-Based Access Control for /admin ---
        // If user is trying to access an admin route
        if (pathname.startsWith('/admin')) {
            // Check if the user has the ADMIN role
            if (token?.role !== 'ADMIN') {
                // If not admin, redirect them to the faculty dashboard
                console.warn(`Unauthorized access attempt to ${pathname} by user role: ${token?.role}`);
                 return NextResponse.redirect(new URL('/dashboard', req.url));
            }
            // If user is ADMIN and accessing /admin, allow the request
             return NextResponse.next();
        }

        // --- General Authenticated Access ---
        // For any other authenticated route covered by the matcher (like /dashboard, /profile)
        // allow the request to proceed.
        return NextResponse.next();
    },
    {
        callbacks: {
            // This callback ensures the middleware function above runs ONLY if a valid token exists.
            authorized: ({ token }) => !!token
        },
        pages: {
            // Redirect users to /login if they need to sign in (UNCHANGED)
            signIn: "/login",
        },
    }
);

// --- Route Matching ---
// Ensure this middleware runs on the homepage ('/') for authenticated users,
// as well as the protected routes. Exclude API, static files, images, favicon, and the login page itself.
export const config = {
    matcher: [
        /*
         * Match all request paths except for the ones starting with:
         * - api (API routes including /api/auth)
         * - _next/static (static files)
         * - _next/image (image optimization files)
         * - favicon.ico (favicon file)
         * - login (the login page itself)
         * The negative lookahead `(?!...)` correctly excludes these.
         * The pattern `.*` after the lookahead WILL match the root path '/'.
         */
        '/((?!api|_next/static|_next/image|favicon.ico|login).*)',

        // Explicitly adding '/' is not strictly necessary due to the pattern above,
        // but doesn't hurt for clarity if preferred.
        // '/',

        // Keep explicit protected paths if you prefer strictness, though the pattern covers them.
        '/dashboard/:path*',
        '/profile/:path*',
        '/documents/:path*',
        '/admin/:path*',
    ],
};


--- END FILE: src\middleware.ts ---

--- START FILE: src\app\globals.css ---
/* src/app/globals.css (Updated for v3) */
@tailwind base;
@tailwind components;
@tailwind utilities;

/* Add minimal body styling */
body {
   font-family: sans-serif; /* Basic default font */
   /* Add other base styles if needed */
}


--- END FILE: src\app\globals.css ---

--- START FILE: src\app\layout.tsx ---
// src/app/layout.tsx
import "./globals.css"; // Ensure this is imported EARLY
import type { Metadata } from "next";
import NextAuthProvider from "@/components/providers/NextAuthProvider";
// Removed font imports/setup

export const metadata: Metadata = {
  title: "SMLS-SFMS",
  description: "Skills and Faculty Management System",
};

export default function RootLayout({ children }: Readonly<{ children: React.ReactNode; }>) {
  return (
    <html lang="en">
      {/* Simple body tag, no custom font classes */}
      <body>
         <NextAuthProvider>
           <main>{children}</main>
         </NextAuthProvider>
      </body>
    </html>
  );
}


--- END FILE: src\app\layout.tsx ---

--- START FILE: src\app\page.tsx ---
// src/app/page.tsx
'use client'; // Needs to be a client component to use the hook

import React from 'react';
import { useSession, signIn, signOut } from 'next-auth/react';
import Link from 'next/link'; // Import Link

export default function HomePage() {
    // Use the useSession hook to get session data
    const { data: session, status } = useSession();

    // status can be 'loading', 'authenticated', or 'unauthenticated'

    return (
        <div className="p-6">
            <h1 className="text-2xl font-semibold mb-4 text-[#003153]">Welcome to SMLS-SFMS!</h1>

            {status === 'loading' && (
                <p className="text-gray-500">Loading session...</p>
            )}

            {status === 'authenticated' && session?.user && (
                <div className="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4" role="alert">
                    <p>Signed in as: <strong>{session.user.email}</strong></p>
                    {/* We added 'role' to the session in authOptions callbacks */}
                    <p>Role: <strong>{(session.user as any).role}</strong></p>
                    <button
                        onClick={() => signOut()} // Call signOut from next-auth/react
                        className="mt-2 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded shadow"
                    >
                        Sign Out
                    </button>
                </div>
            )}

            {status === 'unauthenticated' && (
                 <div className="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded relative mb-4" role="alert">
                    <p>You are not signed in.</p>
                    <Link href="/login"> {/* Use Link for client-side navigation */}
                       <button
                          className="mt-2 px-4 py-2 bg-[#003153] hover:bg-[#002742] text-white rounded shadow"
                       >
                           Sign In
                       </button>
                    </Link>
                 </div>
            )}

             <p className="mt-4">This is the homepage content.</p>
             {/* We can add links to other sections later */}

        </div>
    );
}


--- END FILE: src\app\page.tsx ---

--- START FILE: src\app\(auth)\layout.tsx ---
export const metadata = {
  title: 'Next.js',
  description: 'Generated by Next.js',
}

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="en">
      <body>{children}</body>
    </html>
  )
}


--- END FILE: src\app\(auth)\layout.tsx ---

--- START FILE: src\app\(auth)\login\page.tsx ---
'use client';
import React, { useState, FormEvent } from 'react';
import { signIn, getSession } from 'next-auth/react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import Image from 'next/image'; // Ensure next/image is imported

export default function LoginPage() {
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [error, setError] = useState<string | null>(null);
    const [isLoading, setIsLoading] = useState(false);
    const router = useRouter();

    // Handler for credential-based form submission (remains the same)
    const handleSubmit = async (event: FormEvent<HTMLFormElement>) => {
        // ... (submission logic remains the same)
        event.preventDefault();
        setError(null);
        setIsLoading(true);
        try {
            const result = await signIn('credentials', {
                redirect: false,
                email,
                password,
            });

            if (result?.error) {
                setIsLoading(false);
                setError("Invalid email or password. Please try again.");
                console.error("SignIn Error:", result.error);
            } else if (result?.ok) {
                const session = await getSession();
                const userRole = (session?.user as any)?.role;
                console.log("Login successful, Role:", userRole);
                router.push(userRole === 'ADMIN' ? '/admin/dashboard' : '/dashboard');
            } else {
                setIsLoading(false);
                setError("Login failed due to an unknown error. Please try again.");
                console.error("SignIn Unknown State:", result);
            }
        } catch (err) {
            setIsLoading(false);
            setError("An unexpected error occurred. Please check your connection and try again.");
            console.error("Login Catch Error:", err);
        }
    };

    // Placeholder handler for Google Sign-In button (remains the same)
    const handleGoogleSignIn = () => {
       alert("Google Sign-In is not configured yet.");
    }

    return (
        // Main container: Apply gradient background
        <div className="flex min-h-screen w-full items-center justify-center bg-gradient-to-br from-sky-100 to-blue-200 px-4 py-8 font-poppins">

            {/* Wrapper for the three-column layout on larger screens */}
            <div className="flex w-full max-w-6xl items-center justify-center lg:justify-between">

                 {/* Left Column (SPC Logo): Hidden on screens smaller than 'lg' */}
                 <div className="hidden lg:flex lg:w-1/4 items-center justify-center p-4">
                     <Image
                        src="/spc-logo.png"
                        alt="San Pedro College Logo"
                        width={250}
                        height={300}
                        className="object-contain"
                    />
                 </div>

                 {/* Center Column (Login Form Card) */}
                 <div className="w-full max-w-md lg:w-1/2 lg:max-w-md lg:px-8 flex justify-center">
                     {/* Container for the card */}
                     <div className="w-full">
                         {/* Gradient border effect - Using softer blues */}
                         <div className="rounded-3xl bg-gradient-to-r from-sky-400 to-blue-500 p-1 shadow-2xl"> {/* Changed gradient, increased shadow */}
                             {/* Inner white card - Kept white for contrast */}
                            <div className="rounded-[22px] bg-white p-8 sm:p-10">

                                <h1 className="cursor-default pb-6 text-center text-4xl font-bold text-gray-800"> {/* Slightly lighter text */}
                                    Log in
                                </h1>

                                <form onSubmit={handleSubmit} className="space-y-5">
                                    {error && (
                                        <div className="rounded border border-red-300 bg-red-50 p-3 text-center text-sm font-medium text-red-700" role="alert">
                                            {error}
                                        </div>
                                    )}
                                    {/* Email Input */}
                                    <div>
                                        <label htmlFor="email" className="mb-1.5 block text-sm font-medium text-gray-600">Email</label> {/* Lighter label */}
                                        <input
                                            id="email" name="email" type="email" placeholder="Email" required disabled={isLoading}
                                            value={email} onChange={(e) => setEmail(e.target.value)}
                                            className="w-full rounded-lg border border-gray-300 px-3 py-2.5 text-base text-gray-700 placeholder-gray-400 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500 disabled:opacity-50" // Adjusted text color
                                        />
                                    </div>
                                    {/* Password Input */}
                                    <div>
                                        <label htmlFor="password" className="mb-1.5 block text-sm font-medium text-gray-600">Password</label> {/* Lighter label */}
                                        <input
                                            id="password" name="password" type="password" placeholder="Password" required disabled={isLoading}
                                            value={password} onChange={(e) => setPassword(e.target.value)}
                                            className="w-full rounded-lg border border-gray-300 px-3 py-2.5 text-base text-gray-700 placeholder-gray-400 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500 disabled:opacity-50" // Adjusted text color
                                        />
                                    </div>
                                    {/* Forget Password Link - Adjusted color */}
                                    <div className="text-right">
                                        <Link href="#" className="text-sm text-sky-600 hover:text-sky-700 hover:underline"> Forget your password? </Link>
                                    </div>
                                    {/* Submit Button - Matching softer gradient */}
                                    <button
                                        type="submit" disabled={isLoading}
                                        className="mt-6 w-full rounded-lg bg-gradient-to-r from-sky-500 to-blue-600 px-4 py-2.5 text-sm font-semibold uppercase tracking-wider text-white shadow-md transition duration-300 ease-in-out hover:from-sky-600 hover:to-blue-700 disabled:opacity-60 disabled:cursor-not-allowed"> {/* Changed gradient and hover */}
                                        {isLoading ? 'LOGGING IN...' : 'LOG IN'}
                                    </button>
                                </form>
                                {/* Sign Up - Adjusted color */}
                               <div className="mt-5 text-center text-sm">
                                    <span className="text-gray-500">Don't have an account?{' '}</span> {/* Lighter text */}
                                    <Link href="#" className="font-semibold text-sky-600 hover:text-sky-700 hover:underline"> Sign Up </Link>
                               </div>
                                {/* Separator - Adjusted color */}
                               <div className="my-6 flex items-center">
                                    <hr className="flex-grow border-t border-gray-300" /> {/* Slightly darker line */}
                                    <span className="px-2 text-xs font-medium text-gray-500 uppercase">OR CONTINUE WITH</span> {/* Darker text */}
                                    <hr className="flex-grow border-t border-gray-300" />
                               </div>
                                {/* Google Button - Kept neutral */}
                               <div className="flex justify-center">
                                    <button
                                        onClick={handleGoogleSignIn} disabled={isLoading} title="Sign in with Google"
                                        className="m-1 inline-flex items-center justify-center rounded-lg border border-gray-300 bg-white p-2 shadow-sm transition duration-300 ease-in-out hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-gray-400 disabled:opacity-60">
                                        <Image src="https://ucarecdn.com/8f25a2ba-bdcf-4ff1-b596-088f330416ef/" alt="Google" width={22} height={22} />
                                    </button>
                               </div>
                                {/* Terms - Adjusted color and link color */}
                                <div className="mt-6 text-center text-xs text-gray-500"> {/* Lighter text */}
                                    <p> By signing in, you agree to our{' '} <Link className="font-medium text-sky-600 hover:underline" href="#">Terms</Link> {' '}and{' '} <Link className="font-medium text-sky-600 hover:underline" href="#">Privacy Policy</Link>. </p>
                                </div>
                            </div> {/* End Inner Card */}
                        </div> {/* End Gradient Border */}
                    </div> {/* End Form Container */}
                 </div> {/* End Center Column */}

                 {/* Right Column (SMLS Logo): Hidden on screens smaller than 'lg' */}
                 <div className="hidden lg:flex lg:w-1/4 items-center justify-center p-4 relative">
                     {/* ... optional background ... */}
                     <div className="relative z-10">
                        <Image
                            src="/smls-logo.png"
                            alt="School of Medical Laboratory Science Logo"
                            width={200}
                            height={200}
                            className="object-contain"
                        />
                     </div>
                 </div>

             </div> {/* End Three-column Wrapper */}

        </div> // End Main Container
    );
}


--- END FILE: src\app\(auth)\login\page.tsx ---

--- START FILE: src\app\(faculty)\dashboard\page.tsx ---
// src/app/(faculty)/dashboard/page.tsx
'use client';
import Link from 'next/link';
import React from 'react';
import { useSession } from 'next-auth/react';

// Example: Using Heroicons (install @heroicons/react)
// npm install @heroicons/react
import {
    UserCircleIcon,
    DocumentTextIcon,
    CalendarDaysIcon,
    ArrowRightIcon
} from '@heroicons/react/24/outline'; // Using outline style

export default function FacultyDashboardPage() {
    const { data: session, status } = useSession();

    // --- Loading State ---
    if (status === 'loading') {
        return (
            <div className="flex min-h-[calc(100vh-4rem)] items-center justify-center p-6 bg-gray-50"> {/* Added bg */}
                {/* Basic Spinner Example */}
                <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                <p className="ml-3 text-gray-600">Loading dashboard...</p>
            </div>
        );
    }

    // --- Unauthenticated State ---
    if (status === 'unauthenticated') {
         return (
             <div className="flex h-screen flex-col items-center justify-center p-6 text-center bg-gray-50">
                 <p className="mb-4 text-xl font-semibold text-red-600">Access Denied</p>
                 <p className="mb-6 text-gray-700">You must be signed in to view this page.</p>
                 <Link href="/login">
                     <button className="inline-flex items-center gap-2 rounded-md bg-[#003153] px-5 py-2.5 text-sm font-medium text-white shadow-sm transition hover:bg-[#002742] focus:outline-none focus:ring-2 focus:ring-[#003153] focus:ring-offset-2">
                         Go to Login
                         <ArrowRightIcon className="h-4 w-4" />
                     </button>
                 </Link>
             </div>
        );
    }

    // --- Authenticated State ---
    const userRole = (session?.user as any)?.role;
    // More friendly greeting
    const greetingName = session?.user?.name ? session.user.name.split(' ')[0] : (session?.user?.email ?? 'Faculty Member');

    return (
        // Main container with background and padding
        <div className="min-h-[calc(100vh-4rem)] bg-gradient-to-br from-gray-50 to-blue-50 p-4 sm:p-6 lg:p-8">
            <div className="mx-auto max-w-7xl">
                {/* Header Section */}
                <div className="mb-8 rounded-lg bg-white p-6 shadow-sm">
                    <h1 className="text-2xl font-semibold leading-tight text-gray-800 sm:text-3xl">
                        Welcome back, {greetingName}!
                    </h1>
                    <p className="mt-1 text-sm text-gray-500">
                        Your central hub for managing skills and documents. (Role: {userRole || 'N/A'})
                    </p>
                </div>

                {/* Main Content Grid - More spacing */}
                <div className="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3">

                    {/* Profile Card - Refined styling */}
                    <Link href="/profile" className="group flex flex-col justify-between rounded-lg border border-transparent bg-white p-6 shadow-lg transition duration-300 ease-in-out hover:scale-[1.02] hover:shadow-blue-100 dark:bg-gray-800 dark:hover:shadow-blue-900/30">
                        <div>
                            <div className="mb-3 flex items-center gap-3">
                                <UserCircleIcon className="h-8 w-8 text-blue-600 dark:text-blue-400" />
                                <h2 className="text-xl font-semibold text-gray-800 dark:text-gray-100">
                                    My Profile
                                </h2>
                            </div>
                            <p className="text-sm text-gray-600 dark:text-gray-400">
                                View and manage your CV, qualifications, and personal details.
                            </p>
                        </div>
                        <div className="mt-4 flex items-center justify-end text-sm font-medium text-blue-600 dark:text-blue-400 group-hover:underline">
                            Go to Profile
                            <ArrowRightIcon className="ml-1 h-4 w-4 transition-transform duration-200 group-hover:translate-x-1" />
                        </div>
                    </Link>

                    {/* Documents Card - Refined styling */}
                     <Link href="/documents" className="group flex flex-col justify-between rounded-lg border border-transparent bg-white p-6 shadow-lg transition duration-300 ease-in-out hover:scale-[1.02] hover:shadow-green-100 dark:bg-gray-800 dark:hover:shadow-green-900/30">
                        <div>
                            <div className="mb-3 flex items-center gap-3">
                                <DocumentTextIcon className="h-8 w-8 text-green-600 dark:text-green-400" />
                                <h2 className="text-xl font-semibold text-gray-800 dark:text-gray-100">
                                    My Documents
                                </h2>
                            </div>
                            <p className="text-sm text-gray-600 dark:text-gray-400">
                                Upload, view, and manage your supporting credentials and files.
                            </p>
                        </div>
                        <div className="mt-4 flex items-center justify-end text-sm font-medium text-green-600 dark:text-green-400 group-hover:underline">
                            Manage Documents
                            <ArrowRightIcon className="ml-1 h-4 w-4 transition-transform duration-200 group-hover:translate-x-1" />
                        </div>
                     </Link>

                    {/* Upcoming Events Card - Refined styling */}
                     <div className="flex flex-col justify-between rounded-lg border border-transparent bg-white p-6 shadow-lg dark:bg-gray-800">
                        <div>
                            <div className="mb-3 flex items-center gap-3">
                                <CalendarDaysIcon className="h-8 w-8 text-purple-600 dark:text-purple-400" />
                                <h2 className="text-xl font-semibold text-gray-800 dark:text-gray-100">
                                    Upcoming Events
                                </h2>
                            </div>
                            <p className="text-sm text-gray-600 dark:text-gray-400">
                                View relevant seminars, deadlines, or faculty meetings.
                            </p>
                        </div>
                         <div className="mt-4 rounded-md border border-dashed border-gray-300 bg-gray-50 p-4 text-center text-sm italic text-gray-500 dark:border-gray-700 dark:bg-gray-700/50 dark:text-gray-400">
                             No upcoming events scheduled.
                         </div>
                    </div>

                     {/* Add more cards here following a similar pattern */}

                </div>
            </div>
        </div>
    );
}


--- END FILE: src\app\(faculty)\dashboard\page.tsx ---

--- START FILE: src\app\(faculty)\documents\page.tsx ---
// src/app/(faculty)/documents/page.tsx
'use client';

import React from 'react';
import { useSession } from 'next-auth/react';

// We might need specific types for document data later
// import type { DocumentData } from '@/types';

export default function DocumentsPage() {
    const { data: session, status } = useSession();

    if (status === 'loading') {
        return <div className="p-6">Loading documents page...</div>;
    }

    if (status === 'unauthenticated') {
        return <div className="p-6">Access Denied. Please sign in.</div>;
    }

    // Placeholder state for file handling (will expand later)
    // const [selectedFile, setSelectedFile] = useState<File | null>(null);
    // const [uploading, setUploading] = useState(false);
    // const [documents, setDocuments] = useState<DocumentData[]>([]); // To display existing docs

    // Placeholder function for upload logic
    const handleUpload = async (event: React.FormEvent) => {
        event.preventDefault();
        // TODO: Implement actual file upload logic
        // - Get file from state
        // - Validate file type/size
        // - Send file to a backend API route or Server Action
        // - Handle response (success/error)
        // - Update the list of documents
        alert('Upload functionality not implemented yet.');
    };

    return (
        <div className="p-6">
            <h1 className="mb-6 text-2xl font-semibold text-[#003153]">
                My Documents & Credentials
            </h1>

            {/* Section for Uploading New Documents */}
            <div className="mb-8 rounded border border-gray-200 bg-white p-6 shadow-md">
                <h2 className="mb-4 text-lg font-medium text-gray-800">Upload New Document</h2>
                <form onSubmit={handleUpload}>
                    <div className="mb-4">
                        <label htmlFor="documentFile" className="mb-2 block text-sm font-medium text-gray-700">
                            Select File (.pdf, .png, .jpg)
                        </label>
                        <input
                            type="file"
                            id="documentFile"
                            name="documentFile"
                            accept=".pdf,.png,.jpg,.jpeg" // Specify accepted formats
                            className="block w-full text-sm text-gray-500 file:mr-4 file:rounded file:border-0 file:bg-[#003153] file:px-4 file:py-2 file:text-white hover:file:bg-[#002742] disabled:opacity-50"
                            // onChange={(e) => setSelectedFile(e.target.files ? e.target.files[0] : null)}
                            required
                            disabled // Disable upload for now
                        />
                         {/* TODO: Add fields for document type/category (e.g., Academic, Seminar, Award) */}
                    </div>
                    <button
                        type="submit"
                        className="rounded bg-[#003153] px-4 py-2 text-white shadow hover:bg-[#002742] focus:outline-none focus:ring-2 focus:ring-[#003153] focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
                        disabled // Disable upload for now
                        // disabled={!selectedFile || uploading}
                    >
                        {/* {uploading ? 'Uploading...' : 'Upload Document'} */}
                        Upload Document (Coming Soon)
                    </button>
                </form>
            </div>

            {/* Section for Displaying Existing Documents */}
            <div className="rounded border border-gray-200 bg-white p-6 shadow-md">
                <h2 className="mb-4 text-lg font-medium text-gray-800">Uploaded Documents</h2>
                {/* TODO: Fetch and display list of user's documents */}
                <p className="text-gray-500">Your uploaded documents will appear here.</p>
                 {/* Example structure for later:
                 <ul className="space-y-2">
                    {documents.map((doc) => (
                        <li key={doc.id} className="flex justify-between items-center border-b pb-1">
                            <span>{doc.fileName} ({doc.category})</span>
                            <button className="text-red-500 hover:text-red-700 text-sm">Delete</button>
                        </li>
                    ))}
                </ul>
                */}
            </div>
        </div>
    );
}


--- END FILE: src\app\(faculty)\documents\page.tsx ---

--- START FILE: src\app\(faculty)\profile\page.tsx ---
// src/app/(faculty)/profile/page.tsx
'use client';

import React, { useState, useEffect, useCallback, useTransition, ChangeEvent } from 'react';
import { useSession } from 'next-auth/react';
import { getMyProfileData, updateMyProfile } from '@/lib/userActions';
// Import ALL relevant types from Prisma Client
import type {
    User, AcademicQualification, ProfessionalLicense, WorkExperience,
    ProfessionalAffiliation, AwardRecognition, ProfessionalDevelopment,
    CommunityInvolvement, Publication, ConferencePresentation
} from '@/generated/prisma';
// Import shared temporary types and Union type
import type {
    EditableItem, TempAcademicQualification, TempProfessionalDevelopment,
    TempProfessionalLicense, TempWorkExperience, TempProfessionalAffiliation,
    TempAwardRecognition, TempCommunityInvolvement, TempPublication, TempConferencePresentation
} from '@/types';
import {
    PlusIcon, PencilSquareIcon, XCircleIcon, CheckCircleIcon, AcademicCapIcon, BriefcaseIcon,
    IdentificationIcon, StarIcon, SparklesIcon, UsersIcon, DocumentTextIcon, PresentationChartBarIcon, TrashIcon, PencilIcon, PaperClipIcon,
    CheckIcon, XMarkIcon
} from '@heroicons/react/24/outline';
import { v4 as uuidv4 } from 'uuid';

// --- Import ACTUAL and PLACEHOLDER components ---
import AcademicQualificationDisplay from '@/components/profile/AcademicQualificationDisplay';
import AcademicQualificationForm from '@/components/profile/AcademicQualificationForm';
import ProfessionalDevelopmentDisplay from '@/components/profile/ProfessionalDevelopmentDisplay';
import ProfessionalDevelopmentForm from '@/components/profile/ProfessionalDevelopmentForm';
import ProfessionalLicenseDisplay from '@/components/profile/ProfessionalLicenseDisplay';
import ProfessionalLicenseForm from '@/components/profile/ProfessionalLicenseForm';
import WorkExperienceDisplay from '@/components/profile/WorkExperienceDisplay';
import WorkExperienceForm from '@/components/profile/WorkExperienceForm';
import ProfessionalAffiliationDisplay from '@/components/profile/ProfessionalAffiliationDisplay'; // Ensure this file exists
import ProfessionalAffiliationForm from '@/components/profile/ProfessionalAffiliationForm';       // Ensure this file exists
import AwardRecognitionDisplay from '@/components/profile/AwardRecognitionDisplay';
import AwardRecognitionForm from '@/components/profile/AwardRecognitionForm';
import CommunityInvolvementDisplay from '@/components/profile/CommunityInvolvementDisplay';
import CommunityInvolvementForm from '@/components/profile/CommunityInvolvementForm';
import PublicationDisplay from '@/components/profile/PublicationDisplay';
import PublicationForm from '@/components/profile/PublicationForm';
import ConferencePresentationDisplay from '@/components/profile/ConferencePresentationDisplay';
import ConferencePresentationForm from '@/components/profile/ConferencePresentationForm';


// --- Interfaces & Metadata ---
interface ProfileData { user: { id: string; name: string | null; email: string | null; role: string | null; } | null; academicQualifications: AcademicQualification[]; professionalLicenses: ProfessionalLicense[]; workExperiences: WorkExperience[]; professionalAffiliations: ProfessionalAffiliation[]; awardsRecognitions: AwardRecognition[]; professionalDevelopments: ProfessionalDevelopment[]; communityInvolvements: CommunityInvolvement[]; publications: Publication[]; conferencePresentations: ConferencePresentation[]; error?: string; }
const categoryMetadata = { academicQualifications: { title: 'Academic Qualifications', icon: AcademicCapIcon }, professionalLicenses: { title: 'Professional Licenses', icon: IdentificationIcon }, workExperiences: { title: 'Work Experience', icon: BriefcaseIcon }, professionalAffiliations: { title: 'Professional Affiliations', icon: UsersIcon }, awardsRecognitions: { title: 'Awards & Recognitions', icon: StarIcon }, professionalDevelopments: { title: 'Professional Development', icon: SparklesIcon }, communityInvolvements: { title: 'Community Involvement', icon: UsersIcon }, publications: { title: 'Publications', icon: DocumentTextIcon }, conferencePresentations: { title: 'Conference Presentations', icon: PresentationChartBarIcon }, } as const;
type CategoryKey = keyof typeof categoryMetadata;
type EditableProfileData = Omit<ProfileData, 'user' | 'error'>;

// --- Helper Functions ---
const formatDate = (date: string | Date | null | undefined): string => { if (!date) return 'N/A'; try { return new Date(date).toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' }); } catch (e) { console.error("Error formatting date:", date, e); return 'Invalid Date'; } };
const formatDateForInput = (date: string | Date | null | undefined): string => { if (!date) return ''; try { const d = new Date(date); if (isNaN(d.getTime())) return ''; return d.toISOString().split('T')[0]; } catch (e) { console.error("Error formatting date for input:", date, e); return ''; } };

// --- Main Component ---
export default function ProfilePage() {
    const { status: sessionStatus } = useSession();
    const [profileData, setProfileData] = useState<ProfileData | null>(null);
    const [isLoading, setIsLoading] = useState(true);
    const [pageError, setPageError] = useState<string | null>(null);
    const [isEditing, setIsEditing] = useState(false);
    const [isPending, startTransition] = useTransition();
    const [editError, setEditError] = useState<string | null>(null);
    const [editSuccess, setEditSuccess] = useState<string | null>(null);
    const [editableData, setEditableData] = useState<EditableProfileData | null>(null);
    const [visibleCategories, setVisibleCategories] = useState<Set<CategoryKey>>(new Set());
    const [showCategoryDropdown, setShowCategoryDropdown] = useState(false);
    const [editingItemId, setEditingItemId] = useState<string | null>(null);
    const [originalItemData, setOriginalItemData] = useState<EditableItem | null>(null);

    // --- Fetch data ---
    const fetchProfileData = useCallback(async (showLoading = true) => { if (showLoading) setIsLoading(true); setPageError(null); setEditError(null); setEditSuccess(null); try { const data = await getMyProfileData(); if (data.error) { setPageError(data.error); setProfileData(null); setVisibleCategories(new Set()); } else { setProfileData(data); const initialVisible = new Set<CategoryKey>(); (Object.keys(categoryMetadata) as CategoryKey[]).forEach(key => { if (data[key] && Array.isArray(data[key]) && data[key].length > 0) { initialVisible.add(key); } }); setVisibleCategories(initialVisible); setIsEditing(false); setEditableData(null); setEditingItemId(null); setOriginalItemData(null); } } catch (err) { console.error("Failed fetch:", err); setPageError("Unexpected fetch error."); setProfileData(null); setVisibleCategories(new Set()); } finally { if (showLoading) setIsLoading(false); } }, []);
    useEffect(() => { if (sessionStatus === 'authenticated') { if (!profileData && isLoading) { fetchProfileData(); } else if (profileData && isLoading) { setIsLoading(false); } } else if (sessionStatus === 'unauthenticated') { setIsLoading(false); setPageError("Access Denied."); setProfileData(null); setVisibleCategories(new Set()); } else { setIsLoading(true); } }, [sessionStatus, profileData, isLoading, fetchProfileData]);

    // --- Edit Mode Toggles ---
    const handleEditToggle = () => { if (isEditing) { handleCancelEdit(); } else { if (!profileData || !profileData.user) { setPageError("Cannot enter edit mode."); return; } setIsEditing(true); setEditError(null); setEditSuccess(null); const dataToEdit: EditableProfileData = { academicQualifications: structuredClone(profileData.academicQualifications), professionalLicenses: structuredClone(profileData.professionalLicenses), workExperiences: structuredClone(profileData.workExperiences), professionalAffiliations: structuredClone(profileData.professionalAffiliations), awardsRecognitions: structuredClone(profileData.awardsRecognitions), professionalDevelopments: structuredClone(profileData.professionalDevelopments), communityInvolvements: structuredClone(profileData.communityInvolvements), publications: structuredClone(profileData.publications), conferencePresentations: structuredClone(profileData.conferencePresentations), }; setEditableData(dataToEdit); const categoriesToMakeVisible = new Set(visibleCategories); (Object.keys(dataToEdit) as CategoryKey[]).forEach(key => { if (dataToEdit[key]?.length > 0) { categoriesToMakeVisible.add(key); } }); setVisibleCategories(categoriesToMakeVisible); setEditingItemId(null); setOriginalItemData(null); } };
    const handleCancelEdit = () => { setIsEditing(false); setEditableData(null); setEditingItemId(null); setOriginalItemData(null); setEditError(null); setEditSuccess(null); };

    // --- Save Changes ---
    const handleSaveChanges = () => {
        if (!editableData) { setEditError("No changes to save."); return; }
        setEditError(null); setEditSuccess(null);
        startTransition(async () => {
            try {
                const formData = new FormData();
                const categoriesWithFiles: CategoryKey[] = [
                    'academicQualifications', 'professionalDevelopments', 'professionalLicenses',
                    'workExperiences', 'professionalAffiliations', 'awardsRecognitions',
                    'communityInvolvements', 'publications', 'conferencePresentations'
                ];

                (Object.keys(categoryMetadata) as CategoryKey[]).forEach(categoryKey => {
                    const categoryData = editableData[categoryKey] as EditableItem[] | undefined;
                    if (categoryData) {
                        const dataToSend = categoryData.map(item => {
                            const { _selectedFile, ...rest } = item as any;
                            const finalRest = { ...rest };
                            if (item._isNew) { finalRest._isNew = true; }
                            const cleanedRest: { [key: string]: any } = {};
                            for (const key in finalRest) {
                                const value = finalRest[key];
                                if (value instanceof Date) { cleanedRest[key] = !isNaN(value.getTime()) ? value.toISOString() : null; }
                                else { cleanedRest[key] = value; }
                            }
                            return cleanedRest;
                        });
                        formData.append(`${categoryKey}_json`, JSON.stringify(dataToSend));

                        if (categoriesWithFiles.includes(categoryKey)) {
                            categoryData.forEach((item) => {
                                if (item && '_selectedFile' in item && item._selectedFile && (item._isNew || editingItemId === item.id)) {
                                    formData.append(`${categoryKey}_file_${item.id}`, item._selectedFile);
                                }
                            });
                        }
                    }
                });

                const result = await updateMyProfile(formData);
                if (result.success) { setEditSuccess("Profile updated!"); setIsEditing(false); setEditableData(null); setEditingItemId(null); setOriginalItemData(null); await fetchProfileData(false); }
                else { setEditError(result.error || "Failed to save."); }
            } catch (err: any) { console.error("Save error:", err); setEditError(err.message || "Unexpected save error."); }
        });
    };

    const handleAddCategory = (categoryKey: CategoryKey) => { setVisibleCategories(prev => new Set(prev).add(categoryKey)); setShowCategoryDropdown(false); };
    const handleDeleteItemLocally = (category: CategoryKey, id: string) => { if (!editableData) return; setEditableData(prevData => { if (!prevData || !Array.isArray(prevData[category])) return prevData; const updatedEditableData = { ...prevData }; updatedEditableData[category] = (updatedEditableData[category] as any[]).filter(item => item.id !== id); return updatedEditableData; }); if (editingItemId === id) { setEditingItemId(null); setOriginalItemData(null); } };

    // --- Local Add ---
    const handleAddItemLocally = (category: CategoryKey) => {
        if (!editableData || !profileData?.user?.id) return;
        const newEditableData = { ...editableData }; const newItemId = uuidv4(); let placeholderItem: EditableItem;
        const now = new Date(); const currentUserId = profileData.user.id; const nextYear = new Date(now); nextYear.setFullYear(nextYear.getFullYear() + 1);
        switch (category) {
            case 'academicQualifications': placeholderItem = { id: newItemId, degree: '', institution: '', program: '', yearCompleted: now.getFullYear(), diplomaFileUrl: null, userId: currentUserId, createdAt: now, updatedAt: now, _isNew: true, _selectedFile: null } as TempAcademicQualification; break;
            case 'professionalLicenses': placeholderItem = { id: newItemId, examination: '', monthYear: '', licenseNumber: '', expiration: nextYear, licenseFileUrl: null, userId: currentUserId, createdAt: now, updatedAt: now, _isNew: true, _selectedFile: null } as TempProfessionalLicense; break;
            case 'workExperiences': placeholderItem = { id: newItemId, institution: '', position: '', natureOfWork: null, inclusiveYears: '', proofUrl: null, userId: currentUserId, createdAt: now, updatedAt: now, _isNew: true, _selectedFile: null } as TempWorkExperience; break;
            case 'professionalAffiliations': placeholderItem = { id: newItemId, organization: '', position: null, inclusiveYears: '', membershipProofUrl: null, userId: currentUserId, createdAt: now, updatedAt: now, _isNew: true, _selectedFile: null } as TempProfessionalAffiliation; break;
            case 'awardsRecognitions': placeholderItem = { id: newItemId, awardName: '', awardingBody: '', yearReceived: now.getFullYear(), certificateUrl: null, userId: currentUserId, createdAt: now, updatedAt: now, _isNew: true, _selectedFile: null } as TempAwardRecognition; break;
            case 'professionalDevelopments': placeholderItem = { id: newItemId, title: '', organizer: '', dateLocation: '', certificateFileUrl: null, userId: currentUserId, createdAt: now, updatedAt: now, _isNew: true, _selectedFile: null } as TempProfessionalDevelopment; break;
            case 'communityInvolvements': placeholderItem = { id: newItemId, engagementTitle: '', role: '', locationDate: '', proofUrl: null, userId: currentUserId, createdAt: now, updatedAt: now, _isNew: true, _selectedFile: null } as TempCommunityInvolvement; break;
            case 'publications': placeholderItem = { id: newItemId, researchTitle: '', journal: '', datePublished: now, doiLink: null, pdfUrl: null, userId: currentUserId, createdAt: now, updatedAt: now, _isNew: true, _selectedFile: null } as TempPublication; break;
            case 'conferencePresentations': placeholderItem = { id: newItemId, paperTitle: '', eventName: '', dateLocation: '', proofUrl: null, userId: currentUserId, createdAt: now, updatedAt: now, _isNew: true, _selectedFile: null } as TempConferencePresentation; break;
            default: console.error(`Add handler not implemented for: ${category}`); return;
        }
        if (!Array.isArray(newEditableData[category])) { newEditableData[category] = []; }
        (newEditableData[category] as EditableItem[]) = [placeholderItem, ...(newEditableData[category] as EditableItem[])];
        setEditableData(newEditableData); handleStartEditingItem(category, newItemId);
    };

    // --- Input Change ---
    const handleInputChange = (category: CategoryKey, itemId: string, fieldName: string, value: string | number | Date | null) => { if (!editableData) return; setEditableData(prevData => { if (!prevData || !prevData[category]) return prevData; const updatedCategoryData = structuredClone(prevData[category]) as any[]; const itemIndex = updatedCategoryData.findIndex(item => item.id === itemId); if (itemIndex === -1) { console.warn(`Item ${itemId} not found in ${category}`); return prevData; } const numericFields = ['yearCompleted', 'yearReceived']; let finalValue = value; if (typeof value === 'string' && value.trim() === '') { const requiredFields: { [key: string]: string[] } = { professionalLicenses: ['examination', 'licenseNumber', 'monthYear', 'expiration'], academicQualifications: ['degree', 'institution', 'program', 'yearCompleted'], /* ... other required fields ... */ }; if (!requiredFields[category]?.includes(fieldName)) { finalValue = null; } } else if (numericFields.includes(fieldName)) { finalValue = typeof value === 'string' ? parseInt(value, 10) : value; if (isNaN(finalValue as number)) finalValue = null; } updatedCategoryData[itemIndex] = { ...updatedCategoryData[itemIndex], [fieldName]: finalValue, updatedAt: new Date() }; return { ...prevData, [category]: updatedCategoryData }; }); };

    // --- File Change ---
    const handleFileChange = (category: CategoryKey, itemId: string, file: File | null | undefined) => { const categoriesWithFiles: CategoryKey[] = [ 'academicQualifications', 'professionalDevelopments', 'professionalLicenses', 'workExperiences', 'professionalAffiliations', 'awardsRecognitions', 'communityInvolvements', 'publications', 'conferencePresentations' ]; if (!categoriesWithFiles.includes(category)) { console.warn(`File change not supported for: ${category}`); return; } if (!editableData || !editableData[category]) { console.warn(`Cannot handle file change: Category ${category} not found`); return; } const MAX_FILE_SIZE = 5 * 1024 * 1024; const ALLOWED_TYPES = ['application/pdf', 'image/png', 'image/jpeg', 'image/jpg']; if (file && file.size > MAX_FILE_SIZE) { alert(`File size exceeds limit.`); return; } if (file && !ALLOWED_TYPES.includes(file.type)) { alert('Invalid file type.'); return; } setEditableData(prevData => { if (!prevData) return null; const updatedCategoryData = structuredClone(prevData[category]) as EditableItem[]; const itemIndex = updatedCategoryData.findIndex(item => item.id === itemId); if (itemIndex === -1) return prevData; const currentItem = updatedCategoryData[itemIndex]; if (currentItem && '_selectedFile' in currentItem) { updatedCategoryData[itemIndex] = { ...currentItem, _selectedFile: file ?? null, updatedAt: new Date() }; } else if (file) { console.warn(`Attempted file assign for category ${category} w/o _selectedFile`); updatedCategoryData[itemIndex] = { ...currentItem, updatedAt: new Date() }; } else { updatedCategoryData[itemIndex] = { ...currentItem, updatedAt: new Date() }; } return { ...prevData, [category]: updatedCategoryData }; }); };

    // --- Inline Item Edit Handlers ---
    const handleStartEditingItem = (category: CategoryKey, itemId: string) => { if (!editableData || !editableData[category]) return; const itemToEdit = (editableData[category] as EditableItem[]).find(item => item.id === itemId); if (itemToEdit) { setOriginalItemData(structuredClone(itemToEdit)); setEditingItemId(itemId); setEditError(null); } else { console.error("Item not found:", itemId); } };
    const handleCancelItemEdit = (category: CategoryKey, itemId: string) => { if (!editableData || !originalItemData || originalItemData.id !== itemId || !editableData[category]) { setEditingItemId(null); setOriginalItemData(null); return; }; setEditableData(prevData => { if (!prevData) return null; const updatedCategoryData = structuredClone(prevData[category]) as EditableItem[]; const itemIndex = updatedCategoryData.findIndex(item => item.id === itemId); if (itemIndex !== -1) { updatedCategoryData[itemIndex] = originalItemData; } return { ...prevData, [category]: updatedCategoryData }; }); setEditingItemId(null); setOriginalItemData(null); };
    const handleSaveEditedItem = (itemId: string) => { setEditingItemId(null); setOriginalItemData(null); };

    // --- Render ---
    if (isLoading || sessionStatus === 'loading') { return <div className="p-6 animate-pulse">Loading profile...</div>; }
    if (pageError || sessionStatus === 'unauthenticated' || !profileData || !profileData.user) { return <div className="p-6 text-red-600">Error: {pageError || "Could not load profile data or access denied."}</div>; }

    const dataToDisplay = isEditing ? editableData : profileData;
    const finalData = (isEditing && dataToDisplay) ? dataToDisplay : profileData;

    return (
        <div className="p-6 bg-gray-50 min-h-screen">
            {/* Header, Messages, Basic Info */}
             <div className="mb-6 flex flex-wrap items-center justify-between gap-4 border-b border-gray-200 pb-4"> <h1 className="text-3xl font-bold text-gray-800">My Profile</h1> <div className="flex items-center gap-2 flex-wrap"> <button onClick={handleEditToggle} disabled={isPending} className={`inline-flex items-center gap-1.5 rounded-md px-3 py-1.5 text-sm font-medium text-white shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 disabled:opacity-70 ${isEditing ? 'bg-gray-600 hover:bg-gray-700 focus:ring-gray-500' : 'bg-blue-600 hover:bg-blue-700 focus:ring-blue-600'}`}> {isEditing ? <><XCircleIcon className="h-4 w-4" /> Cancel</> : <><PencilSquareIcon className="h-4 w-4" /> Edit Profile</>} </button> {isEditing && (<button onClick={handleSaveChanges} disabled={isPending || editingItemId !== null} className="inline-flex items-center gap-1.5 rounded-md bg-green-600 px-3 py-1.5 text-sm font-medium text-white shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 disabled:opacity-70"> {isPending ? ('Saving...') : (<><CheckCircleIcon className="h-4 w-4" /> Save Changes</>)} </button>)} <div className="relative"> <button onClick={() => setShowCategoryDropdown(!showCategoryDropdown)} disabled={isPending || isEditing} className="inline-flex items-center gap-1 rounded-md bg-indigo-600 px-3 py-1.5 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 disabled:opacity-70" aria-haspopup="true" aria-expanded={showCategoryDropdown}> <PlusIcon className="h-4 w-4" /> Add Section </button> {showCategoryDropdown && ( <div className="absolute right-0 z-10 mt-2 w-56 origin-top-right rounded-md bg-white shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none" role="menu"> <div className="py-1" role="none"> {(Object.keys(categoryMetadata) as CategoryKey[]).filter(key => !visibleCategories.has(key)).length > 0 ? ((Object.keys(categoryMetadata) as CategoryKey[]).filter(key => !visibleCategories.has(key)).map(key => ( <button key={key} onClick={() => handleAddCategory(key)} className="block w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100" role="menuitem"> {categoryMetadata[key].title} </button> ))) : ( <p className="px-4 py-2 text-sm text-gray-500">All sections added.</p> )} </div> </div> )} </div> </div> {isEditing && editingItemId !== null && ( <p className="mt-2 text-sm text-yellow-700 bg-yellow-50 p-2 rounded border border-yellow-200 w-full text-center"> Finish editing the current item (<CheckIcon className='inline h-4 w-4 text-blue-600'/> <XMarkIcon className='inline h-4 w-4 text-gray-600'/>) before saving all profile changes. </p> )} </div>
             {editSuccess && <div className="mb-4 rounded-md bg-green-50 p-4 text-sm font-medium text-green-800">{editSuccess}</div>} {editError && <div className="mb-4 rounded-md bg-red-50 p-4 text-sm font-medium text-red-800">{editError}</div>} {pageError && !editError && <div className="mb-4 rounded-md bg-red-50 p-4 text-sm font-medium text-red-800">{pageError}</div>}
             <div className="mb-8 rounded-lg border border-gray-200 bg-white p-6 shadow-md"> <h2 className="mb-4 text-xl font-semibold text-gray-700">Basic Information</h2> <div className="grid grid-cols-1 gap-x-4 gap-y-2 text-sm sm:grid-cols-2"> <div><span className="font-medium text-gray-500">Name:</span> {profileData.user.name ?? 'N/A'}</div> <div><span className="font-medium text-gray-500">Email:</span> {profileData.user.email ?? 'N/A'}</div> <div><span className="font-medium text-gray-500">Role:</span> {profileData.user.role ?? 'N/A'}</div> </div> </div>

            {/* Dynamic Sections */}
            {visibleCategories.size === 0 && !isLoading && ( <div className="rounded-lg border-2 border-dashed border-gray-300 bg-gray-100 p-6 text-center text-gray-500"> No profile sections added yet... </div> )}
            <div className="grid grid-cols-1 gap-6 md:grid-cols-2 xl:grid-cols-3">
                {Array.from(visibleCategories).map(categoryKey => {
                    const categoryMeta = categoryMetadata[categoryKey];
                    const categoryData = (finalData?.[categoryKey] ?? []) as any[];
                    const CategoryIcon = categoryMeta.icon;
                    const isNewItem = (item: any): boolean => !!item._isNew;
                    const isCategoryEditable = true; // Assumes all forms exist now

                    return (
                        <div key={categoryKey} className="flex flex-col rounded-lg border border-gray-200 bg-white shadow-md overflow-hidden">
                            {/* Card Header */}
                            <div className="flex items-center justify-between border-b border-gray-200 bg-gray-50 px-4 py-3"> <div className="flex items-center gap-2"> <CategoryIcon className="h-5 w-5 text-indigo-600" aria-hidden="true" /> <h2 className="text-lg font-semibold text-gray-700">{categoryMeta.title}</h2> </div> {isEditing && ( <button onClick={() => handleAddItemLocally(categoryKey)} className="rounded bg-indigo-50 p-1 text-indigo-600 hover:bg-indigo-100 disabled:opacity-50 disabled:cursor-not-allowed" title={`Add ${categoryMeta.title}`} disabled={editingItemId !== null || !isCategoryEditable}> <PlusIcon className="h-4 w-4" /> </button> )} </div>
                            {/* Card Body */}
                            <div className="flex-grow p-4 text-sm text-gray-700">
                                {categoryData.length === 0 ? ( <p className="italic text-gray-400">No items recorded.</p> ) : (
                                    <ul className="space-y-4">
                                        {categoryData.map((item: EditableItem, index: number) => (
                                            <li key={item.id || index} className={`border-b border-gray-100 pb-3 last:border-b-0 last:pb-0 relative group ${isEditing && item.id === editingItemId ? 'bg-blue-50 p-3 rounded border border-dashed border-blue-300 shadow-inner' : isNewItem(item) ? 'bg-green-50 p-3 rounded border border-dashed border-green-300 shadow-inner' : ''}`}>
                                                {/* RENDER FORM OR DISPLAY */}
                                                {isEditing && isCategoryEditable && (isNewItem(item) || item.id === editingItemId) ? (
                                                    // --- RENDER FORM ---
                                                    <>
                                                         {categoryKey === 'academicQualifications' && ( <AcademicQualificationForm item={item as TempAcademicQualification} isPending={isPending} handleInputChange={handleInputChange.bind(null, categoryKey)} handleFileChange={handleFileChange.bind(null, categoryKey)} /> )}
                                                         {categoryKey === 'professionalDevelopments' && ( <ProfessionalDevelopmentForm item={item as TempProfessionalDevelopment} isPending={isPending} handleInputChange={handleInputChange.bind(null, categoryKey)} handleFileChange={handleFileChange.bind(null, categoryKey)} /> )}
                                                         {categoryKey === 'professionalLicenses' && ( <ProfessionalLicenseForm item={item as TempProfessionalLicense} isPending={isPending} handleInputChange={handleInputChange.bind(null, categoryKey)} handleFileChange={handleFileChange.bind(null, categoryKey)} /> )}
                                                         {categoryKey === 'workExperiences' && ( <WorkExperienceForm item={item as TempWorkExperience} isPending={isPending} handleInputChange={handleInputChange.bind(null, categoryKey)} handleFileChange={handleFileChange.bind(null, categoryKey)} /> )}
                                                         {categoryKey === 'professionalAffiliations' && ( <ProfessionalAffiliationForm item={item as TempProfessionalAffiliation} isPending={isPending} handleInputChange={handleInputChange.bind(null, categoryKey)} handleFileChange={handleFileChange.bind(null, categoryKey)} /> )}
                                                         {categoryKey === 'awardsRecognitions' && ( <AwardRecognitionForm item={item as TempAwardRecognition} isPending={isPending} handleInputChange={handleInputChange.bind(null, categoryKey)} handleFileChange={handleFileChange.bind(null, categoryKey)} /> )}
                                                         {categoryKey === 'communityInvolvements' && ( <CommunityInvolvementForm item={item as TempCommunityInvolvement} isPending={isPending} handleInputChange={handleInputChange.bind(null, categoryKey)} handleFileChange={handleFileChange.bind(null, categoryKey)} /> )}
                                                         {categoryKey === 'publications' && ( <PublicationForm item={item as TempPublication} isPending={isPending} handleInputChange={handleInputChange.bind(null, categoryKey)} handleFileChange={handleFileChange.bind(null, categoryKey)} /> )}
                                                         {categoryKey === 'conferencePresentations' && ( <ConferencePresentationForm item={item as TempConferencePresentation} isPending={isPending} handleInputChange={handleInputChange.bind(null, categoryKey)} handleFileChange={handleFileChange.bind(null, categoryKey)} /> )}
                                                         {/* Item specific Save/Cancel Buttons */}
                                                        {!isNewItem(item) && item.id === editingItemId && ( <div className='flex justify-end gap-2 mt-3'> <button onClick={() => handleCancelItemEdit(categoryKey, item.id)} disabled={isPending} className='inline-flex items-center gap-1 px-2 py-1 rounded text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-400'> <XMarkIcon className='h-3 w-3'/> Cancel</button> <button onClick={() => handleSaveEditedItem(item.id)} disabled={isPending} className='inline-flex items-center gap-1 px-2 py-1 rounded text-xs bg-blue-100 hover:bg-blue-200 text-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400'> <CheckIcon className='h-3 w-3'/> Save Item</button> </div> )}
                                                    </>
                                                ) : (
                                                    // --- DISPLAY ITEM ---
                                                    <>
                                                         {categoryKey === 'academicQualifications' && ( <AcademicQualificationDisplay item={item as AcademicQualification} /> )}
                                                         {categoryKey === 'professionalDevelopments' && ( <ProfessionalDevelopmentDisplay item={item as ProfessionalDevelopment} /> )}
                                                         {categoryKey === 'professionalLicenses' && ( <ProfessionalLicenseDisplay item={item as ProfessionalLicense} /> )}
                                                         {categoryKey === 'workExperiences' && ( <WorkExperienceDisplay item={item as WorkExperience} /> )}
                                                         {categoryKey === 'professionalAffiliations' && ( <ProfessionalAffiliationDisplay item={item as ProfessionalAffiliation} /> )}
                                                         {categoryKey === 'awardsRecognitions' && ( <AwardRecognitionDisplay item={item as AwardRecognition} /> )}
                                                         {categoryKey === 'communityInvolvements' && ( <CommunityInvolvementDisplay item={item as CommunityInvolvement} /> )}
                                                         {categoryKey === 'publications' && ( <PublicationDisplay item={item as Publication} /> )}
                                                         {categoryKey === 'conferencePresentations' && ( <ConferencePresentationDisplay item={item as ConferencePresentation} /> )}
                                                    </>
                                                )}
                                                {/* Action Buttons (Edit/Delete) */}
                                                {isEditing && item.id !== editingItemId && ( <div className="absolute top-1 right-1 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity"> {isCategoryEditable && !isNewItem(item) && ( <button onClick={() => handleStartEditingItem(categoryKey, item.id)} className="p-0.5 rounded bg-blue-50 text-blue-500 hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-1" title={`Edit`} disabled={isPending || editingItemId !== null}> <PencilIcon className="h-4 w-4" /> </button> )} <button onClick={() => handleDeleteItemLocally(categoryKey, item.id)} className="p-0.5 rounded bg-red-50 text-red-500 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-1" title={`Delete`} disabled={isPending || editingItemId !== null}> <TrashIcon className="h-4 w-4" /> </button> </div> )}
                                            </li>
                                        ))}
                                    </ul>
                                )}
                            </div>
                        </div>
                    );
                })}
            </div>
        </div>
    );
}


--- END FILE: src\app\(faculty)\profile\page.tsx ---

--- START FILE: src\app\admin\approvals\page.tsx ---
[EMPTY FILE]

--- END FILE: src\app\admin\approvals\page.tsx ---

--- START FILE: src\app\admin\dashboard\page.tsx ---
// src/app/admin/dashboard/page.tsx
'use client';

import React from 'react';
import { useSession } from 'next-auth/react';
import Link from 'next/link'; // For linking to other admin sections later

export default function AdminDashboardPage() {
    const { data: session, status } = useSession();

    // Note: The middleware should already prevent non-admins from reaching here.
    // This check is mostly for display purposes or as an extra layer.
    const userRole = (session?.user as any)?.role;

    if (status === 'loading') {
        return <div className="p-6">Loading admin dashboard...</div>;
    }

    // Extra check, though middleware is primary protection
    if (status !== 'authenticated' || userRole !== 'ADMIN') {
         return <div className="p-6">Access Denied. You do not have permission to view this page.</div>;
    }

    return (
        <div className="p-6">
            <h1 className="mb-6 text-2xl font-semibold text-[#003153]">
                Administrator Dashboard
            </h1>

            <p className="mb-4">
                Welcome, Administrator {session?.user?.name ?? session?.user?.email}!
            </p>

            <p>This is the central hub for managing faculty and system settings.</p>

            {/* Placeholder sections for Admin features */}
             <div className="mt-6 grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3">
                <div className="rounded border border-gray-200 bg-white p-4 shadow">
                    <h2 className="mb-2 text-lg font-medium text-[#003153]">Manage Faculty</h2>
                    <p className="text-sm text-gray-600">View and manage faculty profiles.</p>
                     {/* <Link href="/admin/faculty">Go</Link> */}
                </div>
                 <div className="rounded border border-gray-200 bg-white p-4 shadow">
                    <h2 className="mb-2 text-lg font-medium text-[#003153]">Document Approvals</h2>
                    <p className="text-sm text-gray-600">Review pending document submissions.</p>
                     {/* <Link href="/admin/approvals">Go</Link> */}
                </div>
                 <div className="rounded border border-gray-200 bg-white p-4 shadow">
                    <h2 className="mb-2 text-lg font-medium text-[#003153]">Specialization Matrix</h2>
                    <p className="text-sm text-gray-600">View faculty skills and expertise.</p>
                     {/* <Link href="/admin/matrix">Go</Link> */}
                </div>
                 {/* Add more admin sections as needed */}
            </div>
        </div>
    );
}


--- END FILE: src\app\admin\dashboard\page.tsx ---

--- START FILE: src\app\admin\faculty\page.tsx ---
[EMPTY FILE]

--- END FILE: src\app\admin\faculty\page.tsx ---

--- START FILE: src\app\admin\faculty\[facultyId]\page.tsx ---
[EMPTY FILE]

--- END FILE: src\app\admin\faculty\[facultyId]\page.tsx ---

--- START FILE: src\app\admin\matrix\page.tsx ---
[EMPTY FILE]

--- END FILE: src\app\admin\matrix\page.tsx ---

--- START FILE: src\app\api\auth\[...nextauth]\route.ts ---
// src/app/api/auth/[...nextauth]/route.ts
import NextAuth, { type NextAuthOptions } from 'next-auth';
import CredentialsProvider from 'next-auth/providers/credentials';
import { PrismaAdapter } from '@next-auth/prisma-adapter';
import bcrypt from 'bcrypt';
import prisma from '@/lib/prisma'; // Import the singleton Prisma Client instance

export const authOptions: NextAuthOptions = {
    // Configure Prisma Adapter
    adapter: PrismaAdapter(prisma),

    // Configure one or more authentication providers
    providers: [
        CredentialsProvider({
            // The name to display on the sign in form (e.g. "Sign in with...")
            name: 'Credentials',
            // `credentials` is used to generate a form on the sign in page.
            credentials: {
                email: { label: "Email", type: "email", placeholder: "jsmith@example.com" },
                password: { label: "Password", type: "password" }
            },
            async authorize(credentials, req) {
                // Add logic here to look up the user from the credentials supplied
                if (!credentials?.email || !credentials?.password) {
                    console.error('Credentials missing');
                    return null; // Indicate failure: credentials not provided
                }

                try {
                    // Find the user in the database using the imported prisma instance
                    const user = await prisma.user.findUnique({
                        where: { email: credentials.email }
                    });

                    if (!user) {
                        console.error('No user found with email:', credentials.email);
                        // Optionally: throw new Error("No user found."); // Can provide feedback
                        return null; // User not found
                    }

                    // Validate the password using bcrypt.compare
                    const isValidPassword = await bcrypt.compare(
                        credentials.password, // Plain password from login form
                        user.password         // Hashed password from database
                    );

                    if (!isValidPassword) {
                        console.error('Invalid password for user:', credentials.email);
                        // Optionally: throw new Error("Invalid password."); // Can provide feedback
                        return null; // Password doesn't match
                    }

                    console.log('User authorized:', user.email);
                    // Return user object if credentials are valid
                    // This object must satisfy NextAuth's User type (at least 'id')
                    // Using 'as any' here simplifies typing for now.
                    return {
                        id: user.id,
                        name: user.name,
                        email: user.email,
                        role: user.role, // Include the role
                    } as any;

                } catch (error) {
                    console.error("Error during authorization:", error);
                    return null; // Return null on any unexpected error during authorization
                }
            }
        })
        // ...add more providers here (e.g., Google, GitHub)
    ],

    // Define how session is managed
    session: {
        strategy: "jwt", // Use JSON Web Tokens for session management
    },

    // Callbacks are asynchronous functions you can use to control what happens
    callbacks: {
        // Add user id and role to the JWT payload
        async jwt({ token, user }) {
            if (user) {
                // The 'user' object here comes from the 'authorize' function or DB lookup
                token.id = user.id;
                // Need type assertion because 'role' isn't part of default JWT token type
                token.role = (user as any).role;
            }
            return token;
        },
        // Add user id and role to the session object available client-side
        async session({ session, token }) {
            if (token && session.user) {
                 // Need type assertion to add custom properties to default Session['user']
                (session.user as any).id = token.id;
                (session.user as any).role = token.role;
            }
            return session;
        },
    },

    // Specify pages for login, error handling, etc.
    pages: {
        signIn: '/login', // Redirect users to /login if they need to sign in
        // error: '/auth/error', // Optional: Custom error page
    },

    // Secret for signing tokens (required) - loaded from .env.local
    secret: process.env.NEXTAUTH_SECRET,

    // Enable debug messages in development for easier troubleshooting
    debug: process.env.NODE_ENV === 'development',
};

// Export the NextAuth handler for GET and POST requests
const handler = NextAuth(authOptions);
export { handler as GET, handler as POST };


--- END FILE: src\app\api\auth\[...nextauth]\route.ts ---

--- START FILE: src\app\api\documents\route.ts ---
[EMPTY FILE]

--- END FILE: src\app\api\documents\route.ts ---

--- START FILE: src\app\api\faculty\route.ts ---
[EMPTY FILE]

--- END FILE: src\app\api\faculty\route.ts ---

--- START FILE: src\app\image-test\page.tsx ---
'use client'; // Required for potential state/hooks later if needed

import React from 'react';
import Image from 'next/image';
import Link from 'next/link';

// Ensure you have a valid image file named dot.png
// located directly in your project's /public directory
const IMAGE_SRC = "/dot.png";
const IMAGE_WIDTH = 100; // Example width
const IMAGE_HEIGHT = 100; // Example height

export default function ImageTestPage() {

    return (
        <div className="p-10">
            <h1 className="text-2xl font-bold mb-6">Image Loading Test Page</h1>

            <p className="mb-4">
                This page attempts to load the image located at <code>{IMAGE_SRC}</code>
                (expected to be in the <code>/public</code> folder).
            </p>

            <hr className="my-6" />

            {/* Test Case 1: Standard next/image */}
            <div className="mb-8 p-4 border rounded shadow">
                <h2 className="text-lg font-semibold mb-2">Test 1: Standard `next/image`</h2>
                <p className="text-sm text-gray-600 mb-2">
                    Using default optimization. Should work if the file is valid and optimization is okay.
                </p>
                <div style={{ width: `${IMAGE_WIDTH}px`, height: `${IMAGE_HEIGHT}px`, position: 'relative', border: '1px dashed blue' }}>
                    <Image
                        src={IMAGE_SRC}
                        alt="Test Dot - Standard"
                        width={IMAGE_WIDTH}
                        height={IMAGE_HEIGHT}
                        style={{ border: '1px solid red' }} // Add visible border to image itself
                        // Add onError for more feedback
                        onError={(e) => console.error(`Standard Image Error for ${IMAGE_SRC}:`, e)}
                    />
                </div>
                 <p className="text-xs mt-2">Container size: {IMAGE_WIDTH}x{IMAGE_HEIGHT}. Image border: red. Container border: blue dashed.</p>
            </div>

            {/* Test Case 2: next/image with unoptimized={true} */}
            <div className="mb-8 p-4 border rounded shadow">
                <h2 className="text-lg font-semibold mb-2">Test 2: `next/image` with `unoptimized`</h2>
                <p className="text-sm text-gray-600 mb-2">
                    Bypasses optimization. Should work if the file exists but optimization fails.
                </p>
                 <div style={{ width: `${IMAGE_WIDTH}px`, height: `${IMAGE_HEIGHT}px`, position: 'relative', border: '1px dashed blue' }}>
                    <Image
                        src={IMAGE_SRC}
                        alt="Test Dot - Unoptimized"
                        width={IMAGE_WIDTH}
                        height={IMAGE_HEIGHT}
                        unoptimized={true} // Bypass optimization
                        style={{ border: '1px solid red' }}
                        onError={(e) => console.error(`Unoptimized Image Error for ${IMAGE_SRC}:`, e)}
                    />
                </div>
                <p className="text-xs mt-2">Container size: {IMAGE_WIDTH}x{IMAGE_HEIGHT}. Image border: red. Container border: blue dashed.</p>
            </div>

             {/* Test Case 3: Standard HTML <img> tag */}
            <div className="mb-8 p-4 border rounded shadow">
                <h2 className="text-lg font-semibold mb-2">Test 3: Standard HTML `<img/>` tag</h2>
                <p className="text-sm text-gray-600 mb-2">
                    Loads the image directly from the public folder, no Next.js processing. Should work if the file exists and the server serves static files correctly.
                </p>
                {/* eslint-disable-next-line @next/next/no-img-element */}
                <img
                    src={IMAGE_SRC}
                    alt="Test Dot - Standard img tag"
                    width={IMAGE_WIDTH}
                    height={IMAGE_HEIGHT}
                    style={{ border: '1px solid red' }}
                    onError={(e) => console.error(`Standard <img> Error for ${IMAGE_SRC}:`, e.currentTarget.src)} // Note: error handling is slightly different
                />
                 <p className="text-xs mt-2">Explicit width/height set: {IMAGE_WIDTH}x{IMAGE_HEIGHT}. Image border: red.</p>
            </div>

            <hr className="my-6" />

            <Link href="/login" className="text-blue-600 hover:underline">
                ? Back to Login
            </Link>
        </div>
    );
}


--- END FILE: src\app\image-test\page.tsx ---

--- START FILE: src\components\profile\AcademicQualificationDisplay.tsx ---
// src/components/profile/AcademicQualificationDisplay.tsx
import React from 'react';
import type { AcademicQualification } from '@/generated/prisma';

// Helper function (can be moved to a utils file later)
const formatDateLocal = (date: string | Date | null | undefined): string => {
    if (!date) return 'N/A';
    try { return new Date(date).toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' }); }
    catch (e) { return 'Invalid Date'; }
};


interface Props {
    item: AcademicQualification;
}

export default function AcademicQualificationDisplay({ item }: Props) {
    return (
        <>
            <p className="font-semibold text-gray-800">{item.degree || 'N/A'}</p>
            <p className="text-gray-600">{item.institution || 'N/A'}{item.program ? ` - ${item.program}` : ''}</p>
            <p className="text-xs text-gray-500 mt-1">Completed: {item.yearCompleted || 'N/A'}</p>
            {item.diplomaFileUrl && (
                 <a
                    href={item.diplomaFileUrl}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="text-xs text-blue-600 hover:underline mt-1 block truncate"
                    title={item.diplomaFileUrl} // Show full URL on hover
                 >
                    View Document
                 </a>
            )}
        </>
    );
}


--- END FILE: src\components\profile\AcademicQualificationDisplay.tsx ---

--- START FILE: src\components\profile\AcademicQualificationForm.tsx ---
// src/components/profile/AcademicQualificationForm.tsx
import React, { ChangeEvent } from 'react';
import { PaperClipIcon } from '@heroicons/react/24/outline';
// --- *** IMPORT FROM TYPES FILE *** ---
import type { TempAcademicQualification } from '@/types';

interface Props {
    item: TempAcademicQualification;
    isPending: boolean;
    // Use keyof directly on the imported type for better safety
    handleInputChange: (itemId: string, fieldName: keyof TempAcademicQualification, value: string | number) => void;
    handleFileChange: (itemId: string, file: File | null | undefined) => void;
}

// Input and Label classes
const inputClass = "block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm disabled:opacity-70";
const labelClass = "block text-xs font-medium text-gray-600 mb-0.5";

export default function AcademicQualificationForm({ item, isPending, handleInputChange, handleFileChange }: Props) {
    const isNewItem = !!item._isNew;
    return (
        <div className="space-y-3">
            {/* ... rest of the form JSX remains the same ... */}
             <p className="text-xs font-semibold text-blue-700"> {isNewItem ? 'New Qualification' : 'Editing Qualification'} </p>
             {/* Degree Input */}
             <div> <label htmlFor={`degree-${item.id}`} className={labelClass}>Degree*</label> <input type="text" id={`degree-${item.id}`} name="degree" value={item.degree || ''} onChange={(e) => handleInputChange(item.id, 'degree', e.target.value)} className={inputClass} placeholder="e.g., Bachelor of Science" required disabled={isPending} /> </div>
             {/* Institution Input */}
             <div> <label htmlFor={`institution-${item.id}`} className={labelClass}>Institution*</label> <input type="text" id={`institution-${item.id}`} name="institution" value={item.institution || ''} onChange={(e) => handleInputChange(item.id, 'institution', e.target.value)} className={inputClass} placeholder="e.g., San Pedro College" required disabled={isPending} /> </div>
             {/* Program Input */}
             <div> <label htmlFor={`program-${item.id}`} className={labelClass}>Program/Major*</label> <input type="text" id={`program-${item.id}`} name="program" value={item.program || ''} onChange={(e) => handleInputChange(item.id, 'program', e.target.value)} className={inputClass} placeholder="e.g., Medical Laboratory Science" required disabled={isPending} /> </div>
             {/* Year Completed Input */}
             <div> <label htmlFor={`yearCompleted-${item.id}`} className={labelClass}>Year Completed*</label> <input type="number" id={`yearCompleted-${item.id}`} name="yearCompleted" value={item.yearCompleted || ''} onChange={(e) => handleInputChange(item.id, 'yearCompleted', parseInt(e.target.value, 10) || '')} className={inputClass} placeholder="YYYY" required min="1900" max={new Date().getFullYear() + 5} disabled={isPending} /> </div>
             {/* File Input */}
             <div> <label htmlFor={`diplomaFile-${item.id}`} className={labelClass}> Upload Diploma/Transcript {isNewItem ? '(Optional)' : '(Replace Existing - Optional)'} </label> {!isNewItem && item.diplomaFileUrl && !item._selectedFile && ( <div className="mb-1.5 flex items-center gap-1 text-xs text-gray-600"> <PaperClipIcon className="h-3 w-3 flex-shrink-0" /> Current: <a href={item.diplomaFileUrl} target="_blank" rel="noreferrer" className="text-blue-600 hover:underline truncate max-w-[150px]">{item.diplomaFileUrl.split('/').pop()}</a> </div> )} <input type="file" id={`diplomaFile-${item.id}`} name="diplomaFile" onChange={(e) => handleFileChange(item.id, e.target.files?.[0])} className="block w-full text-xs text-gray-500 file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:text-xs file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 disabled:opacity-70" accept=".pdf,.png,.jpg,.jpeg" disabled={isPending} /> {item._selectedFile && ( <div className="mt-1.5 flex items-center gap-1 text-xs text-gray-600"> <PaperClipIcon className="h-3 w-3 flex-shrink-0" /> New: <span>{item._selectedFile.name}</span> <button type="button" onClick={() => handleFileChange(item.id, null)} className="ml-1 text-red-500 hover:text-red-700 focus:outline-none" title="Remove selection" disabled={isPending}></button> </div> )} <p className="text-xs text-gray-500 mt-1">Max 5MB. PDF, PNG, JPG.</p> </div>
        </div>
    );
}


--- END FILE: src\components\profile\AcademicQualificationForm.tsx ---

--- START FILE: src\components\profile\AwardRecognitionDisplay.tsx ---
// src/components/profile/AwardRecognitionDisplay.tsx
import React from 'react';
import type { AwardRecognition } from '@/generated/prisma';
import { PaperClipIcon } from '@heroicons/react/24/outline';

interface Props { item: AwardRecognition }

export default function AwardRecognitionDisplay({ item }: Props) {
    return (
        <>
            <p className="font-semibold text-gray-800">{item.awardName || 'N/A'}</p>
            <p className="text-gray-600">
                <span className="font-medium">Awarding Body:</span> {item.awardingBody || 'N/A'}
            </p>
            <p className="text-xs text-gray-500 mt-1">
                <span className="font-medium">Year Received:</span> {item.yearReceived || 'N/A'}
            </p>
            {item.certificateUrl && (
                 <a
                    href={item.certificateUrl}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="inline-flex items-center gap-1 text-xs text-blue-600 hover:underline mt-1 truncate max-w-[200px]"
                    title={item.certificateUrl}>
                   <PaperClipIcon className="h-3 w-3 flex-shrink-0" /> View Certificate/Proof
                 </a>
            )}
        </>
    );
}


--- END FILE: src\components\profile\AwardRecognitionDisplay.tsx ---

--- START FILE: src\components\profile\AwardRecognitionForm.tsx ---
// src/components/profile/AwardRecognitionForm.tsx
import React from 'react';
import type { TempAwardRecognition } from '@/types';
import { PaperClipIcon } from '@heroicons/react/24/outline';

interface Props {
    item: TempAwardRecognition;
    isPending: boolean;
    handleInputChange: (itemId: string, fieldName: keyof TempAwardRecognition, value: string | number | null) => void;
    handleFileChange: (itemId: string, file: File | null | undefined) => void;
}
const inputClass = "block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm disabled:opacity-70";
const labelClass = "block text-xs font-medium text-gray-600 mb-0.5";

export default function AwardRecognitionForm({ item, isPending, handleInputChange, handleFileChange }: Props) {
    const isNewItem = !!item._isNew;
    return (
        <div className="space-y-3">
            <p className="text-xs font-semibold text-blue-700">{isNewItem ? 'New Award/Recognition' : 'Editing Award/Recognition'}</p>

            {/* Award Name Input */}
            <div>
                <label htmlFor={`awardName-${item.id}`} className={labelClass}>Award/Recognition Name*</label>
                <input
                    type="text"
                    id={`awardName-${item.id}`}
                    name="awardName"
                    value={item.awardName || ''}
                    onChange={(e) => handleInputChange(item.id, 'awardName', e.target.value)}
                    className={inputClass}
                    required
                    disabled={isPending}
                />
            </div>

            {/* Awarding Body Input */}
            <div>
                <label htmlFor={`awardingBody-${item.id}`} className={labelClass}>Awarding Body*</label>
                <input
                    type="text"
                    id={`awardingBody-${item.id}`}
                    name="awardingBody"
                    value={item.awardingBody || ''}
                    onChange={(e) => handleInputChange(item.id, 'awardingBody', e.target.value)}
                    className={inputClass}
                    placeholder="e.g., San Pedro College, PAMET"
                    required
                    disabled={isPending}
                />
            </div>

            {/* Year Received Input */}
            <div>
                <label htmlFor={`yearReceived-${item.id}`} className={labelClass}>Year Received*</label>
                <input
                    type="number"
                    id={`yearReceived-${item.id}`}
                    name="yearReceived"
                    value={item.yearReceived || ''}
                    onChange={(e) => handleInputChange(item.id, 'yearReceived', parseInt(e.target.value, 10) || null)} // Parse to number or null
                    className={inputClass}
                    placeholder="YYYY"
                    required
                    min="1900"
                    max={new Date().getFullYear() + 5} // Allow a bit into the future
                    disabled={isPending}
                />
            </div>

             {/* File Input */}
             <div>
                <label htmlFor={`certificateFile-${item.id}`} className={labelClass}>Upload Certificate/Proof (Optional)</label>
                 {!isNewItem && item.certificateUrl && !item._selectedFile && (
                    <div className="mb-1.5 flex items-center gap-1 text-xs text-gray-600">
                        <PaperClipIcon className="h-3 w-3 flex-shrink-0" /> Current:
                        <a href={item.certificateUrl} target="_blank" rel="noreferrer" className="text-blue-600 hover:underline truncate max-w-[150px]"> {item.certificateUrl.split('/').pop()} </a>
                    </div>
                 )}
                 <input
                    type="file"
                    id={`certificateFile-${item.id}`}
                    name="certificateFile"
                    onChange={(e) => handleFileChange(item.id, e.target.files?.[0])}
                    className="block w-full text-xs text-gray-500 file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:text-xs file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 disabled:opacity-70"
                    accept=".pdf,.png,.jpg,.jpeg"
                    disabled={isPending}
                 />
                 {item._selectedFile && (
                     <div className="mt-1.5 flex items-center gap-1 text-xs text-gray-600"> <PaperClipIcon className="h-3 w-3 flex-shrink-0" /> New: <span>{item._selectedFile.name}</span> <button type="button" onClick={() => handleFileChange(item.id, null)} className="ml-1 text-red-500 hover:text-red-700 focus:outline-none" title="Remove selection" disabled={isPending}>?</button> </div>
                 )}
                 <p className="text-xs text-gray-500 mt-1">Max 5MB. PDF, PNG, JPG.</p>
             </div>
        </div>
    );
}


--- END FILE: src\components\profile\AwardRecognitionForm.tsx ---

--- START FILE: src\components\profile\CommunityInvolvementDisplay.tsx ---
// src/components/profile/CommunityInvolvementDisplay.tsx
import React from 'react';
import type { CommunityInvolvement } from '@/generated/prisma';
import { PaperClipIcon } from '@heroicons/react/24/outline';

interface Props { item: CommunityInvolvement }

export default function CommunityInvolvementDisplay({ item }: Props) {
    return (
        <>
            <p className="font-semibold text-gray-800">{item.engagementTitle || 'N/A'}</p>
            <p className="text-gray-600">
                <span className="font-medium">Role:</span> {item.role || 'N/A'}
            </p>
            <p className="text-xs text-gray-500 mt-1">
                <span className="font-medium">Location/Date:</span> {item.locationDate || 'N/A'}
            </p>
            {item.proofUrl && (
                 <a
                    href={item.proofUrl}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="inline-flex items-center gap-1 text-xs text-blue-600 hover:underline mt-1 truncate max-w-[200px]"
                    title={item.proofUrl}>
                   <PaperClipIcon className="h-3 w-3 flex-shrink-0" /> View Proof
                 </a>
            )}
        </>
    );
}


--- END FILE: src\components\profile\CommunityInvolvementDisplay.tsx ---

--- START FILE: src\components\profile\CommunityInvolvementForm.tsx ---
// src/components/profile/CommunityInvolvementForm.tsx
import React from 'react';
import type { TempCommunityInvolvement } from '@/types';
import { PaperClipIcon } from '@heroicons/react/24/outline';

interface Props {
    item: TempCommunityInvolvement;
    isPending: boolean;
    // String values are sufficient for these fields
    handleInputChange: (itemId: string, fieldName: keyof TempCommunityInvolvement, value: string | null) => void;
    handleFileChange: (itemId: string, file: File | null | undefined) => void;
}
const inputClass = "block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm disabled:opacity-70";
const labelClass = "block text-xs font-medium text-gray-600 mb-0.5";

export default function CommunityInvolvementForm({ item, isPending, handleInputChange, handleFileChange }: Props) {
    const isNewItem = !!item._isNew;
    return (
        <div className="space-y-3">
            <p className="text-xs font-semibold text-blue-700">{isNewItem ? 'New Community Involvement' : 'Editing Community Involvement'}</p>

            {/* Engagement Title Input */}
            <div>
                <label htmlFor={`engagementTitle-${item.id}`} className={labelClass}>Engagement Title*</label>
                <input
                    type="text"
                    id={`engagementTitle-${item.id}`}
                    name="engagementTitle"
                    value={item.engagementTitle || ''}
                    onChange={(e) => handleInputChange(item.id, 'engagementTitle', e.target.value)}
                    className={inputClass}
                    placeholder="e.g., Medical Mission Barangay X"
                    required
                    disabled={isPending}
                />
            </div>

            {/* Role Input */}
            <div>
                <label htmlFor={`role-${item.id}`} className={labelClass}>Role*</label>
                <input
                    type="text"
                    id={`role-${item.id}`}
                    name="role"
                    value={item.role || ''}
                    onChange={(e) => handleInputChange(item.id, 'role', e.target.value)}
                    className={inputClass}
                    placeholder="e.g., Volunteer, Organizer"
                    required
                    disabled={isPending}
                />
            </div>

            {/* Location/Date Input */}
            <div>
                <label htmlFor={`locationDate-${item.id}`} className={labelClass}>Location & Date*</label>
                <input
                    type="text"
                    id={`locationDate-${item.id}`}
                    name="locationDate"
                    value={item.locationDate || ''}
                    onChange={(e) => handleInputChange(item.id, 'locationDate', e.target.value)}
                    className={inputClass}
                    placeholder="e.g., Barangay X / May 5, 2024"
                    required
                    disabled={isPending}
                />
            </div>

             {/* File Input */}
             <div>
                <label htmlFor={`proofFile-${item.id}`} className={labelClass}>Upload Proof (e.g., Certificate) (Optional)</label>
                 {!isNewItem && item.proofUrl && !item._selectedFile && (
                    <div className="mb-1.5 flex items-center gap-1 text-xs text-gray-600">
                        <PaperClipIcon className="h-3 w-3 flex-shrink-0" /> Current:
                        <a href={item.proofUrl} target="_blank" rel="noreferrer" className="text-blue-600 hover:underline truncate max-w-[150px]"> {item.proofUrl.split('/').pop()} </a>
                    </div>
                 )}
                 <input
                    type="file"
                    id={`proofFile-${item.id}`}
                    name="proofFile"
                    onChange={(e) => handleFileChange(item.id, e.target.files?.[0])}
                    className="block w-full text-xs text-gray-500 file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:text-xs file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 disabled:opacity-70"
                    accept=".pdf,.png,.jpg,.jpeg"
                    disabled={isPending}
                 />
                 {item._selectedFile && (
                     <div className="mt-1.5 flex items-center gap-1 text-xs text-gray-600"> <PaperClipIcon className="h-3 w-3 flex-shrink-0" /> New: <span>{item._selectedFile.name}</span> <button type="button" onClick={() => handleFileChange(item.id, null)} className="ml-1 text-red-500 hover:text-red-700 focus:outline-none" title="Remove selection" disabled={isPending}>?</button> </div>
                 )}
                 <p className="text-xs text-gray-500 mt-1">Max 5MB. PDF, PNG, JPG.</p>
             </div>
        </div>
    );
}


--- END FILE: src\components\profile\CommunityInvolvementForm.tsx ---

--- START FILE: src\components\profile\ConferencePresentationDisplay.tsx ---
// src/components/profile/ConferencePresentationDisplay.tsx
import React from 'react';
import type { ConferencePresentation } from '@/generated/prisma';
import { PaperClipIcon } from '@heroicons/react/24/outline';

interface Props { item: ConferencePresentation }

export default function ConferencePresentationDisplay({ item }: Props) {
    return (
        <>
            <p className="font-semibold text-gray-800">{item.paperTitle || 'N/A'}</p>
            <p className="text-gray-600">
                <span className="font-medium">Event:</span> {item.eventName || 'N/A'}
            </p>
            <p className="text-xs text-gray-500 mt-1">
                <span className="font-medium">Date/Location:</span> {item.dateLocation || 'N/A'}
            </p>
            {item.proofUrl && (
                 <a href={item.proofUrl} target="_blank" rel="noopener noreferrer" className="inline-flex items-center gap-1 text-xs text-blue-600 hover:underline mt-1 truncate max-w-[200px]" title={item.proofUrl}>
                   <PaperClipIcon className="h-3 w-3 flex-shrink-0" /> View Proof/Details
                 </a>
            )}
        </>
    );
}


--- END FILE: src\components\profile\ConferencePresentationDisplay.tsx ---

--- START FILE: src\components\profile\ConferencePresentationForm.tsx ---
// src/components/profile/ConferencePresentationForm.tsx
import React from 'react';
import type { TempConferencePresentation } from '@/types';
import { PaperClipIcon } from '@heroicons/react/24/outline';

interface Props {
    item: TempConferencePresentation;
    isPending: boolean;
    // Only string values needed for these fields
    handleInputChange: (itemId: string, fieldName: keyof TempConferencePresentation, value: string) => void;
    handleFileChange: (itemId: string, file: File | null | undefined) => void;
}
const inputClass = "block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm disabled:opacity-70";
const labelClass = "block text-xs font-medium text-gray-600 mb-0.5";

export default function ConferencePresentationForm({ item, isPending, handleInputChange, handleFileChange }: Props) {
    const isNewItem = !!item._isNew;
    return (
        <div className="space-y-3">
            <p className="text-xs font-semibold text-blue-700">{isNewItem ? 'New Conference Presentation' : 'Editing Conference Presentation'}</p>

            {/* Paper Title Input */}
            <div>
                <label htmlFor={`paperTitle-${item.id}`} className={labelClass}>Paper/Presentation Title*</label>
                <input
                    type="text"
                    id={`paperTitle-${item.id}`}
                    name="paperTitle"
                    value={item.paperTitle || ''}
                    onChange={(e) => handleInputChange(item.id, 'paperTitle', e.target.value)}
                    className={inputClass}
                    required
                    disabled={isPending}
                />
            </div>

            {/* Event Name Input */}
            <div>
                <label htmlFor={`eventName-${item.id}`} className={labelClass}>Conference/Event Name*</label>
                <input
                    type="text"
                    id={`eventName-${item.id}`}
                    name="eventName"
                    value={item.eventName || ''}
                    onChange={(e) => handleInputChange(item.id, 'eventName', e.target.value)}
                    className={inputClass}
                    required
                    disabled={isPending}
                />
            </div>

            {/* Date & Location Input */}
            <div>
                <label htmlFor={`dateLocation-${item.id}`} className={labelClass}>Date & Location*</label>
                <input
                    type="text"
                    id={`dateLocation-${item.id}`}
                    name="dateLocation"
                    value={item.dateLocation || ''}
                    onChange={(e) => handleInputChange(item.id, 'dateLocation', e.target.value)}
                    className={inputClass}
                    placeholder="e.g., June 2024 / Manila"
                    required
                    disabled={isPending}
                />
            </div>

            {/* File Input for Proof */}
             <div>
                <label htmlFor={`proofFile-${item.id}`} className={labelClass}>Upload Proof (e.g., Certificate, Program) (Optional)</label>
                 {!isNewItem && item.proofUrl && !item._selectedFile && (
                    <div className="mb-1.5 flex items-center gap-1 text-xs text-gray-600">
                        <PaperClipIcon className="h-3 w-3 flex-shrink-0" /> Current:
                        <a href={item.proofUrl} target="_blank" rel="noreferrer" className="text-blue-600 hover:underline truncate max-w-[150px]"> {item.proofUrl.split('/').pop()} </a>
                    </div>
                 )}
                 <input
                    type="file"
                    id={`proofFile-${item.id}`}
                    name="proofFile"
                    onChange={(e) => handleFileChange(item.id, e.target.files?.[0])}
                    className="block w-full text-xs text-gray-500 file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:text-xs file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 disabled:opacity-70"
                    accept=".pdf,.png,.jpg,.jpeg"
                    disabled={isPending}
                 />
                 {item._selectedFile && (
                     <div className="mt-1.5 flex items-center gap-1 text-xs text-gray-600"> <PaperClipIcon className="h-3 w-3 flex-shrink-0" /> New: <span>{item._selectedFile.name}</span> <button type="button" onClick={() => handleFileChange(item.id, null)} className="ml-1 text-red-500 hover:text-red-700 focus:outline-none" title="Remove selection" disabled={isPending}>?</button> </div>
                 )}
                 <p className="text-xs text-gray-500 mt-1">Max 5MB. PDF, PNG, JPG.</p>
             </div>
        </div>
    );
}


--- END FILE: src\components\profile\ConferencePresentationForm.tsx ---

--- START FILE: src\components\profile\ProfessionalAffiliationDisplay.tsx ---
// src/components/profile/ProfessionalAffiliationDisplay.tsx
import React from 'react';
import type { ProfessionalAffiliation } from '@/generated/prisma';
import { PaperClipIcon } from '@heroicons/react/24/outline';

interface Props { item: ProfessionalAffiliation }

export default function ProfessionalAffiliationDisplay({ item }: Props) {
    return (
        <>
            <p className="font-semibold text-gray-800">{item.organization || 'N/A'}</p>
            {item.position && <p className="text-gray-600">Position: {item.position}</p>}
            <p className="text-xs text-gray-500 mt-1">Years: {item.inclusiveYears || 'N/A'}</p>
            {item.membershipProofUrl && (
                 <a href={item.membershipProofUrl} target="_blank" rel="noopener noreferrer" className="inline-flex items-center gap-1 text-xs text-blue-600 hover:underline mt-1 truncate max-w-[200px]" title={item.membershipProofUrl}>
                   <PaperClipIcon className="h-3 w-3 flex-shrink-0" /> View Proof
                 </a>
            )}
        </>
    );
}


--- END FILE: src\components\profile\ProfessionalAffiliationDisplay.tsx ---

--- START FILE: src\components\profile\ProfessionalAffiliationForm.tsx ---

// src/components/profile/ProfessionalAffiliationForm.tsx
import React from 'react';
import type { TempProfessionalAffiliation } from '@/types';
import { PaperClipIcon } from '@heroicons/react/24/outline';

interface Props {
    item: TempProfessionalAffiliation;
    isPending: boolean;
    handleInputChange: (itemId: string, fieldName: keyof TempProfessionalAffiliation, value: string | number | Date | null) => void;
    handleFileChange: (itemId: string, file: File | null | undefined) => void;
}
const inputClass = "block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm disabled:opacity-70";
const labelClass = "block text-xs font-medium text-gray-600 mb-0.5";

export default function ProfessionalAffiliationForm({ item, isPending, handleInputChange, handleFileChange }: Props) {
    const isNewItem = !!item._isNew;
    return (
        <div className="space-y-3">
            <p className="text-xs font-semibold text-blue-700">{isNewItem ? 'New Affiliation' : 'Editing Affiliation'}</p>
            <div> <label htmlFor={`organization-${item.id}`} className={labelClass}>Organization*</label> <input type="text" id={`organization-${item.id}`} name="organization" value={item.organization || ''} onChange={(e) => handleInputChange(item.id, 'organization', e.target.value)} className={inputClass} required disabled={isPending} /> </div>
            <div> <label htmlFor={`position-${item.id}`} className={labelClass}>Position (Optional)</label> <input type="text" id={`position-${item.id}`} name="position" value={item.position || ''} onChange={(e) => handleInputChange(item.id, 'position', e.target.value)} className={inputClass} disabled={isPending} /> </div>
            <div> <label htmlFor={`inclusiveYears-${item.id}`} className={labelClass}>Inclusive Years*</label> <input type="text" id={`inclusiveYears-${item.id}`} name="inclusiveYears" value={item.inclusiveYears || ''} onChange={(e) => handleInputChange(item.id, 'inclusiveYears', e.target.value)} className={inputClass} placeholder="e.g., 2019-Present" required disabled={isPending} /> </div>
             {/* File Input */}
             <div>
                <label htmlFor={`membershipProofFile-${item.id}`} className={labelClass}>Upload Membership Proof (Optional)</label>
                 {!isNewItem && item.membershipProofUrl && !item._selectedFile && ( <div className="mb-1.5 flex items-center gap-1 text-xs text-gray-600"> <PaperClipIcon className="h-3 w-3 flex-shrink-0" /> Current: <a href={item.membershipProofUrl} target="_blank" rel="noreferrer" className="text-blue-600 hover:underline truncate max-w-[150px]"> {item.membershipProofUrl.split('/').pop()} </a> </div> )}
                 <input type="file" id={`membershipProofFile-${item.id}`} name="membershipProofFile" onChange={(e) => handleFileChange(item.id, e.target.files?.[0])} className="block w-full text-xs text-gray-500 file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:text-xs file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 disabled:opacity-70" accept=".pdf,.png,.jpg,.jpeg" disabled={isPending} />
                 {item._selectedFile && ( <div className="mt-1.5 flex items-center gap-1 text-xs text-gray-600"> <PaperClipIcon className="h-3 w-3 flex-shrink-0" /> New: <span>{item._selectedFile.name}</span> <button type="button" onClick={() => handleFileChange(item.id, null)} className="ml-1 text-red-500 hover:text-red-700 focus:outline-none" title="Remove selection" disabled={isPending}>?</button> </div> )}
                 <p className="text-xs text-gray-500 mt-1">Max 5MB. PDF, PNG, JPG.</p>
             </div>
        </div>
    );
}


--- END FILE: src\components\profile\ProfessionalAffiliationForm.tsx ---

--- START FILE: src\components\profile\ProfessionalDevelopmentDisplay.tsx ---
// src/components/profile/ProfessionalDevelopmentDisplay.tsx
import React from 'react';
import type { ProfessionalDevelopment } from '@/generated/prisma';
import { PaperClipIcon } from '@heroicons/react/24/outline';

interface Props {
    item: ProfessionalDevelopment;
}

export default function ProfessionalDevelopmentDisplay({ item }: Props) {
    return (
        <>
            <p className="font-semibold text-gray-800">{item.title || 'N/A'}</p>
            <p className="text-gray-600">
                <span className="font-medium">Organizer:</span> {item.organizer || 'N/A'}
            </p>
            <p className="text-xs text-gray-500 mt-1">
                <span className="font-medium">Date/Location:</span> {item.dateLocation || 'N/A'}
            </p>
            {item.certificateFileUrl && (
                <a
                    href={item.certificateFileUrl}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="inline-flex items-center gap-1 text-xs text-blue-600 hover:underline mt-1 truncate max-w-[200px]" // Added max-w for long URLs
                    title={item.certificateFileUrl} // Show full URL on hover
                >
                   <PaperClipIcon className="h-3 w-3 flex-shrink-0" />
                   View Certificate
                </a>
            )}
        </>
    );
}


--- END FILE: src\components\profile\ProfessionalDevelopmentDisplay.tsx ---

--- START FILE: src\components\profile\ProfessionalDevelopmentForm.tsx ---
// src/components/profile/ProfessionalDevelopmentForm.tsx
import React from 'react';
import { PaperClipIcon } from '@heroicons/react/24/outline';
import type { TempProfessionalDevelopment } from '@/types'; // Import from shared types

interface Props {
    item: TempProfessionalDevelopment;
    isPending: boolean;
    handleInputChange: (itemId: string, fieldName: keyof TempProfessionalDevelopment, value: string) => void; // value is always string from input event
    handleFileChange: (itemId: string, file: File | null | undefined) => void;
}

// Input and Label classes (consistent with AcademicQualificationForm)
const inputClass = "block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm disabled:opacity-70";
const labelClass = "block text-xs font-medium text-gray-600 mb-0.5";

export default function ProfessionalDevelopmentForm({ item, isPending, handleInputChange, handleFileChange }: Props) {
    const isNewItem = !!item._isNew;
    return (
        <div className="space-y-3">
            <p className="text-xs font-semibold text-blue-700">
                {isNewItem ? 'New Professional Development' : 'Editing Professional Development'}
            </p>

            {/* Title Input */}
            <div>
                <label htmlFor={`title-${item.id}`} className={labelClass}>Title*</label>
                <input
                    type="text"
                    id={`title-${item.id}`}
                    name="title"
                    value={item.title || ''}
                    onChange={(e) => handleInputChange(item.id, 'title', e.target.value)}
                    className={inputClass}
                    placeholder="e.g., Seminar on Advanced Lab Techniques"
                    required
                    disabled={isPending}
                />
            </div>

            {/* Organizer Input */}
            <div>
                <label htmlFor={`organizer-${item.id}`} className={labelClass}>Organizer*</label>
                <input
                    type="text"
                    id={`organizer-${item.id}`}
                    name="organizer"
                    value={item.organizer || ''}
                    onChange={(e) => handleInputChange(item.id, 'organizer', e.target.value)}
                    className={inputClass}
                    placeholder="e.g., PAMET"
                    required
                    disabled={isPending}
                />
            </div>

            {/* Date & Location Input */}
            <div>
                <label htmlFor={`dateLocation-${item.id}`} className={labelClass}>Date & Location*</label>
                <input
                    type="text"
                    id={`dateLocation-${item.id}`}
                    name="dateLocation"
                    value={item.dateLocation || ''}
                    onChange={(e) => handleInputChange(item.id, 'dateLocation', e.target.value)}
                    className={inputClass}
                    placeholder="e.g., May 2024 / Davao City"
                    required
                    disabled={isPending}
                />
            </div>

            {/* File Input for Certificate */}
            <div>
                <label htmlFor={`certificateFile-${item.id}`} className={labelClass}>
                    Upload Certificate {isNewItem ? '(Optional)' : '(Replace Existing - Optional)'}
                </label>
                {!isNewItem && item.certificateFileUrl && !item._selectedFile && (
                    <div className="mb-1.5 flex items-center gap-1 text-xs text-gray-600">
                        <PaperClipIcon className="h-3 w-3 flex-shrink-0" />
                        Current:
                        <a href={item.certificateFileUrl} target="_blank" rel="noreferrer" className="text-blue-600 hover:underline truncate max-w-[150px]">
                            {item.certificateFileUrl.split('/').pop()}
                        </a>
                    </div>
                )}
                <input
                    type="file"
                    id={`certificateFile-${item.id}`}
                    name="certificateFile"
                    onChange={(e) => handleFileChange(item.id, e.target.files?.[0])}
                    className="block w-full text-xs text-gray-500 file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:text-xs file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 disabled:opacity-70"
                    accept=".pdf,.png,.jpg,.jpeg" // Consistent file types
                    disabled={isPending}
                />
                {item._selectedFile && (
                    <div className="mt-1.5 flex items-center gap-1 text-xs text-gray-600">
                        <PaperClipIcon className="h-3 w-3 flex-shrink-0" />
                        New: <span>{item._selectedFile.name}</span>
                        <button
                            type="button"
                            onClick={() => handleFileChange(item.id, null)} // Clear selection
                            className="ml-1 text-red-500 hover:text-red-700 focus:outline-none"
                            title="Remove selection"
                            disabled={isPending}
                        >
                            ? {/* Cross symbol */}
                        </button>
                    </div>
                )}
                <p className="text-xs text-gray-500 mt-1">Max 5MB. PDF, PNG, JPG.</p>
            </div>
        </div>
    );
}


--- END FILE: src\components\profile\ProfessionalDevelopmentForm.tsx ---

--- START FILE: src\components\profile\ProfessionalLicenseDisplay.tsx ---
// src/components/profile/ProfessionalLicenseDisplay.tsx
import React from 'react';
import type { ProfessionalLicense } from '@/generated/prisma';
import { PaperClipIcon } from '@heroicons/react/24/outline';

// Helper function
const formatDateOnly = (date: string | Date | null | undefined): string => {
    if (!date) return 'N/A';
    try {
        const d = new Date(date);
        if (isNaN(d.getTime())) return 'Invalid Date';
        return d.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
    } catch (e) { return 'Invalid Date'; }
};


interface Props {
    item: ProfessionalLicense;
}

export default function ProfessionalLicenseDisplay({ item }: Props) {
    return (
        <>
            <p className="font-semibold text-gray-800">{item.examination || 'N/A'}</p>
            <p className="text-gray-600">
                <span className="font-medium">License No:</span> {item.licenseNumber || 'N/A'}
            </p>
            <p className="text-xs text-gray-500 mt-1">
                <span className="font-medium">Issued:</span> {item.monthYear || 'N/A'} | <span className="font-medium">Expires:</span> {formatDateOnly(item.expiration)}
            </p>
            {/* ADDED: Link to view document */}
            {item.licenseFileUrl && (
                 <a
                    href={item.licenseFileUrl}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="inline-flex items-center gap-1 text-xs text-blue-600 hover:underline mt-1 truncate max-w-[200px]"
                    title={item.licenseFileUrl}
                 >
                   <PaperClipIcon className="h-3 w-3 flex-shrink-0" />
                   View License File
                 </a>
            )}
        </>
    );
}


--- END FILE: src\components\profile\ProfessionalLicenseDisplay.tsx ---

--- START FILE: src\components\profile\ProfessionalLicenseForm.tsx ---
// src/components/profile/ProfessionalLicenseForm.tsx
import React from 'react';
import { PaperClipIcon } from '@heroicons/react/24/outline';
import type { TempProfessionalLicense } from '@/types'; // Import from shared types

interface Props {
    item: TempProfessionalLicense;
    isPending: boolean;
    handleInputChange: (itemId: string, fieldName: keyof TempProfessionalLicense, value: string | Date | number | null) => void;
    // ADDED: handleFileChange prop
    handleFileChange: (itemId: string, file: File | null | undefined) => void;
}

// Input and Label classes
const inputClass = "block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm disabled:opacity-70";
const labelClass = "block text-xs font-medium text-gray-600 mb-0.5";

// Helper to format date for input type="date"
const formatDateForInput = (date: Date | string | null): string => {
    if (!date) return '';
    try {
        const d = new Date(date);
        if (isNaN(d.getTime())) return '';
        const year = d.getFullYear();
        const month = (d.getMonth() + 1).toString().padStart(2, '0');
        const day = d.getDate().toString().padStart(2, '0');
        return `${year}-${month}-${day}`;
    } catch { return ''; }
};

export default function ProfessionalLicenseForm({ item, isPending, handleInputChange, handleFileChange }: Props) {
    const isNewItem = !!item._isNew;

    const handleDateChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        const dateValue = e.target.value;
        try {
            const dateObject = dateValue ? new Date(dateValue) : null;
            if (dateObject && isNaN(dateObject.getTime())) {
                handleInputChange(item.id, 'expiration', null);
            } else {
                 // Ensure we pass a Date object or null, even if invalid (backend MUST validate)
                handleInputChange(item.id, 'expiration', dateObject);
            }
        } catch {
            handleInputChange(item.id, 'expiration', null);
        }
    };

    return (
        <div className="space-y-3">
            <p className="text-xs font-semibold text-blue-700">
                {isNewItem ? 'New Professional License' : 'Editing Professional License'}
            </p>

            {/* Examination Name Input */}
            <div>
                <label htmlFor={`examination-${item.id}`} className={labelClass}>Examination Name*</label>
                <input type="text" id={`examination-${item.id}`} name="examination" value={item.examination || ''} onChange={(e) => handleInputChange(item.id, 'examination', e.target.value)} className={inputClass} placeholder="e.g., Medical Technologist Licensure" required disabled={isPending} />
            </div>

            {/* License Number Input */}
            <div>
                <label htmlFor={`licenseNumber-${item.id}`} className={labelClass}>License Number*</label>
                <input type="text" id={`licenseNumber-${item.id}`} name="licenseNumber" value={item.licenseNumber || ''} onChange={(e) => handleInputChange(item.id, 'licenseNumber', e.target.value)} className={inputClass} placeholder="e.g., 0123456" required disabled={isPending} />
            </div>

            {/* Month/Year Issued Input */}
            <div>
                <label htmlFor={`monthYear-${item.id}`} className={labelClass}>Month/Year Issued*</label>
                <input type="text" id={`monthYear-${item.id}`} name="monthYear" value={item.monthYear || ''} onChange={(e) => handleInputChange(item.id, 'monthYear', e.target.value)} className={inputClass} placeholder="e.g., August 2023" required disabled={isPending} />
            </div>

            {/* Expiration Date Input */}
            <div>
                <label htmlFor={`expiration-${item.id}`} className={labelClass}>Expiration Date*</label>
                <input type="date" id={`expiration-${item.id}`} name="expiration" value={formatDateForInput(item.expiration)} onChange={handleDateChange} className={inputClass} required disabled={isPending} />
            </div>

            {/* ADDED: File Input for License */}
            <div>
                <label htmlFor={`licenseFile-${item.id}`} className={labelClass}>
                    Upload License File {isNewItem ? '(Optional)' : '(Replace Existing - Optional)'}
                </label>
                {!isNewItem && item.licenseFileUrl && !item._selectedFile && (
                    <div className="mb-1.5 flex items-center gap-1 text-xs text-gray-600">
                        <PaperClipIcon className="h-3 w-3 flex-shrink-0" />
                        Current:
                        <a href={item.licenseFileUrl} target="_blank" rel="noreferrer" className="text-blue-600 hover:underline truncate max-w-[150px]">
                            {item.licenseFileUrl.split('/').pop()}
                        </a>
                    </div>
                )}
                <input
                    type="file"
                    id={`licenseFile-${item.id}`}
                    name="licenseFile"
                    onChange={(e) => handleFileChange(item.id, e.target.files?.[0])} // Use handleFileChange
                    className="block w-full text-xs text-gray-500 file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:text-xs file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 disabled:opacity-70"
                    accept=".pdf,.png,.jpg,.jpeg"
                    disabled={isPending}
                />
                {item._selectedFile && (
                    <div className="mt-1.5 flex items-center gap-1 text-xs text-gray-600">
                        <PaperClipIcon className="h-3 w-3 flex-shrink-0" />
                        New: <span>{item._selectedFile.name}</span>
                        <button
                            type="button"
                            onClick={() => handleFileChange(item.id, null)}
                            className="ml-1 text-red-500 hover:text-red-700 focus:outline-none"
                            title="Remove selection"
                            disabled={isPending}
                        >
                            ?
                        </button>
                    </div>
                )}
                <p className="text-xs text-gray-500 mt-1">Max 5MB. PDF, PNG, JPG.</p>
            </div>
        </div>
    );
}


--- END FILE: src\components\profile\ProfessionalLicenseForm.tsx ---

--- START FILE: src\components\profile\PublicationDisplay.tsx ---
// src/components/profile/PublicationDisplay.tsx
import React from 'react';
import type { Publication } from '@/generated/prisma';
import { PaperClipIcon, LinkIcon } from '@heroicons/react/24/outline';

// Helper function
const formatDateOnly = (date: string | Date | null | undefined): string => {
    if (!date) return 'N/A';
    try {
        const d = new Date(date);
        if (isNaN(d.getTime())) return 'Invalid Date';
        return d.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
    } catch (e) { return 'Invalid Date'; }
};

interface Props { item: Publication }

export default function PublicationDisplay({ item }: Props) {
    return (
        <>
            <p className="font-semibold text-gray-800">{item.researchTitle || 'N/A'}</p>
            <p className="text-gray-600 italic">
                <span className="font-medium not-italic">Journal:</span> {item.journal || 'N/A'}
            </p>
            <p className="text-xs text-gray-500 mt-1">
                <span className="font-medium">Published:</span> {formatDateOnly(item.datePublished)}
            </p>
            <div className="mt-1 flex flex-wrap gap-x-3 gap-y-1">
                {item.doiLink && (
                    <a
                        href={item.doiLink.startsWith('http') ? item.doiLink : `https://${item.doiLink}`} // Basic protocol check
                        target="_blank"
                        rel="noopener noreferrer"
                        className="inline-flex items-center gap-1 text-xs text-blue-600 hover:underline"
                        title={item.doiLink}
                    >
                    <LinkIcon className="h-3 w-3 flex-shrink-0" /> DOI Link
                    </a>
                )}
                 {item.pdfUrl && (
                    <a
                        href={item.pdfUrl}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="inline-flex items-center gap-1 text-xs text-blue-600 hover:underline"
                        title={item.pdfUrl}>
                    <PaperClipIcon className="h-3 w-3 flex-shrink-0" /> View PDF
                    </a>
                )}
            </div>
        </>
    );
}


--- END FILE: src\components\profile\PublicationDisplay.tsx ---

--- START FILE: src\components\profile\PublicationForm.tsx ---
// src/components/profile/PublicationForm.tsx
import React from 'react';
import type { TempPublication } from '@/types';
import { PaperClipIcon } from '@heroicons/react/24/outline';

interface Props {
    item: TempPublication;
    isPending: boolean;
    handleInputChange: (itemId: string, fieldName: keyof TempPublication, value: string | Date | null) => void;
    handleFileChange: (itemId: string, file: File | null | undefined) => void;
}
const inputClass = "block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm disabled:opacity-70";
const labelClass = "block text-xs font-medium text-gray-600 mb-0.5";

// Helper to format date for input type="date"
const formatDateForInput = (date: Date | string | null): string => {
    if (!date) return '';
    try {
        const d = new Date(date);
        if (isNaN(d.getTime())) return '';
        const year = d.getFullYear();
        const month = (d.getMonth() + 1).toString().padStart(2, '0');
        const day = d.getDate().toString().padStart(2, '0');
        return `${year}-${month}-${day}`;
    } catch { return ''; }
};


export default function PublicationForm({ item, isPending, handleInputChange, handleFileChange }: Props) {
    const isNewItem = !!item._isNew;

    // Handle date change specifically
    const handleDateChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        const dateValue = e.target.value;
        try {
            // Date is required, so only pass valid Date objects
            const dateObject = dateValue ? new Date(dateValue) : null;
            if (dateObject && !isNaN(dateObject.getTime())) {
                handleInputChange(item.id, 'datePublished', dateObject);
            } else {
                 // Handle potentially setting an invalid state or visual feedback if needed
                 // For now, we might just clear it or pass null, but backend validation is key
                 handleInputChange(item.id, 'datePublished', null); // Pass null if invalid/empty
            }
        } catch {
            handleInputChange(item.id, 'datePublished', null); // Pass null on error
        }
    };


    return (
        <div className="space-y-3">
            <p className="text-xs font-semibold text-blue-700">{isNewItem ? 'New Publication' : 'Editing Publication'}</p>

            {/* Research Title Input */}
            <div>
                <label htmlFor={`researchTitle-${item.id}`} className={labelClass}>Research Title*</label>
                <input
                    type="text"
                    id={`researchTitle-${item.id}`}
                    name="researchTitle"
                    value={item.researchTitle || ''}
                    onChange={(e) => handleInputChange(item.id, 'researchTitle', e.target.value)}
                    className={inputClass}
                    required
                    disabled={isPending}
                />
            </div>

            {/* Journal Input */}
            <div>
                <label htmlFor={`journal-${item.id}`} className={labelClass}>Journal Name*</label>
                <input
                    type="text"
                    id={`journal-${item.id}`}
                    name="journal"
                    value={item.journal || ''}
                    onChange={(e) => handleInputChange(item.id, 'journal', e.target.value)}
                    className={inputClass}
                    required
                    disabled={isPending}
                />
            </div>

            {/* Date Published Input */}
             <div>
                <label htmlFor={`datePublished-${item.id}`} className={labelClass}>Date Published*</label>
                <input
                    type="date"
                    id={`datePublished-${item.id}`}
                    name="datePublished"
                    value={formatDateForInput(item.datePublished)} // Format Date to YYYY-MM-DD string
                    onChange={handleDateChange}
                    className={inputClass}
                    required // Mark as required
                    disabled={isPending}
                />
            </div>

             {/* DOI Link Input */}
            <div>
                <label htmlFor={`doiLink-${item.id}`} className={labelClass}>DOI Link (Optional)</label>
                <input
                    type="text"
                    id={`doiLink-${item.id}`}
                    name="doiLink"
                    value={item.doiLink || ''}
                    onChange={(e) => handleInputChange(item.id, 'doiLink', e.target.value || null)} // Pass null if empty
                    className={inputClass}
                    placeholder="e.g., 10.1000/xyz123 or https://doi.org/..."
                    disabled={isPending}
                 />
            </div>

            {/* File Input for PDF */}
             <div>
                <label htmlFor={`pdfFile-${item.id}`} className={labelClass}>Upload PDF Copy (Optional)</label>
                 {!isNewItem && item.pdfUrl && !item._selectedFile && (
                    <div className="mb-1.5 flex items-center gap-1 text-xs text-gray-600">
                        <PaperClipIcon className="h-3 w-3 flex-shrink-0" /> Current:
                        <a href={item.pdfUrl} target="_blank" rel="noreferrer" className="text-blue-600 hover:underline truncate max-w-[150px]"> {item.pdfUrl.split('/').pop()} </a>
                    </div>
                 )}
                 <input
                    type="file"
                    id={`pdfFile-${item.id}`}
                    name="pdfFile"
                    onChange={(e) => handleFileChange(item.id, e.target.files?.[0])}
                    className="block w-full text-xs text-gray-500 file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:text-xs file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 disabled:opacity-70"
                    accept=".pdf" // Primarily expect PDFs
                    disabled={isPending}
                 />
                 {item._selectedFile && (
                     <div className="mt-1.5 flex items-center gap-1 text-xs text-gray-600"> <PaperClipIcon className="h-3 w-3 flex-shrink-0" /> New: <span>{item._selectedFile.name}</span> <button type="button" onClick={() => handleFileChange(item.id, null)} className="ml-1 text-red-500 hover:text-red-700 focus:outline-none" title="Remove selection" disabled={isPending}>?</button> </div>
                 )}
                 <p className="text-xs text-gray-500 mt-1">Max 5MB. PDF only.</p>
             </div>
        </div>
    );
}


--- END FILE: src\components\profile\PublicationForm.tsx ---

--- START FILE: src\components\profile\WorkExperienceDisplay.tsx ---
// src/components/profile/WorkExperienceDisplay.tsx
import React from 'react';
import type { WorkExperience } from '@/generated/prisma';
import { PaperClipIcon } from '@heroicons/react/24/outline';

interface Props { item: WorkExperience }

export default function WorkExperienceDisplay({ item }: Props) {
    return (
        <>
            <p className="font-semibold text-gray-800">{item.position || 'N/A'}</p>
            <p className="text-gray-600">{item.institution || 'N/A'}</p>
            <p className="text-xs text-gray-500 mt-1">
                <span className="font-medium">Years:</span> {item.inclusiveYears || 'N/A'}
            </p>
            {item.natureOfWork && (
                <p className="text-xs text-gray-500 mt-1">
                    <span className="font-medium">Nature:</span> {item.natureOfWork}
                 </p>
            )}
            {item.proofUrl && (
                 <a
                    href={item.proofUrl}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="inline-flex items-center gap-1 text-xs text-blue-600 hover:underline mt-1 truncate max-w-[200px]"
                    title={item.proofUrl}>
                   <PaperClipIcon className="h-3 w-3 flex-shrink-0" /> View Proof
                 </a>
            )}
        </>
    );
}


--- END FILE: src\components\profile\WorkExperienceDisplay.tsx ---

--- START FILE: src\components\profile\WorkExperienceForm.tsx ---
// src/components/profile/WorkExperienceForm.tsx
import React from 'react';
import type { TempWorkExperience } from '@/types';
import { PaperClipIcon } from '@heroicons/react/24/outline';

interface Props {
    item: TempWorkExperience;
    isPending: boolean;
    // String values are sufficient for this form's inputs
    handleInputChange: (itemId: string, fieldName: keyof TempWorkExperience, value: string | null) => void;
    handleFileChange: (itemId: string, file: File | null | undefined) => void;
}
const inputClass = "block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm disabled:opacity-70";
const labelClass = "block text-xs font-medium text-gray-600 mb-0.5";

export default function WorkExperienceForm({ item, isPending, handleInputChange, handleFileChange }: Props) {
    const isNewItem = !!item._isNew;
    return (
        <div className="space-y-3">
            <p className="text-xs font-semibold text-blue-700">{isNewItem ? 'New Work Experience' : 'Editing Work Experience'}</p>

            {/* Position Input */}
            <div>
                <label htmlFor={`position-${item.id}`} className={labelClass}>Position*</label>
                <input
                    type="text"
                    id={`position-${item.id}`}
                    name="position"
                    value={item.position || ''}
                    onChange={(e) => handleInputChange(item.id, 'position', e.target.value)}
                    className={inputClass}
                    placeholder="e.g., Faculty, Medical Technologist"
                    required
                    disabled={isPending} />
             </div>

             {/* Institution Input */}
            <div>
                <label htmlFor={`institution-${item.id}`} className={labelClass}>Institution*</label>
                <input
                    type="text"
                    id={`institution-${item.id}`}
                    name="institution"
                    value={item.institution || ''}
                    onChange={(e) => handleInputChange(item.id, 'institution', e.target.value)}
                    className={inputClass}
                    placeholder="e.g., San Pedro College"
                    required
                    disabled={isPending}
                 />
             </div>

             {/* Inclusive Years Input */}
            <div>
                <label htmlFor={`inclusiveYears-${item.id}`} className={labelClass}>Inclusive Years*</label>
                <input
                    type="text"
                    id={`inclusiveYears-${item.id}`}
                    name="inclusiveYears"
                    value={item.inclusiveYears || ''}
                    onChange={(e) => handleInputChange(item.id, 'inclusiveYears', e.target.value)}
                    className={inputClass}
                    placeholder="e.g., 2020-Present or 2018-2019"
                    required
                    disabled={isPending}
                 />
             </div>

             {/* Nature of Work Input */}
            <div>
                <label htmlFor={`natureOfWork-${item.id}`} className={labelClass}>Nature of Work (Optional)</label>
                <input
                    type="text"
                    id={`natureOfWork-${item.id}`}
                    name="natureOfWork"
                    value={item.natureOfWork || ''}
                    // Pass null if empty string for optional fields
                    onChange={(e) => handleInputChange(item.id, 'natureOfWork', e.target.value || null)}
                    className={inputClass}
                    disabled={isPending}
                 />
             </div>

             {/* File Input */}
             <div>
                <label htmlFor={`proofFile-${item.id}`} className={labelClass}>Upload Proof (e.g., COE) (Optional)</label>
                 {!isNewItem && item.proofUrl && !item._selectedFile && (
                    <div className="mb-1.5 flex items-center gap-1 text-xs text-gray-600">
                        <PaperClipIcon className="h-3 w-3 flex-shrink-0" /> Current:
                        <a href={item.proofUrl} target="_blank" rel="noreferrer" className="text-blue-600 hover:underline truncate max-w-[150px]"> {item.proofUrl.split('/').pop()} </a>
                    </div>
                 )}
                 <input
                    type="file"
                    id={`proofFile-${item.id}`}
                    name="proofFile"
                    onChange={(e) => handleFileChange(item.id, e.target.files?.[0])}
                    className="block w-full text-xs text-gray-500 file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:text-xs file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 disabled:opacity-70"
                    accept=".pdf,.png,.jpg,.jpeg"
                    disabled={isPending}
                 />
                 {item._selectedFile && (
                     <div className="mt-1.5 flex items-center gap-1 text-xs text-gray-600"> <PaperClipIcon className="h-3 w-3 flex-shrink-0" /> New: <span>{item._selectedFile.name}</span> <button type="button" onClick={() => handleFileChange(item.id, null)} className="ml-1 text-red-500 hover:text-red-700 focus:outline-none" title="Remove selection" disabled={isPending}>?</button> </div>
                 )}
                 <p className="text-xs text-gray-500 mt-1">Max 5MB. PDF, PNG, JPG.</p>
             </div>
        </div>
    );
}


--- END FILE: src\components\profile\WorkExperienceForm.tsx ---

--- START FILE: src\components\providers\NextAuthProvider.tsx ---
// src/components/providers/NextAuthProvider.tsx
'use client'; // This component wraps SessionProvider, so it must be a Client Component

import { SessionProvider } from 'next-auth/react';
import React from 'react';

interface Props {
    children: React.ReactNode;
    // We might pass the session from the server later for optimization,
    // but for now, SessionProvider will fetch it client-side.
}

export default function NextAuthProvider({ children }: Props) {
    return <SessionProvider>{children}</SessionProvider>;
}


--- END FILE: src\components\providers\NextAuthProvider.tsx ---

--- START FILE: src\lib\auth.ts ---
[EMPTY FILE]

--- END FILE: src\lib\auth.ts ---

--- START FILE: src\lib\db.ts ---
[EMPTY FILE]

--- END FILE: src\lib\db.ts ---

--- START FILE: src\lib\prisma.ts ---
// src/lib/prisma.ts
import { PrismaClient } from '@/generated/prisma';

// Declare a global variable to hold the Prisma Client instance.
// We use 'globalThis' which works in different environments (Node, browser, edge).
// We add '_prisma' to avoid potential naming conflicts.
declare global {
  // eslint-disable-next-line no-var
  var _prisma: PrismaClient | undefined;
}

// Check if we already have an instance in the global scope.
// If not, create a new one. In development, due to Next.js hot reloading,
// 'global._prisma' might already exist, so we reuse it to avoid creating too many connections.
const prisma = globalThis._prisma ?? new PrismaClient();

// In non-production environments, assign the instance to the global scope.
if (process.env.NODE_ENV !== 'production') {
  globalThis._prisma = prisma;
}

// Export the single instance.
export default prisma;


--- END FILE: src\lib\prisma.ts ---

--- START FILE: src\lib\userActions.ts ---
// src/lib/userActions.ts
'use server'; // Mark this file as containing Server Actions

import { getServerSession } from 'next-auth/next';
import { authOptions } from '@/app/api/auth/[...nextauth]/route';
import prisma from '@/lib/prisma';
import type {
    User, AcademicQualification, ProfessionalLicense, WorkExperience,
    ProfessionalAffiliation, AwardRecognition, ProfessionalDevelopment,
    CommunityInvolvement, Publication, ConferencePresentation
 } from '@/generated/prisma'; // Use generated types directly
import { revalidatePath } from 'next/cache';
import fs from 'fs/promises'; // Import Node.js file system promises API
import path from 'path';     // Import Node.js path module
import { v4 as uuidv4 } from 'uuid'; // Import UUID generator

// --- Incoming Data Types (Define for all sections) ---
// Omit fields managed by server or temporary frontend state (_selectedFile)
type IncomingAcademicQualification = Omit<AcademicQualification, 'createdAt' | 'updatedAt' | 'userId'> & { _isNew?: boolean; id: string; yearCompleted: number | null; };
type IncomingProfessionalLicense = Omit<ProfessionalLicense, 'createdAt' | 'updatedAt' | 'userId'> & { _isNew?: boolean; id: string; expiration: string | null; }; // Keep expiration as string|null from JSON
type IncomingWorkExperience = Omit<WorkExperience, 'createdAt' | 'updatedAt' | 'userId'> & { _isNew?: boolean; id: string; };
type IncomingProfessionalAffiliation = Omit<ProfessionalAffiliation, 'createdAt' | 'updatedAt' | 'userId'> & { _isNew?: boolean; id: string; };
type IncomingAwardRecognition = Omit<AwardRecognition, 'createdAt' | 'updatedAt' | 'userId'> & { _isNew?: boolean; id: string; yearReceived: number | null; };
type IncomingProfessionalDevelopment = Omit<ProfessionalDevelopment, 'createdAt' | 'updatedAt' | 'userId'> & { _isNew?: boolean; id: string; };
type IncomingCommunityInvolvement = Omit<CommunityInvolvement, 'createdAt' | 'updatedAt' | 'userId'> & { _isNew?: boolean; id: string; };
type IncomingPublication = Omit<Publication, 'createdAt' | 'updatedAt' | 'userId'> & { _isNew?: boolean; id: string; datePublished: string | null; }; // Keep datePublished as string|null from JSON
type IncomingConferencePresentation = Omit<ConferencePresentation, 'createdAt' | 'updatedAt' | 'userId'> & { _isNew?: boolean; id: string; };

// --- Helper Function to ensure upload directory exists ---
async function ensureUploadDirExists(subDir: string, userId: string): Promise<string> {
    const userDirPath = path.join(process.cwd(), 'public', 'uploads', subDir, userId);
    try {
        await fs.mkdir(userDirPath, { recursive: true });
        // console.log(`Ensured directory exists: ${userDirPath}`); // Keep commented unless debugging
        return userDirPath;
    } catch (error) {
        console.error(`Error creating upload directory (${subDir}):`, error);
        throw new Error(`Could not create upload directory for ${subDir}.`);
    }
}

// --- Helper Function for safe file deletion ---
async function safeDeleteFile(filePath: string | null | undefined) {
    if (!filePath || !filePath.startsWith('/uploads/')) {
        // console.log(`Skipping deletion for invalid or non-local path: ${filePath}`);
        return; // Skip invalid or non-local paths
    }
    try {
        const localFilePath = path.join(process.cwd(), 'public', filePath);
        await fs.unlink(localFilePath);
        console.log(`Successfully deleted file: ${localFilePath}`);
    } catch (error: any) {
        // Log error if file not found (ENOENT) or other issues, but don't throw
        if (error.code === 'ENOENT') {
            console.warn(`File not found during deletion attempt: ${filePath}`);
        } else {
            console.error(`Error deleting file ${filePath}:`, error.message);
        }
    }
}

// --- Helper Function to upload a file ---
async function uploadFile(
    file: File,
    userId: string,
    subDir: string
): Promise<string> { // Returns the relative URL path
    try {
        // Basic validation within upload function as well
        const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB
        const ALLOWED_TYPES = ['application/pdf', 'image/png', 'image/jpeg', 'image/jpg'];
        if (file.size > MAX_FILE_SIZE) { throw new Error(`File size exceeds limit (${file.name}).`); }
        if (!ALLOWED_TYPES.includes(file.type)) { throw new Error(`Invalid file type (${file.name}).`); }

        const uploadDir = await ensureUploadDirExists(subDir, userId);
        const fileExtension = path.extname(file.name);
        const uniqueFilename = `${uuidv4()}${fileExtension}`;
        const localFilePath = path.join(uploadDir, uniqueFilename);
        const fileBuffer = Buffer.from(await file.arrayBuffer());
        await fs.writeFile(localFilePath, fileBuffer);
        const relativeUrl = `/uploads/${subDir}/${userId}/${uniqueFilename}`;
        console.log(`File uploaded successfully: ${relativeUrl}`);
        return relativeUrl;
    } catch (uploadError: any) {
        console.error(`Error uploading file (${file.name}):`, uploadError);
        // Re-throw a more specific error or the original one
        throw new Error(`Failed to upload file ${file.name}: ${uploadError.message}`);
    }
}


// --- Get Profile Data Action ---
interface GetUserProfileDataResponse {
    user: { id: string; name: string | null; email: string | null; role: string | null; } | null;
    academicQualifications: AcademicQualification[];
    professionalLicenses: ProfessionalLicense[];
    workExperiences: WorkExperience[];
    professionalAffiliations: ProfessionalAffiliation[];
    awardsRecognitions: AwardRecognition[];
    professionalDevelopments: ProfessionalDevelopment[];
    communityInvolvements: CommunityInvolvement[];
    publications: Publication[];
    conferencePresentations: ConferencePresentation[];
    error?: string;
}
export async function getMyProfileData(): Promise<GetUserProfileDataResponse> {
    const session = await getServerSession(authOptions);
    const userId = (session?.user as any)?.id;
    const defaultResponse: Omit<GetUserProfileDataResponse, 'user' | 'error'> = { academicQualifications: [], professionalLicenses: [], workExperiences: [], professionalAffiliations: [], awardsRecognitions: [], professionalDevelopments: [], communityInvolvements: [], publications: [], conferencePresentations: [], };
    if (!userId) { return { user: null, ...defaultResponse, error: 'Not authenticated' }; }
    try {
        const userWithProfile = await prisma.user.findUnique({
            where: { id: userId },
            include: {
                academicQualifications: { orderBy: { yearCompleted: 'desc' } },
                professionalLicenses: { orderBy: { expiration: 'desc' } },
                workExperiences: { orderBy: { createdAt: 'desc' } }, // Consider ordering by years if needed
                professionalAffiliations: { orderBy: { createdAt: 'desc' } },
                awardsRecognitions: { orderBy: { yearReceived: 'desc' } },
                professionalDevelopments: { orderBy: { createdAt: 'desc' } },
                communityInvolvements: { orderBy: { createdAt: 'desc' } },
                publications: { orderBy: { datePublished: 'desc' } },
                conferencePresentations: { orderBy: { createdAt: 'desc' } },
            },
        });
        if (!userWithProfile) { return { user: null, ...defaultResponse, error: 'User not found' }; }
        // Ensure all arrays are returned, even if null from Prisma
        return {
             user: { id: userWithProfile.id, name: userWithProfile.name, email: userWithProfile.email, role: userWithProfile.role },
             academicQualifications: userWithProfile.academicQualifications ?? [],
             professionalLicenses: userWithProfile.professionalLicenses ?? [],
             workExperiences: userWithProfile.workExperiences ?? [],
             professionalAffiliations: userWithProfile.professionalAffiliations ?? [],
             awardsRecognitions: userWithProfile.awardsRecognitions ?? [],
             professionalDevelopments: userWithProfile.professionalDevelopments ?? [],
             communityInvolvements: userWithProfile.communityInvolvements ?? [],
             publications: userWithProfile.publications ?? [],
             conferencePresentations: userWithProfile.conferencePresentations ?? [],
        };
    } catch (error) {
        console.error("Error fetching profile data:", error);
        return { user: null, ...defaultResponse, error: 'Failed to fetch profile data' };
    }
}

// --- Update Profile Action ---
interface UpdateProfileResponse { success: boolean; error?: string; }

export async function updateMyProfile(formData: FormData): Promise<UpdateProfileResponse> {
    'use server';
    const session = await getServerSession(authOptions);
    const userId = (session?.user as any)?.id;
    if (!userId) { return { success: false, error: 'Not authenticated' }; }
    console.log(`updateMyProfile called for user: ${userId}`);

    // --- Helper Function to Parse JSON Data ---
    function parseJsonData<T>(jsonString: string | null, arrayName: string): T[] {
        if (!jsonString) return [];
        try {
            const parsed = JSON.parse(jsonString);
            if (!Array.isArray(parsed)) throw new Error(`${arrayName} data is not an array`);
            return parsed;
        } catch (e: any) {
            console.error(`Error parsing ${arrayName} json:`, e);
            throw new Error(`Invalid ${arrayName} data format received.`); // Re-throw to fail transaction
        }
    }

    // Define upload subdirectories and URL field names for each model
    const uploadDirs: Record<string, string> = {
        academicQualifications: 'qualifications',
        professionalLicenses: 'licenses',
        workExperiences: 'workexp',
        professionalAffiliations: 'affiliations',
        awardsRecognitions: 'awards',
        professionalDevelopments: 'profdev',
        communityInvolvements: 'community',
        publications: 'publications',
        conferencePresentations: 'presentations'
    };
    const urlFieldNames: Record<string, keyof any> = {
        academicQualifications: 'diplomaFileUrl',
        professionalLicenses: 'licenseFileUrl',
        workExperiences: 'proofUrl',
        professionalAffiliations: 'membershipProofUrl',
        awardsRecognitions: 'certificateUrl',
        professionalDevelopments: 'certificateFileUrl',
        communityInvolvements: 'proofUrl',
        publications: 'pdfUrl',
        conferencePresentations: 'proofUrl'
    };
     // Define required fields for validation during creation
     const requiredFieldsMap: Record<string, string[]> = {
        academicQualifications: ['degree', 'institution', 'program', 'yearCompleted'],
        professionalLicenses: ['examination', 'monthYear', 'licenseNumber', 'expiration'],
        workExperiences: ['institution', 'position', 'inclusiveYears'],
        professionalAffiliations: ['organization', 'inclusiveYears'],
        awardsRecognitions: ['awardName', 'awardingBody', 'yearReceived'],
        professionalDevelopments: ['title', 'organizer', 'dateLocation'],
        communityInvolvements: ['engagementTitle', 'role', 'locationDate'],
        publications: ['researchTitle', 'journal', 'datePublished'],
        conferencePresentations: ['paperTitle', 'eventName', 'dateLocation']
    };


    let filesToDelete: (string | null | undefined)[] = [];
    let incomingData: Record<string, any[]> = {}; // Store parsed data

    try {
        // --- Extract and Parse JSON Data for ALL Sections ---
        incomingData.academicQualifications = parseJsonData<IncomingAcademicQualification>(formData.get('academicQualifications_json') as string | null, 'Academic Qualifications');
        incomingData.professionalLicenses = parseJsonData<IncomingProfessionalLicense>(formData.get('professionalLicenses_json') as string | null, 'Professional Licenses');
        incomingData.workExperiences = parseJsonData<IncomingWorkExperience>(formData.get('workExperiences_json') as string | null, 'Work Experience');
        incomingData.professionalAffiliations = parseJsonData<IncomingProfessionalAffiliation>(formData.get('professionalAffiliations_json') as string | null, 'Professional Affiliations');
        incomingData.awardsRecognitions = parseJsonData<IncomingAwardRecognition>(formData.get('awardsRecognitions_json') as string | null, 'Awards/Recognitions');
        incomingData.professionalDevelopments = parseJsonData<IncomingProfessionalDevelopment>(formData.get('professionalDevelopments_json') as string | null, 'Professional Development');
        incomingData.communityInvolvements = parseJsonData<IncomingCommunityInvolvement>(formData.get('communityInvolvements_json') as string | null, 'Community Involvement');
        incomingData.publications = parseJsonData<IncomingPublication>(formData.get('publications_json') as string | null, 'Publications');
        incomingData.conferencePresentations = parseJsonData<IncomingConferencePresentation>(formData.get('conferencePresentations_json') as string | null, 'Conference Presentations');

    } catch (error: any) {
        return { success: false, error: error.message }; // Return error if parsing fails
    }

    try {
        const result = await prisma.$transaction(async (tx) => {
            // --- Generic Processing Function ---
            async function processSection<TIncoming extends { id: string; _isNew?: boolean }, TPrisma extends { id: string }>(
                sectionKey: keyof typeof uploadDirs,
                prismaModel: any
            ) {
                const data = incomingData[sectionKey] as TIncoming[];
                if (!data) { console.warn(`No data found for section ${sectionKey}. Skipping.`); return; }
                console.log(`Processing section: ${sectionKey}`);

                const urlFieldName = urlFieldNames[sectionKey];
                const subDir = uploadDirs[sectionKey];
                const requiredFields = requiredFieldsMap[sectionKey] || [];

                // 1. Fetch Current Data
                const currentItems = await prismaModel.findMany({ where: { userId: userId }, select: { id: true, [urlFieldName]: true } });
                const currentItemMap = new Map(currentItems.map((item: any) => [item.id, item]));
                const incomingIds = new Set(data.map(item => item.id));
                const idsToDeleteInternal: string[] = [];

                // 2. Identify & Schedule Deletions
                for (const currentItem of currentItems) {
                    if (!incomingIds.has(currentItem.id)) {
                        idsToDeleteInternal.push(currentItem.id);
                        // --- FIX: Use 'as any' for index access ---
                        if (urlFieldName && (currentItem as any)[urlFieldName]) {
                             filesToDelete.push((currentItem as any)[urlFieldName]);
                        }
                    }
                }
                // 3. Perform Deletions
                if (idsToDeleteInternal.length > 0) { console.log(`Deleting ${sectionKey} records:`, idsToDeleteInternal); await prismaModel.deleteMany({ where: { id: { in: idsToDeleteInternal }, userId: userId } }); }

                // 4. Process Creates and Updates
                for (const incomingItem of data) {
                    const fileKey = `${sectionKey}_file_${incomingItem.id}`;
                    const file = formData.get(fileKey) as File | null;
                    let uploadedFileUrl: string | null | undefined = undefined;

                    if (file) { console.log(`File found for ${sectionKey} item ${incomingItem.id}: ${file.name}`); uploadedFileUrl = await uploadFile(file, userId, subDir); }

                    const { _isNew, id, ...dataForPrisma } = incomingItem as any;
                    Object.keys(dataForPrisma).forEach(key => {
                        const value = dataForPrisma[key];
                        if (['expiration', 'datePublished'].includes(key) && typeof value === 'string') { try { const parsedDate = new Date(value); dataForPrisma[key] = !isNaN(parsedDate.getTime()) ? parsedDate : null; } catch { dataForPrisma[key] = null; } }
                        if (['yearCompleted', 'yearReceived'].includes(key) && typeof value === 'string') { const num = parseInt(value, 10); dataForPrisma[key] = isNaN(num) ? null : num; }
                        if (typeof value === 'string' && value.trim() === '' && !requiredFields.includes(key)) { dataForPrisma[key] = null; }
                    });
                    dataForPrisma.userId = userId;
                    if (uploadedFileUrl !== undefined) { dataForPrisma[urlFieldName] = uploadedFileUrl; }

                    if (_isNew) {
                        console.log(`Attempting create for ${sectionKey} - ID: ${id}`);
                        for (const field of requiredFields) { if (dataForPrisma[field] === null || dataForPrisma[field] === undefined || dataForPrisma[field] === '') { throw new Error(`Missing required field "${field}" for new ${sectionKey}.`); } }
                        await prismaModel.create({ data: dataForPrisma }); console.log(`Created ${sectionKey} item.`);
                    } else {
                        const currentItem = currentItemMap.get(id);
                        if (!currentItem) { console.warn(`${sectionKey} Update: ID ${id} not found. Skipping.`); continue; }
                        const updateData: Partial<any> = {}; let needsDbUpdate = false;

                        Object.keys(dataForPrisma).forEach(key => {
                            if (key !== 'userId' && key !== 'createdAt' && key !== 'updatedAt') {
                                const incomingValue = dataForPrisma[key];
                                // --- FIX: Use 'as any' for index access ---
                                const currentValue = (currentItem as any)[key];
                                if (incomingValue instanceof Date) {
                                    // --- FIX: Ensure currentValue is also treated as Date for comparison ---
                                    if (!(currentValue instanceof Date) || incomingValue.getTime() !== (currentValue as Date)?.getTime()) {
                                        updateData[key] = incomingValue; needsDbUpdate = true;
                                    }
                                } else if (incomingValue !== currentValue) {
                                    updateData[key] = incomingValue; needsDbUpdate = true;
                                }
                           }
                       });

                        if (needsDbUpdate) {
                            console.log(`Updating ${sectionKey} ID: ${id}`);
                            // --- FIX: Use 'as any' for index access ---
                            if (urlFieldName && dataForPrisma[urlFieldName] !== (currentItem as any)[urlFieldName] && (currentItem as any)[urlFieldName]) {
                                console.log(`Marking old file for deletion (update): ${(currentItem as any)[urlFieldName]}`);
                                filesToDelete.push((currentItem as any)[urlFieldName]);
                            }
                            await prismaModel.update({ where: { id: id, userId: userId }, data: updateData });
                        }
                    }
                }
            }

            // --- Process ALL Sections ---
            await processSection('academicQualifications', tx.academicQualification);
            await processSection('professionalLicenses', tx.professionalLicense);
            await processSection('workExperiences', tx.workExperience);
            await processSection('professionalAffiliations', tx.professionalAffiliation);
            await processSection('awardsRecognitions', tx.awardRecognition);
            await processSection('professionalDevelopments', tx.professionalDevelopment);
            await processSection('communityInvolvements', tx.communityInvolvement);
            await processSection('publications', tx.publication);
            await processSection('conferencePresentations', tx.conferencePresentation);

            return { success: true }; // Transaction successful
        }); // End transaction

        // --- Perform File Deletions (Outside Transaction) ---
        if (result.success && filesToDelete.length > 0) {
            const uniqueFilesToDelete = [...new Set(filesToDelete.filter(f => f))]; // Ensure uniqueness and filter nulls
            console.log("Attempting file deletions post-transaction:", uniqueFilesToDelete);
            await Promise.all(uniqueFilesToDelete.map(fileUrl => safeDeleteFile(fileUrl)));
        }

        // Revalidate Path
        if (result.success) {
            revalidatePath('/profile');
            console.log("Profile revalidated.");
        }

        return { success: result.success };

    } catch (error: any) {
        console.error("Error in updateMyProfile transaction or file deletion:", error);
        // NOTE: Files uploaded *before* the transaction failed might be orphaned.
        // Implementing cleanup for this is complex and often handled by background jobs.
        return { success: false, error: error.message || 'Failed to update profile data' };
    }
}

/*
// --- Deprecated Add Qualification Action ---
interface AddQualificationResponse { success: boolean; qualification?: AcademicQualification; error?: string; }
export async function addMyQualification(formData: FormData): Promise<AddQualificationResponse> {
    // ... (implementation using uploadFile and prisma.create)
    // Consider removing or marking as deprecated
     return { success: false, error: 'This action is deprecated. Use updateMyProfile.' };
}

// --- Deprecated Delete Qualification Action ---
interface DeleteQualificationResponse { success: boolean; error?: string; }
export async function deleteMyQualification(qualificationId: string): Promise<DeleteQualificationResponse> {
    // ... (implementation using prisma.findUnique, safeDeleteFile, prisma.delete)
    // Consider removing or marking as deprecated
     return { success: false, error: 'This action is deprecated. Use updateMyProfile.' };
}
*/


--- END FILE: src\lib\userActions.ts ---

--- START FILE: src\lib\utils.ts ---
[EMPTY FILE]

--- END FILE: src\lib\utils.ts ---

--- START FILE: src\types\index.ts ---
// src/types/index.ts
import type {
    AcademicQualification, ProfessionalLicense, WorkExperience,
    ProfessionalAffiliation, AwardRecognition, ProfessionalDevelopment,
    CommunityInvolvement, Publication, ConferencePresentation
} from '@/generated/prisma'; // Adjust path if your generated client is elsewhere

// Common temporary properties used during editing state
export type TempCommon = {
    _isNew?: boolean; // Flag to indicate if the item was added locally
    id: string;      // Needs ID (can be temporary UUID for new items or real ID for existing)
};

// Specific temporary types for each section
// Add _selectedFile property to ALL types that now handle file uploads locally
export type TempAcademicQualification = AcademicQualification & TempCommon & { _selectedFile?: File | null; };
export type TempProfessionalDevelopment = ProfessionalDevelopment & TempCommon & { _selectedFile?: File | null; };
export type TempProfessionalLicense = ProfessionalLicense & TempCommon & { _selectedFile?: File | null; };
export type TempWorkExperience = WorkExperience & TempCommon & { _selectedFile?: File | null; };
export type TempProfessionalAffiliation = ProfessionalAffiliation & TempCommon & { _selectedFile?: File | null; };
export type TempAwardRecognition = AwardRecognition & TempCommon & { _selectedFile?: File | null; };
export type TempCommunityInvolvement = CommunityInvolvement & TempCommon & { _selectedFile?: File | null; };
export type TempPublication = Publication & TempCommon & { _selectedFile?: File | null; };
export type TempConferencePresentation = ConferencePresentation & TempCommon & { _selectedFile?: File | null; };

// Union type representing any possible item within the editableData state arrays
export type EditableItem =
    | TempAcademicQualification
    | TempProfessionalLicense
    | TempWorkExperience
    | TempProfessionalAffiliation
    | TempAwardRecognition
    | TempProfessionalDevelopment
    | TempCommunityInvolvement
    | TempPublication
    | TempConferencePresentation;

// You can add other shared application-wide types here as needed
// e.g., export type AdminViewFaculty = { ... };


--- END FILE: src\types\index.ts ---

