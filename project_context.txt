--- START FILE: .gitignore ---
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/versions

# testing
/coverage

# Local Uploads (Development Only!)
/public/uploads/

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# env files (can opt-in for committing if needed)
.env*

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts


--- END FILE: .gitignore ---

--- START FILE: eslint.config.mjs ---
import { dirname } from "path";
import { fileURLToPath } from "url";
import { FlatCompat } from "@eslint/eslintrc";

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const compat = new FlatCompat({
  baseDirectory: __dirname,
});

const eslintConfig = [
  ...compat.extends("next/core-web-vitals", "next/typescript"),
];

export default eslintConfig;


--- END FILE: eslint.config.mjs ---

--- START FILE: next-env.d.ts ---
/// <reference types="next" />
/// <reference types="next/image-types/global" />

// NOTE: This file should not be edited
// see https://nextjs.org/docs/app/api-reference/config/typescript for more information.


--- END FILE: next-env.d.ts ---

--- START FILE: next.config.ts ---
// next.config.ts
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  // The 'images' configuration block
  images: {
    // Keep your existing SVG settings if needed
    dangerouslyAllowSVG: true,
    contentSecurityPolicy: "default-src 'self'; script-src 'none'; sandbox;",

    // Configure allowed external image domains here
    remotePatterns: [
      // Keep existing patterns if you still need them (e.g., for ucarecdn)
      {
        protocol: 'https',
        hostname: 'ucarecdn.com', // Google logo source
        port: '',
        pathname: '/**', // Allow any path on this host
      },

      // --- THIS IS THE NEW PATTERN YOU NEED TO ADD ---
      {
        protocol: 'https',                // Protocol used by the site (usually https)
        hostname: 'www.spcdavao.edu.ph',  // The specific domain name
        port: '',                         // Leave empty for default ports (80/443)
        pathname: '/wp-content/uploads/**', // Allow images specifically from the uploads path
                                          // Using '/**' would allow any path, '/wp-content/uploads/**' is slightly more specific/secure
      },
      // --- END OF NEW PATTERN ---

      // Add any other domains you might need here in the future
    ],
  },
  // Add other Next.js configurations here if you have them (e.g., reactStrictMode)
};

// Export the configuration object
export default nextConfig;


--- END FILE: next.config.ts ---

--- START FILE: package.json ---
{
  "name": "smls-sfms",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint"
  },
  "dependencies": {
    "@heroicons/react": "^2.2.0",
    "@next-auth/prisma-adapter": "^1.0.7",
    "@prisma/client": "^6.6.0",
    "bcrypt": "^5.1.1",
    "next": "15.3.1",
    "next-auth": "^4.24.11",
    "react": "^19.0.0",
    "react-dom": "^19.0.0",
    "uuid": "^11.1.0"
  },
  "devDependencies": {
    "@eslint/eslintrc": "^3",
    "@types/bcrypt": "^5.0.2",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "@types/uuid": "^10.0.0",
    "autoprefixer": "^10.4.21",
    "eslint": "^9",
    "eslint-config-next": "15.3.1",
    "postcss": "^8.5.3",
    "prisma": "^6.6.0",
    "tailwindcss": "^3.4.17",
    "typescript": "^5"
  }
}


--- END FILE: package.json ---

--- START FILE: postcss.config.mjs ---
// postcss.config.mjs (Using export default for ES Module compatibility)
const config = {
  plugins: {
    tailwindcss: {}, // For v3
    autoprefixer: {}, // For v3
  }
};
export default config; // Use export default


--- END FILE: postcss.config.mjs ---

--- START FILE: README.md ---
# SMLS-SFMS: Automated Skills and Faculty Management System


To develop an automated system for managing faculty CVs, skills, credentials, and documents for the School of Medical Laboratory Science (SMLS) at San Pedro College, replacing manual processes.

## TECHS USED

*   **Framework:** Next.js (App Router)
*   **Language:** TypeScript
*   **Styling:** Tailwind CSS (v3)
*   **Database:** SQLite (via Prisma)
*   **Authentication:** NextAuth.js (Credentials, Prisma Adapter)

##

## Current STATUS

*   Core project setup complete.
*   Authentication (Login, Roles, Route Protection) implemented.
*   Faculty profile page allows viewing data.
*   Edit mode for profile implemented with local state management.
*   Basic Add/Delete/Save (including file uploads/deletes for new items) functional for **Academic Qualifications** section via server actions and FormData.
*   Other sections and Admin features are under development.


--- END FILE: README.md ---

--- START FILE: tailwind.config.ts ---
// tailwind.config.ts (Should be okay for v3)
import type { Config } from 'tailwindcss'

const config: Config = {
  content: [
    './src/pages/**/*.{js,ts,jsx,tsx,mdx}',
    './src/components/**/*.{js,ts,jsx,tsx,mdx}',
    './src/app/**/*.{js,ts,jsx,tsx,mdx}',
  ],
  theme: {
    extend: {
      // Keep extensions minimal for now
    },
  },
  plugins: [],
}
export default config


--- END FILE: tailwind.config.ts ---

--- START FILE: tsconfig.json ---
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  "exclude": ["node_modules"]
}


--- END FILE: tsconfig.json ---

--- START FILE: prisma\schema.prisma ---
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Define the possible roles for users
enum Role {
  FACULTY
  ADMIN
}

// Define the User model
model User {
  id        String   @id @default(cuid()) // Unique ID for the user (using cuid)
  name      String?                       // User's name (optional for now)
  email     String   @unique                 // User's email, must be unique
  password  String                        // Hashed password (we will hash it before saving)
  role      Role     @default(FACULTY)     // User's role (defaults to FACULTY)
  createdAt DateTime @default(now())         // Timestamp when the user was created
  updatedAt DateTime @updatedAt            // Timestamp when the user was last updated

  // --- Relationships to CV Models (One User has Many...) ---
  academicQualifications AcademicQualification[]
  professionalLicenses   ProfessionalLicense[]
  workExperiences        WorkExperience[]
  professionalAffiliations ProfessionalAffiliation[]
  awardsRecognitions     AwardRecognition[]
  professionalDevelopments ProfessionalDevelopment[]
  communityInvolvements  CommunityInvolvement[]
  publications           Publication[]
  conferencePresentations ConferencePresentation[]
  // --- End Relationships ---
}

// --- CV Related Models ---

model AcademicQualification {
  id          String   @id @default(cuid())
  degree      String
  institution String
  program     String
  yearCompleted Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // --- ADDED FIELD for supporting document ---
  diplomaFileUrl String? // Optional field to store URL/path of uploaded diploma/transcript
}

model ProfessionalLicense {
  id          String   @id @default(cuid())
  examination String   // e.g., "Medical Technologist Licensure Examination"
  monthYear   String   // e.g., "August 2023" (Consider DateTime if precise date needed)
  licenseNumber String @unique // License number should be unique
  expiration  DateTime // Date the license expires
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relation to User
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model WorkExperience {
  id         String   @id @default(cuid())
  institution String   // e.g., "San Pedro College", "Davao Doctors Hospital"
  position   String   // e.g., "Faculty", "Medical Technologist"
  natureOfWork String?  // Optional description
  inclusiveYears String // e.g., "2020-Present", "2018-2020" (Consider start/end Dates if needed)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relation to User
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ProfessionalAffiliation {
  id        String   @id @default(cuid())
  organization String // e.g., "PAMET", "PASMETH"
  position  String?  // Optional: "Member", "Officer", etc.
  inclusiveYears String // e.g., "2019-Present"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relation to User
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model AwardRecognition {
  id             String   @id @default(cuid())
  awardName      String   // Name of the award/recognition
  awardingBody   String   // Organization/Institution that gave the award
  yearReceived   Int      // Year the award was received
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

   // Relation to User
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ProfessionalDevelopment {
  id          String   @id @default(cuid())
  title       String
  organizer   String
  dateLocation String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

   // --- ADDED FIELD for supporting document ---
  certificateFileUrl String? // Optional field to store URL/path of uploaded certificate
}

model CommunityInvolvement {
  id          String   @id @default(cuid())
  engagementTitle String // e.g., "Medical Mission Barangay X", "Blood Donation Drive"
  role        String   // e.g., "Volunteer", "Organizer"
  locationDate String  // e.g., "Barangay X / May 5, 2024"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

   // Relation to User
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// --- Research Related Models ---
model Publication {
  id            String   @id @default(cuid())
  researchTitle String
  journal       String   // Name of the journal
  datePublished DateTime // Date of publication
  // Optional fields: volume, issue, pages, DOI, link etc.
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

   // Relation to User
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ConferencePresentation {
  id            String   @id @default(cuid())
  paperTitle    String
  eventName     String   // Name of the conference/event
  dateLocation  String   // e.g., "June 2024 / Manila"
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relation to User
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// --- Add other models below as needed ---

--- START FILE: prisma\migrations\migration_lock.toml ---
# Please do not edit this file manually
# It should be added in your version-control system (e.g., Git)
provider = "sqlite"


--- END FILE: prisma\migrations\migration_lock.toml ---

--- START FILE: prisma\migrations\20250426170451_init_user_model\migration.sql ---
-- CreateTable
CREATE TABLE "User" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "name" TEXT,
    "email" TEXT NOT NULL,
    "password" TEXT NOT NULL,
    "role" TEXT NOT NULL DEFAULT 'FACULTY',
    "createdAt" DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" DATETIME NOT NULL
);

-- CreateIndex
CREATE UNIQUE INDEX "User_email_key" ON "User"("email");


--- END FILE: prisma\migrations\20250426170451_init_user_model\migration.sql ---

--- START FILE: prisma\migrations\20250427041822_add_cv_models\migration.sql ---
-- CreateTable
CREATE TABLE "AcademicQualification" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "degree" TEXT NOT NULL,
    "institution" TEXT NOT NULL,
    "program" TEXT NOT NULL,
    "yearCompleted" INTEGER NOT NULL,
    "createdAt" DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" DATETIME NOT NULL,
    "userId" TEXT NOT NULL,
    CONSTRAINT "AcademicQualification_userId_fkey" FOREIGN KEY ("userId") REFERENCES "User" ("id") ON DELETE CASCADE ON UPDATE CASCADE
);

-- CreateTable
CREATE TABLE "ProfessionalLicense" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "examination" TEXT NOT NULL,
    "monthYear" TEXT NOT NULL,
    "licenseNumber" TEXT NOT NULL,
    "expiration" DATETIME NOT NULL,
    "createdAt" DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" DATETIME NOT NULL,
    "userId" TEXT NOT NULL,
    CONSTRAINT "ProfessionalLicense_userId_fkey" FOREIGN KEY ("userId") REFERENCES "User" ("id") ON DELETE CASCADE ON UPDATE CASCADE
);

-- CreateTable
CREATE TABLE "WorkExperience" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "institution" TEXT NOT NULL,
    "position" TEXT NOT NULL,
    "natureOfWork" TEXT,
    "inclusiveYears" TEXT NOT NULL,
    "createdAt" DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" DATETIME NOT NULL,
    "userId" TEXT NOT NULL,
    CONSTRAINT "WorkExperience_userId_fkey" FOREIGN KEY ("userId") REFERENCES "User" ("id") ON DELETE CASCADE ON UPDATE CASCADE
);

-- CreateTable
CREATE TABLE "ProfessionalAffiliation" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "organization" TEXT NOT NULL,
    "position" TEXT,
    "inclusiveYears" TEXT NOT NULL,
    "createdAt" DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" DATETIME NOT NULL,
    "userId" TEXT NOT NULL,
    CONSTRAINT "ProfessionalAffiliation_userId_fkey" FOREIGN KEY ("userId") REFERENCES "User" ("id") ON DELETE CASCADE ON UPDATE CASCADE
);

-- CreateTable
CREATE TABLE "AwardRecognition" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "awardName" TEXT NOT NULL,
    "awardingBody" TEXT NOT NULL,
    "yearReceived" INTEGER NOT NULL,
    "createdAt" DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" DATETIME NOT NULL,
    "userId" TEXT NOT NULL,
    CONSTRAINT "AwardRecognition_userId_fkey" FOREIGN KEY ("userId") REFERENCES "User" ("id") ON DELETE CASCADE ON UPDATE CASCADE
);

-- CreateTable
CREATE TABLE "ProfessionalDevelopment" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "title" TEXT NOT NULL,
    "organizer" TEXT NOT NULL,
    "dateLocation" TEXT NOT NULL,
    "createdAt" DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" DATETIME NOT NULL,
    "userId" TEXT NOT NULL,
    CONSTRAINT "ProfessionalDevelopment_userId_fkey" FOREIGN KEY ("userId") REFERENCES "User" ("id") ON DELETE CASCADE ON UPDATE CASCADE
);

-- CreateTable
CREATE TABLE "CommunityInvolvement" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "engagementTitle" TEXT NOT NULL,
    "role" TEXT NOT NULL,
    "locationDate" TEXT NOT NULL,
    "createdAt" DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" DATETIME NOT NULL,
    "userId" TEXT NOT NULL,
    CONSTRAINT "CommunityInvolvement_userId_fkey" FOREIGN KEY ("userId") REFERENCES "User" ("id") ON DELETE CASCADE ON UPDATE CASCADE
);

-- CreateTable
CREATE TABLE "Publication" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "researchTitle" TEXT NOT NULL,
    "journal" TEXT NOT NULL,
    "datePublished" DATETIME NOT NULL,
    "createdAt" DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" DATETIME NOT NULL,
    "userId" TEXT NOT NULL,
    CONSTRAINT "Publication_userId_fkey" FOREIGN KEY ("userId") REFERENCES "User" ("id") ON DELETE CASCADE ON UPDATE CASCADE
);

-- CreateTable
CREATE TABLE "ConferencePresentation" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "paperTitle" TEXT NOT NULL,
    "eventName" TEXT NOT NULL,
    "dateLocation" TEXT NOT NULL,
    "createdAt" DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" DATETIME NOT NULL,
    "userId" TEXT NOT NULL,
    CONSTRAINT "ConferencePresentation_userId_fkey" FOREIGN KEY ("userId") REFERENCES "User" ("id") ON DELETE CASCADE ON UPDATE CASCADE
);

-- CreateIndex
CREATE UNIQUE INDEX "ProfessionalLicense_licenseNumber_key" ON "ProfessionalLicense"("licenseNumber");


--- END FILE: prisma\migrations\20250427041822_add_cv_models\migration.sql ---

--- START FILE: prisma\migrations\20250427044318_add_document_url_fields\migration.sql ---
-- AlterTable
ALTER TABLE "AcademicQualification" ADD COLUMN "diplomaFileUrl" TEXT;

-- AlterTable
ALTER TABLE "ProfessionalDevelopment" ADD COLUMN "certificateFileUrl" TEXT;


--- END FILE: prisma\migrations\20250427044318_add_document_url_fields\migration.sql ---

--- START FILE: src\middleware.ts ---
// src/middleware.ts
import { withAuth } from "next-auth/middleware";
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';
import type { JWT } from "next-auth/jwt"; // Import JWT type if needed

// Export the default middleware function configured with withAuth
export default withAuth(
    // `withAuth` augments your `Request` with the user's token.
    function middleware(req) {
        // This function runs ONLY if the user is authenticated (token exists)
        // console.log("Token in middleware:", req.nextauth.token); // Log token for debugging

        const token = req.nextauth.token as JWT & { role?: string }; // Cast token to access custom properties
        const { pathname } = req.nextUrl; // Get the requested path

        // --- Role-Based Access Control ---
        // If user is trying to access an admin route
        if (pathname.startsWith('/admin')) {
            // Check if the user has the ADMIN role
            if (token?.role !== 'ADMIN') {
                // If not admin, redirect them (e.g., to faculty dashboard or an unauthorized page)
                console.warn(`Unauthorized access attempt to ${pathname} by user role: ${token?.role}`);
                 // Redirect non-admins away from /admin routes
                 // Option 1: Redirect to faculty dashboard
                 return NextResponse.redirect(new URL('/dashboard', req.url));
                 // Option 2: Redirect to a specific 'unauthorized' page (if you create one)
                 // return NextResponse.redirect(new URL('/unauthorized', req.url));
            }
            // If user is ADMIN and accessing /admin, allow the request
             return NextResponse.next(); // Continue processing the request
        }

        // --- General Authenticated Access ---
        // For any other authenticated route (like /dashboard, /profile, /documents)
        // If the user is authenticated (which they are if this function runs),
        // allow the request to proceed.
        // You could add checks here if FACULTY role is explicitly required for /dashboard etc.
        // if (pathname.startsWith('/dashboard') || pathname.startsWith('/profile') /*...*/) {
        //    if (token?.role !== 'FACULTY' && token?.role !== 'ADMIN') { // Example check
        //        return NextResponse.redirect(new URL('/unauthorized', req.url));
        //    }
        // }

        // Allow the request to proceed for authenticated users on non-admin routes covered by the matcher
        return NextResponse.next();
    },
    {
        callbacks: {
            // This callback determines IF the middleware function above runs.
            // It runs if the token exists (user is logged in).
            authorized: ({ token }) => !!token // !! converts truthy/falsy value to boolean
        },
        pages: {
            // Use the same signIn page as defined in your authOptions
            signIn: "/login",
            // You could add an error page if needed
            // error: "/auth/error",
        },
    }
);

// --- Route Matching ---
// Specifies which paths this middleware should run on.
export const config = {
    matcher: [
        /*
         * Match all request paths except for the ones starting with:
         * - api (API routes including /api/auth)
         * - _next/static (static files)
         * - _next/image (image optimization files)
         * - favicon.ico (favicon file)
         * - /login (the login page itself)
         * - / (the public homepage, if desired - remove if homepage needs auth)
         */
        '/((?!api|_next/static|_next/image|favicon.ico|login).*)',
        // Explicitly include top-level protected routes if needed and not covered above
        '/dashboard/:path*', // Match /dashboard and any sub-paths
        '/profile/:path*',   // Match /profile and any sub-paths
        '/documents/:path*', // Match /documents and any sub-paths
        '/admin/:path*',     // Match /admin and any sub-paths
    ],
};


--- END FILE: src\middleware.ts ---

--- START FILE: src\app\globals.css ---
/* src/app/globals.css (Updated for v3) */
@tailwind base;
@tailwind components;
@tailwind utilities;

/* Add minimal body styling */
body {
   font-family: sans-serif; /* Basic default font */
   /* Add other base styles if needed */
}


--- END FILE: src\app\globals.css ---

--- START FILE: src\app\layout.tsx ---
// src/app/layout.tsx
import "./globals.css"; // Ensure this is imported EARLY
import type { Metadata } from "next";
import NextAuthProvider from "@/components/providers/NextAuthProvider";
// Removed font imports/setup

export const metadata: Metadata = {
  title: "SMLS-SFMS",
  description: "Skills and Faculty Management System",
};

export default function RootLayout({ children }: Readonly<{ children: React.ReactNode; }>) {
  return (
    <html lang="en">
      {/* Simple body tag, no custom font classes */}
      <body>
         <NextAuthProvider>
           <main>{children}</main>
         </NextAuthProvider>
      </body>
    </html>
  );
}


--- END FILE: src\app\layout.tsx ---

--- START FILE: src\app\page.tsx ---
// src/app/page.tsx
'use client'; // Needs to be a client component to use the hook

import React from 'react';
import { useSession, signIn, signOut } from 'next-auth/react';
import Link from 'next/link'; // Import Link

export default function HomePage() {
    // Use the useSession hook to get session data
    const { data: session, status } = useSession();

    // status can be 'loading', 'authenticated', or 'unauthenticated'

    return (
        <div className="p-6">
            <h1 className="text-2xl font-semibold mb-4 text-[#003153]">Welcome to SMLS-SFMS!</h1>

            {status === 'loading' && (
                <p className="text-gray-500">Loading session...</p>
            )}

            {status === 'authenticated' && session?.user && (
                <div className="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4" role="alert">
                    <p>Signed in as: <strong>{session.user.email}</strong></p>
                    {/* We added 'role' to the session in authOptions callbacks */}
                    <p>Role: <strong>{(session.user as any).role}</strong></p>
                    <button
                        onClick={() => signOut()} // Call signOut from next-auth/react
                        className="mt-2 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded shadow"
                    >
                        Sign Out
                    </button>
                </div>
            )}

            {status === 'unauthenticated' && (
                 <div className="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded relative mb-4" role="alert">
                    <p>You are not signed in.</p>
                    <Link href="/login"> {/* Use Link for client-side navigation */}
                       <button
                          className="mt-2 px-4 py-2 bg-[#003153] hover:bg-[#002742] text-white rounded shadow"
                       >
                           Sign In
                       </button>
                    </Link>
                 </div>
            )}

             <p className="mt-4">This is the homepage content.</p>
             {/* We can add links to other sections later */}

        </div>
    );
}


--- END FILE: src\app\page.tsx ---

--- START FILE: src\app\(auth)\layout.tsx ---
export const metadata = {
  title: 'Next.js',
  description: 'Generated by Next.js',
}

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="en">
      <body>{children}</body>
    </html>
  )
}


--- END FILE: src\app\(auth)\layout.tsx ---

--- START FILE: src\app\(auth)\login\page.tsx ---
'use client';
import React, { useState, FormEvent } from 'react';
import { signIn, getSession } from 'next-auth/react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import Image from 'next/image'; // Ensure next/image is imported

export default function LoginPage() {
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [error, setError] = useState<string | null>(null);
    const [isLoading, setIsLoading] = useState(false);
    const router = useRouter();

    // Handler for credential-based form submission (remains the same)
    const handleSubmit = async (event: FormEvent<HTMLFormElement>) => {
        // ... (submission logic remains the same)
        event.preventDefault();
        setError(null);
        setIsLoading(true);
        try {
            const result = await signIn('credentials', {
                redirect: false,
                email,
                password,
            });

            if (result?.error) {
                setIsLoading(false);
                setError("Invalid email or password. Please try again.");
                console.error("SignIn Error:", result.error);
            } else if (result?.ok) {
                const session = await getSession();
                const userRole = (session?.user as any)?.role;
                console.log("Login successful, Role:", userRole);
                router.push(userRole === 'ADMIN' ? '/admin/dashboard' : '/dashboard');
            } else {
                setIsLoading(false);
                setError("Login failed due to an unknown error. Please try again.");
                console.error("SignIn Unknown State:", result);
            }
        } catch (err) {
            setIsLoading(false);
            setError("An unexpected error occurred. Please check your connection and try again.");
            console.error("Login Catch Error:", err);
        }
    };

    // Placeholder handler for Google Sign-In button (remains the same)
    const handleGoogleSignIn = () => {
       alert("Google Sign-In is not configured yet.");
    }

    return (
        // Main container: Apply gradient background
        <div className="flex min-h-screen w-full items-center justify-center bg-gradient-to-br from-sky-100 to-blue-200 px-4 py-8 font-poppins">

            {/* Wrapper for the three-column layout on larger screens */}
            <div className="flex w-full max-w-6xl items-center justify-center lg:justify-between">

                 {/* Left Column (SPC Logo): Hidden on screens smaller than 'lg' */}
                 <div className="hidden lg:flex lg:w-1/4 items-center justify-center p-4">
                     <Image
                        src="/spc-logo.png"
                        alt="San Pedro College Logo"
                        width={250}
                        height={300}
                        className="object-contain"
                    />
                 </div>

                 {/* Center Column (Login Form Card) */}
                 <div className="w-full max-w-md lg:w-1/2 lg:max-w-md lg:px-8 flex justify-center">
                     {/* Container for the card */}
                     <div className="w-full">
                         {/* Gradient border effect - Using softer blues */}
                         <div className="rounded-3xl bg-gradient-to-r from-sky-400 to-blue-500 p-1 shadow-2xl"> {/* Changed gradient, increased shadow */}
                             {/* Inner white card - Kept white for contrast */}
                            <div className="rounded-[22px] bg-white p-8 sm:p-10">

                                <h1 className="cursor-default pb-6 text-center text-4xl font-bold text-gray-800"> {/* Slightly lighter text */}
                                    Log in
                                </h1>

                                <form onSubmit={handleSubmit} className="space-y-5">
                                    {error && (
                                        <div className="rounded border border-red-300 bg-red-50 p-3 text-center text-sm font-medium text-red-700" role="alert">
                                            {error}
                                        </div>
                                    )}
                                    {/* Email Input */}
                                    <div>
                                        <label htmlFor="email" className="mb-1.5 block text-sm font-medium text-gray-600">Email</label> {/* Lighter label */}
                                        <input
                                            id="email" name="email" type="email" placeholder="Email" required disabled={isLoading}
                                            value={email} onChange={(e) => setEmail(e.target.value)}
                                            className="w-full rounded-lg border border-gray-300 px-3 py-2.5 text-base text-gray-700 placeholder-gray-400 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500 disabled:opacity-50" // Adjusted text color
                                        />
                                    </div>
                                    {/* Password Input */}
                                    <div>
                                        <label htmlFor="password" className="mb-1.5 block text-sm font-medium text-gray-600">Password</label> {/* Lighter label */}
                                        <input
                                            id="password" name="password" type="password" placeholder="Password" required disabled={isLoading}
                                            value={password} onChange={(e) => setPassword(e.target.value)}
                                            className="w-full rounded-lg border border-gray-300 px-3 py-2.5 text-base text-gray-700 placeholder-gray-400 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500 disabled:opacity-50" // Adjusted text color
                                        />
                                    </div>
                                    {/* Forget Password Link - Adjusted color */}
                                    <div className="text-right">
                                        <Link href="#" className="text-sm text-sky-600 hover:text-sky-700 hover:underline"> Forget your password? </Link>
                                    </div>
                                    {/* Submit Button - Matching softer gradient */}
                                    <button
                                        type="submit" disabled={isLoading}
                                        className="mt-6 w-full rounded-lg bg-gradient-to-r from-sky-500 to-blue-600 px-4 py-2.5 text-sm font-semibold uppercase tracking-wider text-white shadow-md transition duration-300 ease-in-out hover:from-sky-600 hover:to-blue-700 disabled:opacity-60 disabled:cursor-not-allowed"> {/* Changed gradient and hover */}
                                        {isLoading ? 'LOGGING IN...' : 'LOG IN'}
                                    </button>
                                </form>
                                {/* Sign Up - Adjusted color */}
                               <div className="mt-5 text-center text-sm">
                                    <span className="text-gray-500">Don't have an account?{' '}</span> {/* Lighter text */}
                                    <Link href="#" className="font-semibold text-sky-600 hover:text-sky-700 hover:underline"> Sign Up </Link>
                               </div>
                                {/* Separator - Adjusted color */}
                               <div className="my-6 flex items-center">
                                    <hr className="flex-grow border-t border-gray-300" /> {/* Slightly darker line */}
                                    <span className="px-2 text-xs font-medium text-gray-500 uppercase">OR CONTINUE WITH</span> {/* Darker text */}
                                    <hr className="flex-grow border-t border-gray-300" />
                               </div>
                                {/* Google Button - Kept neutral */}
                               <div className="flex justify-center">
                                    <button
                                        onClick={handleGoogleSignIn} disabled={isLoading} title="Sign in with Google"
                                        className="m-1 inline-flex items-center justify-center rounded-lg border border-gray-300 bg-white p-2 shadow-sm transition duration-300 ease-in-out hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-gray-400 disabled:opacity-60">
                                        <Image src="https://ucarecdn.com/8f25a2ba-bdcf-4ff1-b596-088f330416ef/" alt="Google" width={22} height={22} />
                                    </button>
                               </div>
                                {/* Terms - Adjusted color and link color */}
                                <div className="mt-6 text-center text-xs text-gray-500"> {/* Lighter text */}
                                    <p> By signing in, you agree to our{' '} <Link className="font-medium text-sky-600 hover:underline" href="#">Terms</Link> {' '}and{' '} <Link className="font-medium text-sky-600 hover:underline" href="#">Privacy Policy</Link>. </p>
                                </div>
                            </div> {/* End Inner Card */}
                        </div> {/* End Gradient Border */}
                    </div> {/* End Form Container */}
                 </div> {/* End Center Column */}

                 {/* Right Column (SMLS Logo): Hidden on screens smaller than 'lg' */}
                 <div className="hidden lg:flex lg:w-1/4 items-center justify-center p-4 relative">
                     {/* ... optional background ... */}
                     <div className="relative z-10">
                        <Image
                            src="/smls-logo.png"
                            alt="School of Medical Laboratory Science Logo"
                            width={200}
                            height={200}
                            className="object-contain"
                        />
                     </div>
                 </div>

             </div> {/* End Three-column Wrapper */}

        </div> // End Main Container
    );
}


--- END FILE: src\app\(auth)\login\page.tsx ---

--- START FILE: src\app\(faculty)\dashboard\page.tsx ---
// src/app/(faculty)/dashboard/page.tsx
'use client';
import Link from 'next/link';
import React from 'react';
import { useSession } from 'next-auth/react';

// Example: Using Heroicons (install @heroicons/react)
// npm install @heroicons/react
import {
    UserCircleIcon,
    DocumentTextIcon,
    CalendarDaysIcon,
    ArrowRightIcon
} from '@heroicons/react/24/outline'; // Using outline style

export default function FacultyDashboardPage() {
    const { data: session, status } = useSession();

    // --- Loading State ---
    if (status === 'loading') {
        return (
            <div className="flex min-h-[calc(100vh-4rem)] items-center justify-center p-6 bg-gray-50"> {/* Added bg */}
                {/* Basic Spinner Example */}
                <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                <p className="ml-3 text-gray-600">Loading dashboard...</p>
            </div>
        );
    }

    // --- Unauthenticated State ---
    if (status === 'unauthenticated') {
         return (
             <div className="flex h-screen flex-col items-center justify-center p-6 text-center bg-gray-50">
                 <p className="mb-4 text-xl font-semibold text-red-600">Access Denied</p>
                 <p className="mb-6 text-gray-700">You must be signed in to view this page.</p>
                 <Link href="/login">
                     <button className="inline-flex items-center gap-2 rounded-md bg-[#003153] px-5 py-2.5 text-sm font-medium text-white shadow-sm transition hover:bg-[#002742] focus:outline-none focus:ring-2 focus:ring-[#003153] focus:ring-offset-2">
                         Go to Login
                         <ArrowRightIcon className="h-4 w-4" />
                     </button>
                 </Link>
             </div>
        );
    }

    // --- Authenticated State ---
    const userRole = (session?.user as any)?.role;
    // More friendly greeting
    const greetingName = session?.user?.name ? session.user.name.split(' ')[0] : (session?.user?.email ?? 'Faculty Member');

    return (
        // Main container with background and padding
        <div className="min-h-[calc(100vh-4rem)] bg-gradient-to-br from-gray-50 to-blue-50 p-4 sm:p-6 lg:p-8">
            <div className="mx-auto max-w-7xl">
                {/* Header Section */}
                <div className="mb-8 rounded-lg bg-white p-6 shadow-sm">
                    <h1 className="text-2xl font-semibold leading-tight text-gray-800 sm:text-3xl">
                        Welcome back, {greetingName}!
                    </h1>
                    <p className="mt-1 text-sm text-gray-500">
                        Your central hub for managing skills and documents. (Role: {userRole || 'N/A'})
                    </p>
                </div>

                {/* Main Content Grid - More spacing */}
                <div className="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3">

                    {/* Profile Card - Refined styling */}
                    <Link href="/profile" className="group flex flex-col justify-between rounded-lg border border-transparent bg-white p-6 shadow-lg transition duration-300 ease-in-out hover:scale-[1.02] hover:shadow-blue-100 dark:bg-gray-800 dark:hover:shadow-blue-900/30">
                        <div>
                            <div className="mb-3 flex items-center gap-3">
                                <UserCircleIcon className="h-8 w-8 text-blue-600 dark:text-blue-400" />
                                <h2 className="text-xl font-semibold text-gray-800 dark:text-gray-100">
                                    My Profile
                                </h2>
                            </div>
                            <p className="text-sm text-gray-600 dark:text-gray-400">
                                View and manage your CV, qualifications, and personal details.
                            </p>
                        </div>
                        <div className="mt-4 flex items-center justify-end text-sm font-medium text-blue-600 dark:text-blue-400 group-hover:underline">
                            Go to Profile
                            <ArrowRightIcon className="ml-1 h-4 w-4 transition-transform duration-200 group-hover:translate-x-1" />
                        </div>
                    </Link>

                    {/* Documents Card - Refined styling */}
                     <Link href="/documents" className="group flex flex-col justify-between rounded-lg border border-transparent bg-white p-6 shadow-lg transition duration-300 ease-in-out hover:scale-[1.02] hover:shadow-green-100 dark:bg-gray-800 dark:hover:shadow-green-900/30">
                        <div>
                            <div className="mb-3 flex items-center gap-3">
                                <DocumentTextIcon className="h-8 w-8 text-green-600 dark:text-green-400" />
                                <h2 className="text-xl font-semibold text-gray-800 dark:text-gray-100">
                                    My Documents
                                </h2>
                            </div>
                            <p className="text-sm text-gray-600 dark:text-gray-400">
                                Upload, view, and manage your supporting credentials and files.
                            </p>
                        </div>
                        <div className="mt-4 flex items-center justify-end text-sm font-medium text-green-600 dark:text-green-400 group-hover:underline">
                            Manage Documents
                            <ArrowRightIcon className="ml-1 h-4 w-4 transition-transform duration-200 group-hover:translate-x-1" />
                        </div>
                     </Link>

                    {/* Upcoming Events Card - Refined styling */}
                     <div className="flex flex-col justify-between rounded-lg border border-transparent bg-white p-6 shadow-lg dark:bg-gray-800">
                        <div>
                            <div className="mb-3 flex items-center gap-3">
                                <CalendarDaysIcon className="h-8 w-8 text-purple-600 dark:text-purple-400" />
                                <h2 className="text-xl font-semibold text-gray-800 dark:text-gray-100">
                                    Upcoming Events
                                </h2>
                            </div>
                            <p className="text-sm text-gray-600 dark:text-gray-400">
                                View relevant seminars, deadlines, or faculty meetings.
                            </p>
                        </div>
                         <div className="mt-4 rounded-md border border-dashed border-gray-300 bg-gray-50 p-4 text-center text-sm italic text-gray-500 dark:border-gray-700 dark:bg-gray-700/50 dark:text-gray-400">
                             No upcoming events scheduled.
                         </div>
                    </div>

                     {/* Add more cards here following a similar pattern */}

                </div>
            </div>
        </div>
    );
}


--- END FILE: src\app\(faculty)\dashboard\page.tsx ---

--- START FILE: src\app\(faculty)\documents\page.tsx ---
// src/app/(faculty)/documents/page.tsx
'use client';

import React from 'react';
import { useSession } from 'next-auth/react';

// We might need specific types for document data later
// import type { DocumentData } from '@/types';

export default function DocumentsPage() {
    const { data: session, status } = useSession();

    if (status === 'loading') {
        return <div className="p-6">Loading documents page...</div>;
    }

    if (status === 'unauthenticated') {
        return <div className="p-6">Access Denied. Please sign in.</div>;
    }

    // Placeholder state for file handling (will expand later)
    // const [selectedFile, setSelectedFile] = useState<File | null>(null);
    // const [uploading, setUploading] = useState(false);
    // const [documents, setDocuments] = useState<DocumentData[]>([]); // To display existing docs

    // Placeholder function for upload logic
    const handleUpload = async (event: React.FormEvent) => {
        event.preventDefault();
        // TODO: Implement actual file upload logic
        // - Get file from state
        // - Validate file type/size
        // - Send file to a backend API route or Server Action
        // - Handle response (success/error)
        // - Update the list of documents
        alert('Upload functionality not implemented yet.');
    };

    return (
        <div className="p-6">
            <h1 className="mb-6 text-2xl font-semibold text-[#003153]">
                My Documents & Credentials
            </h1>

            {/* Section for Uploading New Documents */}
            <div className="mb-8 rounded border border-gray-200 bg-white p-6 shadow-md">
                <h2 className="mb-4 text-lg font-medium text-gray-800">Upload New Document</h2>
                <form onSubmit={handleUpload}>
                    <div className="mb-4">
                        <label htmlFor="documentFile" className="mb-2 block text-sm font-medium text-gray-700">
                            Select File (.pdf, .png, .jpg)
                        </label>
                        <input
                            type="file"
                            id="documentFile"
                            name="documentFile"
                            accept=".pdf,.png,.jpg,.jpeg" // Specify accepted formats
                            className="block w-full text-sm text-gray-500 file:mr-4 file:rounded file:border-0 file:bg-[#003153] file:px-4 file:py-2 file:text-white hover:file:bg-[#002742] disabled:opacity-50"
                            // onChange={(e) => setSelectedFile(e.target.files ? e.target.files[0] : null)}
                            required
                            disabled // Disable upload for now
                        />
                         {/* TODO: Add fields for document type/category (e.g., Academic, Seminar, Award) */}
                    </div>
                    <button
                        type="submit"
                        className="rounded bg-[#003153] px-4 py-2 text-white shadow hover:bg-[#002742] focus:outline-none focus:ring-2 focus:ring-[#003153] focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
                        disabled // Disable upload for now
                        // disabled={!selectedFile || uploading}
                    >
                        {/* {uploading ? 'Uploading...' : 'Upload Document'} */}
                        Upload Document (Coming Soon)
                    </button>
                </form>
            </div>

            {/* Section for Displaying Existing Documents */}
            <div className="rounded border border-gray-200 bg-white p-6 shadow-md">
                <h2 className="mb-4 text-lg font-medium text-gray-800">Uploaded Documents</h2>
                {/* TODO: Fetch and display list of user's documents */}
                <p className="text-gray-500">Your uploaded documents will appear here.</p>
                 {/* Example structure for later:
                 <ul className="space-y-2">
                    {documents.map((doc) => (
                        <li key={doc.id} className="flex justify-between items-center border-b pb-1">
                            <span>{doc.fileName} ({doc.category})</span>
                            <button className="text-red-500 hover:text-red-700 text-sm">Delete</button>
                        </li>
                    ))}
                </ul>
                */}
            </div>
        </div>
    );
}


--- END FILE: src\app\(faculty)\documents\page.tsx ---

--- START FILE: src\app\(faculty)\profile\page.tsx ---
// src/app/(faculty)/profile/page.tsx
'use client';

import React, { useState, useEffect, useCallback, useTransition, ChangeEvent } from 'react';
import { useSession } from 'next-auth/react';
import { getMyProfileData, updateMyProfile } from '@/lib/userActions';
// Import ALL relevant types from Prisma Client
import type {
    User, AcademicQualification, ProfessionalLicense, WorkExperience,
    ProfessionalAffiliation, AwardRecognition, ProfessionalDevelopment,
    CommunityInvolvement, Publication, ConferencePresentation
} from '@/generated/prisma';
// Import shared temporary types and Union type
import type {
    EditableItem, TempAcademicQualification, TempProfessionalDevelopment,
    TempProfessionalLicense, TempWorkExperience, TempProfessionalAffiliation,
    TempAwardRecognition, TempCommunityInvolvement, TempPublication, TempConferencePresentation
} from '@/types';
import {
    PlusIcon, PencilSquareIcon, XCircleIcon, CheckCircleIcon, AcademicCapIcon, BriefcaseIcon,
    IdentificationIcon, StarIcon, SparklesIcon, UsersIcon, DocumentTextIcon, PresentationChartBarIcon, TrashIcon, PencilIcon, PaperClipIcon,
    CheckIcon, XMarkIcon
} from '@heroicons/react/24/outline';
import { v4 as uuidv4 } from 'uuid';

// --- Import the created components ---
import AcademicQualificationDisplay from '@/components/profile/AcademicQualificationDisplay';
import AcademicQualificationForm from '@/components/profile/AcademicQualificationForm';

// --- Placeholder Components (Replace with actual imports when created) ---
const ProfessionalDevelopmentDisplay = ({ item }: { item: ProfessionalDevelopment }) => <div className='p-2 border border-dashed border-gray-300 rounded text-xs text-gray-500'>Display: {item.title || 'N/A'}</div>;
const ProfessionalDevelopmentForm = ({ item, isPending, handleInputChange, handleFileChange }: { item: TempProfessionalDevelopment, isPending: boolean, handleInputChange: (id: string, field: keyof TempProfessionalDevelopment, value: string | number) => void, handleFileChange: (id: string, file: File | null | undefined) => void }) => <div className='p-2 border border-dashed border-blue-300 rounded text-xs text-blue-600'>Form Placeholder: {item.title || 'New Prof Dev'}</div>;
const ProfessionalLicenseDisplay = ({ item }: { item: ProfessionalLicense }) => <div className='p-2 border border-dashed border-gray-300 rounded text-xs text-gray-500'>Display: {item.examination || 'N/A'}</div>;
const ProfessionalLicenseForm = ({ item, isPending, handleInputChange }: { item: TempProfessionalLicense, isPending: boolean, handleInputChange: (id: string, field: keyof TempProfessionalLicense, value: string | number) => void }) => <div className='p-2 border border-dashed border-blue-300 rounded text-xs text-blue-600'>Form Placeholder: {item.examination || 'New License'}</div>;
const WorkExperienceDisplay = ({ item }: { item: WorkExperience }) => <div className='p-2 border border-dashed border-gray-300 rounded text-xs text-gray-500'>Display: {item.position || 'N/A'}</div>;
const WorkExperienceForm = ({ item, isPending, handleInputChange }: { item: TempWorkExperience, isPending: boolean, handleInputChange: (id: string, field: keyof TempWorkExperience, value: string | number) => void }) => <div className='p-2 border border-dashed border-blue-300 rounded text-xs text-blue-600'>Form Placeholder: {item.position || 'New Work Exp'}</div>;
const ProfessionalAffiliationDisplay = ({ item }: { item: ProfessionalAffiliation }) => <div className='p-2 border border-dashed border-gray-300 rounded text-xs text-gray-500'>Display: {item.organization || 'N/A'}</div>;
const ProfessionalAffiliationForm = ({ item, isPending, handleInputChange }: { item: TempProfessionalAffiliation, isPending: boolean, handleInputChange: (id: string, field: keyof TempProfessionalAffiliation, value: string | number) => void }) => <div className='p-2 border border-dashed border-blue-300 rounded text-xs text-blue-600'>Form Placeholder: {item.organization || 'New Affiliation'}</div>;
const AwardRecognitionDisplay = ({ item }: { item: AwardRecognition }) => <div className='p-2 border border-dashed border-gray-300 rounded text-xs text-gray-500'>Display: {item.awardName || 'N/A'}</div>;
const AwardRecognitionForm = ({ item, isPending, handleInputChange }: { item: TempAwardRecognition, isPending: boolean, handleInputChange: (id: string, field: keyof TempAwardRecognition, value: string | number) => void }) => <div className='p-2 border border-dashed border-blue-300 rounded text-xs text-blue-600'>Form Placeholder: {item.awardName || 'New Award'}</div>;
const CommunityInvolvementDisplay = ({ item }: { item: CommunityInvolvement }) => <div className='p-2 border border-dashed border-gray-300 rounded text-xs text-gray-500'>Display: {item.engagementTitle || 'N/A'}</div>;
const CommunityInvolvementForm = ({ item, isPending, handleInputChange }: { item: TempCommunityInvolvement, isPending: boolean, handleInputChange: (id: string, field: keyof TempCommunityInvolvement, value: string | number) => void }) => <div className='p-2 border border-dashed border-blue-300 rounded text-xs text-blue-600'>Form Placeholder: {item.engagementTitle || 'New Involvement'}</div>;
const PublicationDisplay = ({ item }: { item: Publication }) => <div className='p-2 border border-dashed border-gray-300 rounded text-xs text-gray-500'>Display: {item.researchTitle || 'N/A'}</div>;
const PublicationForm = ({ item, isPending, handleInputChange }: { item: TempPublication, isPending: boolean, handleInputChange: (id: string, field: keyof TempPublication, value: string | number) => void }) => <div className='p-2 border border-dashed border-blue-300 rounded text-xs text-blue-600'>Form Placeholder: {item.researchTitle || 'New Publication'}</div>;
const ConferencePresentationDisplay = ({ item }: { item: ConferencePresentation }) => <div className='p-2 border border-dashed border-gray-300 rounded text-xs text-gray-500'>Display: {item.paperTitle || 'N/A'}</div>;
const ConferencePresentationForm = ({ item, isPending, handleInputChange }: { item: TempConferencePresentation, isPending: boolean, handleInputChange: (id: string, field: keyof TempConferencePresentation, value: string | number) => void }) => <div className='p-2 border border-dashed border-blue-300 rounded text-xs text-blue-600'>Form Placeholder: {item.paperTitle || 'New Presentation'}</div>;


// --- Interfaces & Metadata ---
interface ProfileData {
    user: { id: string; name: string | null; email: string | null; role: string | null; } | null;
    academicQualifications: AcademicQualification[];
    professionalLicenses: ProfessionalLicense[];
    workExperiences: WorkExperience[];
    professionalAffiliations: ProfessionalAffiliation[];
    awardsRecognitions: AwardRecognition[];
    professionalDevelopments: ProfessionalDevelopment[];
    communityInvolvements: CommunityInvolvement[];
    publications: Publication[];
    conferencePresentations: ConferencePresentation[];
    error?: string;
}
const categoryMetadata = {
    academicQualifications: { title: 'Academic Qualifications', icon: AcademicCapIcon },
    professionalLicenses: { title: 'Professional Licenses', icon: IdentificationIcon },
    workExperiences: { title: 'Work Experience', icon: BriefcaseIcon },
    professionalAffiliations: { title: 'Professional Affiliations', icon: UsersIcon },
    awardsRecognitions: { title: 'Awards & Recognitions', icon: StarIcon },
    professionalDevelopments: { title: 'Professional Development', icon: SparklesIcon },
    communityInvolvements: { title: 'Community Involvement', icon: UsersIcon },
    publications: { title: 'Publications', icon: DocumentTextIcon },
    conferencePresentations: { title: 'Conference Presentations', icon: PresentationChartBarIcon },
} as const;
type CategoryKey = keyof typeof categoryMetadata;
type EditableProfileData = Omit<ProfileData, 'user' | 'error'>;

// --- Helper Functions ---
const formatDate = (date: string | Date | null | undefined): string => {
    if (!date) return 'N/A';
    try {
        return new Date(date).toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
    } catch (e) {
        console.error("Error formatting date:", date, e);
        return 'Invalid Date';
    }
};
const formatDateForInput = (date: string | Date | null | undefined): string => {
    if (!date) return '';
    try {
        const d = new Date(date);
        if (isNaN(d.getTime())) return '';
        return d.toISOString().split('T')[0];
    } catch (e) {
        console.error("Error formatting date for input:", date, e);
        return '';
    }
};

// --- Main Component ---
export default function ProfilePage() {
    const { status: sessionStatus } = useSession();
    const [profileData, setProfileData] = useState<ProfileData | null>(null);
    const [isLoading, setIsLoading] = useState(true);
    const [pageError, setPageError] = useState<string | null>(null);
    const [isEditing, setIsEditing] = useState(false);
    const [isPending, startTransition] = useTransition();
    const [editError, setEditError] = useState<string | null>(null);
    const [editSuccess, setEditSuccess] = useState<string | null>(null);
    const [editableData, setEditableData] = useState<EditableProfileData | null>(null);
    const [visibleCategories, setVisibleCategories] = useState<Set<CategoryKey>>(new Set());
    const [showCategoryDropdown, setShowCategoryDropdown] = useState(false);
    const [editingItemId, setEditingItemId] = useState<string | null>(null);
    const [originalItemData, setOriginalItemData] = useState<EditableItem | null>(null);

    // --- Fetch data ---
    const fetchProfileData = useCallback(async (showLoading = true) => {
        if (showLoading) setIsLoading(true);
        setPageError(null); setEditError(null); setEditSuccess(null);
        try {
            const data = await getMyProfileData();
            if (data.error) { setPageError(data.error); setProfileData(null); setVisibleCategories(new Set()); }
            else {
                setProfileData(data); const initialVisible = new Set<CategoryKey>();
                (Object.keys(categoryMetadata) as CategoryKey[]).forEach(key => { if (data[key] && Array.isArray(data[key]) && data[key].length > 0) { initialVisible.add(key); } });
                setVisibleCategories(initialVisible); setIsEditing(false); setEditableData(null); setEditingItemId(null); setOriginalItemData(null);
            }
        } catch (err) { console.error("Failed fetch:", err); setPageError("Unexpected fetch error."); setProfileData(null); setVisibleCategories(new Set()); }
        finally { if (showLoading) setIsLoading(false); }
    }, []);

    // --- Initial Fetch ---
    useEffect(() => {
        if (sessionStatus === 'authenticated') { if (!profileData && isLoading) { fetchProfileData(); } else if (profileData && isLoading) { setIsLoading(false); } }
        else if (sessionStatus === 'unauthenticated') { setIsLoading(false); setPageError("Access Denied."); setProfileData(null); setVisibleCategories(new Set()); }
        else { setIsLoading(true); }
    }, [sessionStatus, profileData, isLoading, fetchProfileData]);

    // --- Edit Mode Toggles ---
    const handleEditToggle = () => {
        if (isEditing) { handleCancelEdit(); }
        else {
            if (!profileData || !profileData.user) { setPageError("Cannot enter edit mode."); return; }
            setIsEditing(true); setEditError(null); setEditSuccess(null);
            const dataToEdit: EditableProfileData = {
                academicQualifications: structuredClone(profileData.academicQualifications), professionalLicenses: structuredClone(profileData.professionalLicenses),
                workExperiences: structuredClone(profileData.workExperiences), professionalAffiliations: structuredClone(profileData.professionalAffiliations),
                awardsRecognitions: structuredClone(profileData.awardsRecognitions), professionalDevelopments: structuredClone(profileData.professionalDevelopments),
                communityInvolvements: structuredClone(profileData.communityInvolvements), publications: structuredClone(profileData.publications),
                conferencePresentations: structuredClone(profileData.conferencePresentations),
            };
            setEditableData(dataToEdit); const categoriesToMakeVisible = new Set(visibleCategories);
            (Object.keys(dataToEdit) as CategoryKey[]).forEach(key => { if (dataToEdit[key]?.length > 0) { categoriesToMakeVisible.add(key); } });
            setVisibleCategories(categoriesToMakeVisible); setEditingItemId(null); setOriginalItemData(null);
        }
    };
    const handleCancelEdit = () => { setIsEditing(false); setEditableData(null); setEditingItemId(null); setOriginalItemData(null); setEditError(null); setEditSuccess(null); };

    // --- Save Changes ---
    const handleSaveChanges = () => {
        if (!editableData) { setEditError("No changes to save."); return; }
        setEditError(null); setEditSuccess(null);
        startTransition(async () => {
            try {
                const formData = new FormData();
                (Object.keys(categoryMetadata) as CategoryKey[]).forEach(categoryKey => {
                    const categoryData = editableData[categoryKey] as EditableItem[] | undefined;
                    if (categoryData) {
                        const dataToSend = categoryData.map(item => {
                            if (item && '_selectedFile' in item) { const { _selectedFile, ...rest } = item; return rest; }
                            return item;
                        });
                        formData.append(`${categoryKey}_json`, JSON.stringify(dataToSend));
                        if (['academicQualifications', 'professionalDevelopments'].includes(categoryKey)) {
                            categoryData.forEach((item) => {
                                if (item && '_selectedFile' in item && item._selectedFile && (item._isNew || editingItemId === item.id)) {
                                    formData.append(`${categoryKey}_file_${item.id}`, item._selectedFile);
                                }
                            });
                        }
                    }
                });
                const result = await updateMyProfile(formData);
                if (result.success) { setEditSuccess("Profile updated!"); setIsEditing(false); setEditableData(null); setEditingItemId(null); setOriginalItemData(null); await fetchProfileData(false); }
                else { setEditError(result.error || "Failed to save."); }
            } catch (err: any) { console.error("Save error:", err); setEditError(err.message || "Unexpected save error."); }
        });
    };

    const handleAddCategory = (categoryKey: CategoryKey) => { setVisibleCategories(prev => new Set(prev).add(categoryKey)); setShowCategoryDropdown(false); };

    // --- Local Delete ---
    const handleDeleteItemLocally = (category: CategoryKey, id: string) => {
        if (!editableData) return;
        setEditableData(prevData => {
             if (!prevData || !Array.isArray(prevData[category])) return prevData;
             const updatedEditableData = { ...prevData };
             updatedEditableData[category] = (updatedEditableData[category] as any[]).filter(item => item.id !== id);
             return updatedEditableData;
        });
        if (editingItemId === id) { setEditingItemId(null); setOriginalItemData(null); }
    };

    // --- Local Add ---
    const handleAddItemLocally = (category: CategoryKey) => {
        if (!editableData || !profileData?.user?.id) return;
        const newEditableData = { ...editableData }; const newItemId = uuidv4(); let placeholderItem: EditableItem;
        const now = new Date(); const currentUserId = profileData.user.id; const nextYear = new Date(now); nextYear.setFullYear(nextYear.getFullYear() + 1);
        switch (category) {
            case 'academicQualifications': placeholderItem = { id: newItemId, degree: '', institution: '', program: '', yearCompleted: now.getFullYear(), diplomaFileUrl: null, userId: currentUserId, createdAt: now, updatedAt: now, _isNew: true, _selectedFile: null } as TempAcademicQualification; break;
            case 'professionalLicenses': placeholderItem = { id: newItemId, examination: '', monthYear: '', licenseNumber: '', expiration: nextYear, userId: currentUserId, createdAt: now, updatedAt: now, _isNew: true } as TempProfessionalLicense; break;
            case 'workExperiences': placeholderItem = { id: newItemId, institution: '', position: '', natureOfWork: null, inclusiveYears: '', userId: currentUserId, createdAt: now, updatedAt: now, _isNew: true } as TempWorkExperience; break;
            case 'professionalAffiliations': placeholderItem = { id: newItemId, organization: '', position: null, inclusiveYears: '', userId: currentUserId, createdAt: now, updatedAt: now, _isNew: true } as TempProfessionalAffiliation; break;
            case 'awardsRecognitions': placeholderItem = { id: newItemId, awardName: '', awardingBody: '', yearReceived: now.getFullYear(), userId: currentUserId, createdAt: now, updatedAt: now, _isNew: true } as TempAwardRecognition; break;
            case 'professionalDevelopments': placeholderItem = { id: newItemId, title: '', organizer: '', dateLocation: '', certificateFileUrl: null, userId: currentUserId, createdAt: now, updatedAt: now, _isNew: true, _selectedFile: null } as TempProfessionalDevelopment; break;
            case 'communityInvolvements': placeholderItem = { id: newItemId, engagementTitle: '', role: '', locationDate: '', userId: currentUserId, createdAt: now, updatedAt: now, _isNew: true } as TempCommunityInvolvement; break;
            case 'publications': placeholderItem = { id: newItemId, researchTitle: '', journal: '', datePublished: now, userId: currentUserId, createdAt: now, updatedAt: now, _isNew: true } as TempPublication; break;
            case 'conferencePresentations': placeholderItem = { id: newItemId, paperTitle: '', eventName: '', dateLocation: '', userId: currentUserId, createdAt: now, updatedAt: now, _isNew: true } as TempConferencePresentation; break;
            default: console.error(`Add handler not implemented for: ${category}`); return;
        }
        if (!Array.isArray(newEditableData[category])) { newEditableData[category] = []; }
        (newEditableData[category] as EditableItem[]) = [placeholderItem, ...(newEditableData[category] as EditableItem[])];
        setEditableData(newEditableData); handleStartEditingItem(category, newItemId);
    };

    // --- Input Change ---
    const handleInputChange = (category: CategoryKey, itemId: string, fieldName: string, value: string | number) => {
        if (!editableData) return;
        setEditableData(prevData => {
            if (!prevData || !prevData[category]) return prevData;
            const updatedCategoryData = structuredClone(prevData[category]) as any[];
            const itemIndex = updatedCategoryData.findIndex(item => item.id === itemId);
            if (itemIndex === -1) { console.warn(`Item ${itemId} not found in ${category}`); return prevData; }
            const numericFields = ['yearCompleted', 'yearReceived']; const dateFields = ['expiration', 'datePublished'];
            let finalValue: string | number | Date | null = value;
            if (value === '') { finalValue = null; if (numericFields.includes(fieldName)) finalValue = null; }
            else if (numericFields.includes(fieldName)) { finalValue = parseInt(value as string, 10); if(isNaN(finalValue as number)) finalValue = null; }
            else if (dateFields.includes(fieldName)) { try { const parsedDate = new Date(value as string); finalValue = isNaN(parsedDate.getTime()) ? null : parsedDate; } catch { finalValue = null; } }
            updatedCategoryData[itemIndex] = { ...updatedCategoryData[itemIndex], [fieldName]: finalValue, updatedAt: new Date() };
            return { ...prevData, [category]: updatedCategoryData };
        });
    };

    // --- File Change ---
    const handleFileChange = (category: CategoryKey, itemId: string, file: File | null | undefined) => {
        const categoriesWithFiles: CategoryKey[] = ['academicQualifications', 'professionalDevelopments'];
        if (!categoriesWithFiles.includes(category)) { console.warn(`File change not supported for: ${category}`); return; }
        if (!editableData || !editableData[category]) { console.warn(`Cannot handle file change: Category ${category} not found`); return; }
        const MAX_FILE_SIZE = 5 * 1024 * 1024; const ALLOWED_TYPES = ['application/pdf', 'image/png', 'image/jpeg', 'image/jpg'];
        if (file && file.size > MAX_FILE_SIZE) { alert(`File size exceeds limit.`); return; }
        if (file && !ALLOWED_TYPES.includes(file.type)) { alert('Invalid file type.'); return; }
        setEditableData(prevData => {
            if (!prevData) return null;
            const updatedCategoryData = structuredClone(prevData[category]) as EditableItem[];
            const itemIndex = updatedCategoryData.findIndex(item => item.id === itemId);
            if (itemIndex === -1) return prevData;
            const currentItem = updatedCategoryData[itemIndex];
            if (currentItem && '_selectedFile' in currentItem) { updatedCategoryData[itemIndex] = { ...currentItem, _selectedFile: file ?? null, updatedAt: new Date() }; }
            else if (file) { console.warn(`Attempted file assign for category ${category} w/o _selectedFile`); updatedCategoryData[itemIndex] = { ...currentItem, updatedAt: new Date() }; } // Avoid adding property if not expected
            else { updatedCategoryData[itemIndex] = { ...currentItem, updatedAt: new Date() }; } // Just update timestamp if file is null/undefined and property doesn't exist
            return { ...prevData, [category]: updatedCategoryData };
        });
    };

    // --- Inline Item Edit Handlers ---
    const handleStartEditingItem = (category: CategoryKey, itemId: string) => {
        if (!editableData || !editableData[category]) return;
        const itemToEdit = (editableData[category] as EditableItem[]).find(item => item.id === itemId);
        if (itemToEdit) { setOriginalItemData(structuredClone(itemToEdit)); setEditingItemId(itemId); setEditError(null); }
        else { console.error("Item not found:", itemId); }
    };
    const handleCancelItemEdit = (category: CategoryKey, itemId: string) => {
        if (!editableData || !originalItemData || originalItemData.id !== itemId || !editableData[category]) { setEditingItemId(null); setOriginalItemData(null); return; };
        setEditableData(prevData => {
            if (!prevData) return null;
            const updatedCategoryData = structuredClone(prevData[category]) as EditableItem[];
            const itemIndex = updatedCategoryData.findIndex(item => item.id === itemId);
            if (itemIndex !== -1) { updatedCategoryData[itemIndex] = originalItemData; }
            return { ...prevData, [category]: updatedCategoryData };
        });
        setEditingItemId(null); setOriginalItemData(null);
    };
    const handleSaveEditedItem = (itemId: string) => { setEditingItemId(null); setOriginalItemData(null); };

    // --- Render ---
    if (isLoading || sessionStatus === 'loading') { return <div className="p-6 animate-pulse">Loading profile...</div>; }
    if (pageError || sessionStatus === 'unauthenticated' || !profileData || !profileData.user) { return <div className="p-6 text-red-600">Error: {pageError || "Could not load profile data or access denied."}</div>; }

    const dataToDisplay = isEditing ? editableData : profileData;
    const finalData = (isEditing && dataToDisplay) ? dataToDisplay : profileData;
    const inputClass = "block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm disabled:opacity-70";
    const labelClass = "block text-xs font-medium text-gray-600 mb-0.5";

    return (
        <div className="p-6 bg-gray-50 min-h-screen">
            {/* Header */}
            <div className="mb-6 flex flex-wrap items-center justify-between gap-4 border-b border-gray-200 pb-4">
                <h1 className="text-3xl font-bold text-gray-800">My Profile</h1>
                <div className="flex items-center gap-2 flex-wrap">
                    <button onClick={handleEditToggle} disabled={isPending} className={`inline-flex items-center gap-1.5 rounded-md px-3 py-1.5 text-sm font-medium text-white shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 disabled:opacity-70 ${isEditing ? 'bg-gray-600 hover:bg-gray-700 focus:ring-gray-500' : 'bg-blue-600 hover:bg-blue-700 focus:ring-blue-600'}`}> {isEditing ? <><XCircleIcon className="h-4 w-4" /> Cancel</> : <><PencilSquareIcon className="h-4 w-4" /> Edit Profile</>} </button>
                    {isEditing && (<button onClick={handleSaveChanges} disabled={isPending || editingItemId !== null} className="inline-flex items-center gap-1.5 rounded-md bg-green-600 px-3 py-1.5 text-sm font-medium text-white shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 disabled:opacity-70"> {isPending ? ('Saving...') : (<><CheckCircleIcon className="h-4 w-4" /> Save Changes</>)} </button>)}
                    <div className="relative"> <button onClick={() => setShowCategoryDropdown(!showCategoryDropdown)} disabled={isPending || isEditing} className="inline-flex items-center gap-1 rounded-md bg-indigo-600 px-3 py-1.5 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 disabled:opacity-70" aria-haspopup="true" aria-expanded={showCategoryDropdown}> <PlusIcon className="h-4 w-4" /> Add Section </button> {showCategoryDropdown && ( <div className="absolute right-0 z-10 mt-2 w-56 origin-top-right rounded-md bg-white shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none" role="menu"> <div className="py-1" role="none"> {(Object.keys(categoryMetadata) as CategoryKey[]).filter(key => !visibleCategories.has(key)).length > 0 ? ((Object.keys(categoryMetadata) as CategoryKey[]).filter(key => !visibleCategories.has(key)).map(key => ( <button key={key} onClick={() => handleAddCategory(key)} className="block w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100" role="menuitem"> {categoryMetadata[key].title} </button> ))) : ( <p className="px-4 py-2 text-sm text-gray-500">All sections added.</p> )} </div> </div> )} </div>
                </div>
                {isEditing && editingItemId !== null && ( <p className="mt-2 text-sm text-yellow-700 bg-yellow-50 p-2 rounded border border-yellow-200 w-full text-center"> Finish editing the current item (<CheckIcon className='inline h-4 w-4 text-blue-600'/> <XMarkIcon className='inline h-4 w-4 text-gray-600'/>) before saving all profile changes. </p> )}
            </div>
            {/* Messages */}
            {editSuccess && <div className="mb-4 rounded-md bg-green-50 p-4 text-sm font-medium text-green-800">{editSuccess}</div>}
            {editError && <div className="mb-4 rounded-md bg-red-50 p-4 text-sm font-medium text-red-800">{editError}</div>}
            {pageError && !editError && <div className="mb-4 rounded-md bg-red-50 p-4 text-sm font-medium text-red-800">{pageError}</div>}
            {/* Basic Info */}
            <div className="mb-8 rounded-lg border border-gray-200 bg-white p-6 shadow-md"> <h2 className="mb-4 text-xl font-semibold text-gray-700">Basic Information</h2> <div className="grid grid-cols-1 gap-x-4 gap-y-2 text-sm sm:grid-cols-2"> <div><span className="font-medium text-gray-500">Name:</span> {profileData.user.name ?? 'N/A'}</div> <div><span className="font-medium text-gray-500">Email:</span> {profileData.user.email ?? 'N/A'}</div> <div><span className="font-medium text-gray-500">Role:</span> {profileData.user.role ?? 'N/A'}</div> </div> </div>

            {/* Dynamic Sections */}
            {visibleCategories.size === 0 && !isLoading && ( <div className="rounded-lg border-2 border-dashed border-gray-300 bg-gray-100 p-6 text-center text-gray-500"> No profile sections added yet... </div> )}
            <div className="grid grid-cols-1 gap-6 md:grid-cols-2 xl:grid-cols-3">
                {Array.from(visibleCategories).map(categoryKey => {
                    const categoryMeta = categoryMetadata[categoryKey];
                    const categoryData = (finalData?.[categoryKey] ?? []) as any[];
                    const CategoryIcon = categoryMeta.icon;
                    const isNewItem = (item: any): boolean => !!item._isNew;
                    const isCategoryEditable = true; // Assume all have forms/display components

                    return (
                        <div key={categoryKey} className="flex flex-col rounded-lg border border-gray-200 bg-white shadow-md overflow-hidden">
                            {/* Card Header */}
                            <div className="flex items-center justify-between border-b border-gray-200 bg-gray-50 px-4 py-3"> <div className="flex items-center gap-2"> <CategoryIcon className="h-5 w-5 text-indigo-600" aria-hidden="true" /> <h2 className="text-lg font-semibold text-gray-700">{categoryMeta.title}</h2> </div> {isEditing && ( <button onClick={() => handleAddItemLocally(categoryKey)} className="rounded bg-indigo-50 p-1 text-indigo-600 hover:bg-indigo-100 disabled:opacity-50 disabled:cursor-not-allowed" title={`Add ${categoryMeta.title}`} disabled={editingItemId !== null || !isCategoryEditable}> <PlusIcon className="h-4 w-4" /> </button> )} </div>
                            {/* Card Body */}
                            <div className="flex-grow p-4 text-sm text-gray-700">
                                {categoryData.length === 0 ? ( <p className="italic text-gray-400">No items recorded.</p> ) : (
                                    <ul className="space-y-4">
                                        {categoryData.map((item: EditableItem, index: number) => (
                                            <li key={item.id || index} className={`border-b border-gray-100 pb-3 last:border-b-0 last:pb-0 relative group ${isEditing && item.id === editingItemId ? 'bg-blue-50 p-3 rounded border border-dashed border-blue-300 shadow-inner' : isNewItem(item) ? 'bg-green-50 p-3 rounded border border-dashed border-green-300 shadow-inner' : ''}`}>
                                                {/* RENDER FORM OR DISPLAY */}
                                                {isEditing && (isNewItem(item) || item.id === editingItemId) ? (
                                                    // --- RENDER FORM ---
                                                    <>
                                                         {/* --- **FIX**: Ensure props passed match component expectations --- */}
                                                         {categoryKey === 'academicQualifications' && ( <AcademicQualificationForm item={item as TempAcademicQualification} isPending={isPending} handleInputChange={(itemId: string, fieldName: keyof TempAcademicQualification, value: string | number) => handleInputChange(categoryKey, itemId, fieldName, value)} handleFileChange={(itemId: string, file: File | null | undefined) => handleFileChange(categoryKey, itemId, file)} /> )}
                                                         {categoryKey === 'professionalDevelopments' && ( <ProfessionalDevelopmentForm item={item as TempProfessionalDevelopment} isPending={isPending} handleInputChange={(itemId: string, fieldName: keyof TempProfessionalDevelopment, value: string | number) => handleInputChange(categoryKey, itemId, fieldName, value)} handleFileChange={(itemId: string, file: File | null | undefined) => handleFileChange(categoryKey, itemId, file)} /> )}
                                                         {categoryKey === 'professionalLicenses' && ( <ProfessionalLicenseForm item={item as TempProfessionalLicense} isPending={isPending} handleInputChange={(itemId: string, fieldName: keyof TempProfessionalLicense, value: string | number) => handleInputChange(categoryKey, itemId, fieldName, value)} /> )}
                                                         {categoryKey === 'workExperiences' && ( <WorkExperienceForm item={item as TempWorkExperience} isPending={isPending} handleInputChange={(itemId: string, fieldName: keyof TempWorkExperience, value: string | number) => handleInputChange(categoryKey, itemId, fieldName, value)} /> )}
                                                         {categoryKey === 'professionalAffiliations' && ( <ProfessionalAffiliationForm item={item as TempProfessionalAffiliation} isPending={isPending} handleInputChange={(itemId: string, fieldName: keyof TempProfessionalAffiliation, value: string | number) => handleInputChange(categoryKey, itemId, fieldName, value)} /> )}
                                                         {categoryKey === 'awardsRecognitions' && ( <AwardRecognitionForm item={item as TempAwardRecognition} isPending={isPending} handleInputChange={(itemId: string, fieldName: keyof TempAwardRecognition, value: string | number) => handleInputChange(categoryKey, itemId, fieldName, value)} /> )}
                                                         {categoryKey === 'communityInvolvements' && ( <CommunityInvolvementForm item={item as TempCommunityInvolvement} isPending={isPending} handleInputChange={(itemId: string, fieldName: keyof TempCommunityInvolvement, value: string | number) => handleInputChange(categoryKey, itemId, fieldName, value)} /> )}
                                                         {categoryKey === 'publications' && ( <PublicationForm item={item as TempPublication} isPending={isPending} handleInputChange={(itemId: string, fieldName: keyof TempPublication, value: string | number) => handleInputChange(categoryKey, itemId, fieldName, value)} /> )}
                                                         {categoryKey === 'conferencePresentations' && ( <ConferencePresentationForm item={item as TempConferencePresentation} isPending={isPending} handleInputChange={(itemId: string, fieldName: keyof TempConferencePresentation, value: string | number) => handleInputChange(categoryKey, itemId, fieldName, value)} /> )}
                                                         {/* Item specific Save/Cancel Buttons */}
                                                        {!isNewItem(item) && item.id === editingItemId && ( <div className='flex justify-end gap-2 mt-3'> <button onClick={() => handleCancelItemEdit(categoryKey, item.id)} disabled={isPending} className='inline-flex items-center gap-1 px-2 py-1 rounded text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-400'> <XMarkIcon className='h-3 w-3'/> Cancel</button> <button onClick={() => handleSaveEditedItem(item.id)} disabled={isPending} className='inline-flex items-center gap-1 px-2 py-1 rounded text-xs bg-blue-100 hover:bg-blue-200 text-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400'> <CheckIcon className='h-3 w-3'/> Save Item</button> </div> )}
                                                    </>
                                                ) : (
                                                    // --- DISPLAY ITEM ---
                                                    <>
                                                        {/* --- **FIX**: Ensure correct item type is passed to Display components --- */}
                                                        {categoryKey === 'academicQualifications' && ( <AcademicQualificationDisplay item={item as AcademicQualification} /> )}
                                                        {categoryKey === 'professionalDevelopments' && ( <ProfessionalDevelopmentDisplay item={item as ProfessionalDevelopment} /> )}
                                                        {categoryKey === 'professionalLicenses' && ( <ProfessionalLicenseDisplay item={item as ProfessionalLicense} /> )}
                                                        {categoryKey === 'workExperiences' && ( <WorkExperienceDisplay item={item as WorkExperience} /> )}
                                                        {categoryKey === 'professionalAffiliations' && ( <ProfessionalAffiliationDisplay item={item as ProfessionalAffiliation} /> )}
                                                        {categoryKey === 'awardsRecognitions' && ( <AwardRecognitionDisplay item={item as AwardRecognition} /> )}
                                                        {categoryKey === 'communityInvolvements' && ( <CommunityInvolvementDisplay item={item as CommunityInvolvement} /> )}
                                                        {categoryKey === 'publications' && ( <PublicationDisplay item={item as Publication} /> )}
                                                        {categoryKey === 'conferencePresentations' && ( <ConferencePresentationDisplay item={item as ConferencePresentation} /> )}
                                                    </>
                                                )}
                                                {/* Action Buttons (Edit/Delete) */}
                                                {isEditing && item.id !== editingItemId && ( <div className="absolute top-1 right-1 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity"> {!isNewItem(item) && ( <button onClick={() => handleStartEditingItem(categoryKey, item.id)} className="p-0.5 rounded bg-blue-50 text-blue-500 hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-1" title={`Edit`} disabled={isPending || editingItemId !== null}> <PencilIcon className="h-4 w-4" /> </button> )} <button onClick={() => handleDeleteItemLocally(categoryKey, item.id)} className="p-0.5 rounded bg-red-50 text-red-500 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-1" title={`Delete`} disabled={isPending || editingItemId !== null}> <TrashIcon className="h-4 w-4" /> </button> </div> )}
                                            </li>
                                        ))}
                                    </ul>
                                )}
                            </div>
                        </div>
                    );
                })}
            </div>
        </div>
    );
}


--- END FILE: src\app\(faculty)\profile\page.tsx ---

--- START FILE: src\app\admin\approvals\page.tsx ---
[EMPTY FILE]

--- END FILE: src\app\admin\approvals\page.tsx ---

--- START FILE: src\app\admin\dashboard\page.tsx ---
// src/app/admin/dashboard/page.tsx
'use client';

import React from 'react';
import { useSession } from 'next-auth/react';
import Link from 'next/link'; // For linking to other admin sections later

export default function AdminDashboardPage() {
    const { data: session, status } = useSession();

    // Note: The middleware should already prevent non-admins from reaching here.
    // This check is mostly for display purposes or as an extra layer.
    const userRole = (session?.user as any)?.role;

    if (status === 'loading') {
        return <div className="p-6">Loading admin dashboard...</div>;
    }

    // Extra check, though middleware is primary protection
    if (status !== 'authenticated' || userRole !== 'ADMIN') {
         return <div className="p-6">Access Denied. You do not have permission to view this page.</div>;
    }

    return (
        <div className="p-6">
            <h1 className="mb-6 text-2xl font-semibold text-[#003153]">
                Administrator Dashboard
            </h1>

            <p className="mb-4">
                Welcome, Administrator {session?.user?.name ?? session?.user?.email}!
            </p>

            <p>This is the central hub for managing faculty and system settings.</p>

            {/* Placeholder sections for Admin features */}
             <div className="mt-6 grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3">
                <div className="rounded border border-gray-200 bg-white p-4 shadow">
                    <h2 className="mb-2 text-lg font-medium text-[#003153]">Manage Faculty</h2>
                    <p className="text-sm text-gray-600">View and manage faculty profiles.</p>
                     {/* <Link href="/admin/faculty">Go</Link> */}
                </div>
                 <div className="rounded border border-gray-200 bg-white p-4 shadow">
                    <h2 className="mb-2 text-lg font-medium text-[#003153]">Document Approvals</h2>
                    <p className="text-sm text-gray-600">Review pending document submissions.</p>
                     {/* <Link href="/admin/approvals">Go</Link> */}
                </div>
                 <div className="rounded border border-gray-200 bg-white p-4 shadow">
                    <h2 className="mb-2 text-lg font-medium text-[#003153]">Specialization Matrix</h2>
                    <p className="text-sm text-gray-600">View faculty skills and expertise.</p>
                     {/* <Link href="/admin/matrix">Go</Link> */}
                </div>
                 {/* Add more admin sections as needed */}
            </div>
        </div>
    );
}


--- END FILE: src\app\admin\dashboard\page.tsx ---

--- START FILE: src\app\admin\faculty\page.tsx ---
[EMPTY FILE]

--- END FILE: src\app\admin\faculty\page.tsx ---

--- START FILE: src\app\admin\faculty\[facultyId]\page.tsx ---
[EMPTY FILE]

--- END FILE: src\app\admin\faculty\[facultyId]\page.tsx ---

--- START FILE: src\app\admin\matrix\page.tsx ---
[EMPTY FILE]

--- END FILE: src\app\admin\matrix\page.tsx ---

--- START FILE: src\app\api\auth\[...nextauth]\route.ts ---
// src/app/api/auth/[...nextauth]/route.ts
import NextAuth, { type NextAuthOptions } from 'next-auth';
import CredentialsProvider from 'next-auth/providers/credentials';
import { PrismaAdapter } from '@next-auth/prisma-adapter';
import bcrypt from 'bcrypt';
import prisma from '@/lib/prisma'; // Import the singleton Prisma Client instance

export const authOptions: NextAuthOptions = {
    // Configure Prisma Adapter
    adapter: PrismaAdapter(prisma),

    // Configure one or more authentication providers
    providers: [
        CredentialsProvider({
            // The name to display on the sign in form (e.g. "Sign in with...")
            name: 'Credentials',
            // `credentials` is used to generate a form on the sign in page.
            credentials: {
                email: { label: "Email", type: "email", placeholder: "jsmith@example.com" },
                password: { label: "Password", type: "password" }
            },
            async authorize(credentials, req) {
                // Add logic here to look up the user from the credentials supplied
                if (!credentials?.email || !credentials?.password) {
                    console.error('Credentials missing');
                    return null; // Indicate failure: credentials not provided
                }

                try {
                    // Find the user in the database using the imported prisma instance
                    const user = await prisma.user.findUnique({
                        where: { email: credentials.email }
                    });

                    if (!user) {
                        console.error('No user found with email:', credentials.email);
                        // Optionally: throw new Error("No user found."); // Can provide feedback
                        return null; // User not found
                    }

                    // Validate the password using bcrypt.compare
                    const isValidPassword = await bcrypt.compare(
                        credentials.password, // Plain password from login form
                        user.password         // Hashed password from database
                    );

                    if (!isValidPassword) {
                        console.error('Invalid password for user:', credentials.email);
                        // Optionally: throw new Error("Invalid password."); // Can provide feedback
                        return null; // Password doesn't match
                    }

                    console.log('User authorized:', user.email);
                    // Return user object if credentials are valid
                    // This object must satisfy NextAuth's User type (at least 'id')
                    // Using 'as any' here simplifies typing for now.
                    return {
                        id: user.id,
                        name: user.name,
                        email: user.email,
                        role: user.role, // Include the role
                    } as any;

                } catch (error) {
                    console.error("Error during authorization:", error);
                    return null; // Return null on any unexpected error during authorization
                }
            }
        })
        // ...add more providers here (e.g., Google, GitHub)
    ],

    // Define how session is managed
    session: {
        strategy: "jwt", // Use JSON Web Tokens for session management
    },

    // Callbacks are asynchronous functions you can use to control what happens
    callbacks: {
        // Add user id and role to the JWT payload
        async jwt({ token, user }) {
            if (user) {
                // The 'user' object here comes from the 'authorize' function or DB lookup
                token.id = user.id;
                // Need type assertion because 'role' isn't part of default JWT token type
                token.role = (user as any).role;
            }
            return token;
        },
        // Add user id and role to the session object available client-side
        async session({ session, token }) {
            if (token && session.user) {
                 // Need type assertion to add custom properties to default Session['user']
                (session.user as any).id = token.id;
                (session.user as any).role = token.role;
            }
            return session;
        },
    },

    // Specify pages for login, error handling, etc.
    pages: {
        signIn: '/login', // Redirect users to /login if they need to sign in
        // error: '/auth/error', // Optional: Custom error page
    },

    // Secret for signing tokens (required) - loaded from .env.local
    secret: process.env.NEXTAUTH_SECRET,

    // Enable debug messages in development for easier troubleshooting
    debug: process.env.NODE_ENV === 'development',
};

// Export the NextAuth handler for GET and POST requests
const handler = NextAuth(authOptions);
export { handler as GET, handler as POST };


--- END FILE: src\app\api\auth\[...nextauth]\route.ts ---

--- START FILE: src\app\api\documents\route.ts ---
[EMPTY FILE]

--- END FILE: src\app\api\documents\route.ts ---

--- START FILE: src\app\api\faculty\route.ts ---
[EMPTY FILE]

--- END FILE: src\app\api\faculty\route.ts ---

--- START FILE: src\app\image-test\page.tsx ---
'use client'; // Required for potential state/hooks later if needed

import React from 'react';
import Image from 'next/image';
import Link from 'next/link';

// Ensure you have a valid image file named dot.png
// located directly in your project's /public directory
const IMAGE_SRC = "/dot.png";
const IMAGE_WIDTH = 100; // Example width
const IMAGE_HEIGHT = 100; // Example height

export default function ImageTestPage() {

    return (
        <div className="p-10">
            <h1 className="text-2xl font-bold mb-6">Image Loading Test Page</h1>

            <p className="mb-4">
                This page attempts to load the image located at <code>{IMAGE_SRC}</code>
                (expected to be in the <code>/public</code> folder).
            </p>

            <hr className="my-6" />

            {/* Test Case 1: Standard next/image */}
            <div className="mb-8 p-4 border rounded shadow">
                <h2 className="text-lg font-semibold mb-2">Test 1: Standard `next/image`</h2>
                <p className="text-sm text-gray-600 mb-2">
                    Using default optimization. Should work if the file is valid and optimization is okay.
                </p>
                <div style={{ width: `${IMAGE_WIDTH}px`, height: `${IMAGE_HEIGHT}px`, position: 'relative', border: '1px dashed blue' }}>
                    <Image
                        src={IMAGE_SRC}
                        alt="Test Dot - Standard"
                        width={IMAGE_WIDTH}
                        height={IMAGE_HEIGHT}
                        style={{ border: '1px solid red' }} // Add visible border to image itself
                        // Add onError for more feedback
                        onError={(e) => console.error(`Standard Image Error for ${IMAGE_SRC}:`, e)}
                    />
                </div>
                 <p className="text-xs mt-2">Container size: {IMAGE_WIDTH}x{IMAGE_HEIGHT}. Image border: red. Container border: blue dashed.</p>
            </div>

            {/* Test Case 2: next/image with unoptimized={true} */}
            <div className="mb-8 p-4 border rounded shadow">
                <h2 className="text-lg font-semibold mb-2">Test 2: `next/image` with `unoptimized`</h2>
                <p className="text-sm text-gray-600 mb-2">
                    Bypasses optimization. Should work if the file exists but optimization fails.
                </p>
                 <div style={{ width: `${IMAGE_WIDTH}px`, height: `${IMAGE_HEIGHT}px`, position: 'relative', border: '1px dashed blue' }}>
                    <Image
                        src={IMAGE_SRC}
                        alt="Test Dot - Unoptimized"
                        width={IMAGE_WIDTH}
                        height={IMAGE_HEIGHT}
                        unoptimized={true} // Bypass optimization
                        style={{ border: '1px solid red' }}
                        onError={(e) => console.error(`Unoptimized Image Error for ${IMAGE_SRC}:`, e)}
                    />
                </div>
                <p className="text-xs mt-2">Container size: {IMAGE_WIDTH}x{IMAGE_HEIGHT}. Image border: red. Container border: blue dashed.</p>
            </div>

             {/* Test Case 3: Standard HTML <img> tag */}
            <div className="mb-8 p-4 border rounded shadow">
                <h2 className="text-lg font-semibold mb-2">Test 3: Standard HTML `<img/>` tag</h2>
                <p className="text-sm text-gray-600 mb-2">
                    Loads the image directly from the public folder, no Next.js processing. Should work if the file exists and the server serves static files correctly.
                </p>
                {/* eslint-disable-next-line @next/next/no-img-element */}
                <img
                    src={IMAGE_SRC}
                    alt="Test Dot - Standard img tag"
                    width={IMAGE_WIDTH}
                    height={IMAGE_HEIGHT}
                    style={{ border: '1px solid red' }}
                    onError={(e) => console.error(`Standard <img> Error for ${IMAGE_SRC}:`, e.currentTarget.src)} // Note: error handling is slightly different
                />
                 <p className="text-xs mt-2">Explicit width/height set: {IMAGE_WIDTH}x{IMAGE_HEIGHT}. Image border: red.</p>
            </div>

            <hr className="my-6" />

            <Link href="/login" className="text-blue-600 hover:underline">
                ? Back to Login
            </Link>
        </div>
    );
}


--- END FILE: src\app\image-test\page.tsx ---

--- START FILE: src\components\profile\AcademicQualificationDisplay.tsx ---
// src/components/profile/AcademicQualificationDisplay.tsx
import React from 'react';
import type { AcademicQualification } from '@/generated/prisma';

// Helper function (can be moved to a utils file later)
const formatDateLocal = (date: string | Date | null | undefined): string => {
    if (!date) return 'N/A';
    try { return new Date(date).toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' }); }
    catch (e) { return 'Invalid Date'; }
};


interface Props {
    item: AcademicQualification;
}

export default function AcademicQualificationDisplay({ item }: Props) {
    return (
        <>
            <p className="font-semibold text-gray-800">{item.degree || 'N/A'}</p>
            <p className="text-gray-600">{item.institution || 'N/A'}{item.program ? ` - ${item.program}` : ''}</p>
            <p className="text-xs text-gray-500 mt-1">Completed: {item.yearCompleted || 'N/A'}</p>
            {item.diplomaFileUrl && (
                 <a
                    href={item.diplomaFileUrl}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="text-xs text-blue-600 hover:underline mt-1 block truncate"
                    title={item.diplomaFileUrl} // Show full URL on hover
                 >
                    View Document
                 </a>
            )}
        </>
    );
}


--- END FILE: src\components\profile\AcademicQualificationDisplay.tsx ---

--- START FILE: src\components\profile\AcademicQualificationForm.tsx ---
// src/components/profile/AcademicQualificationForm.tsx
import React, { ChangeEvent } from 'react';
import { PaperClipIcon } from '@heroicons/react/24/outline';
// --- *** IMPORT FROM TYPES FILE *** ---
import type { TempAcademicQualification } from '@/types';

interface Props {
    item: TempAcademicQualification;
    isPending: boolean;
    // Use keyof directly on the imported type for better safety
    handleInputChange: (itemId: string, fieldName: keyof TempAcademicQualification, value: string | number) => void;
    handleFileChange: (itemId: string, file: File | null | undefined) => void;
}

// Input and Label classes
const inputClass = "block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm disabled:opacity-70";
const labelClass = "block text-xs font-medium text-gray-600 mb-0.5";

export default function AcademicQualificationForm({ item, isPending, handleInputChange, handleFileChange }: Props) {
    const isNewItem = !!item._isNew;
    return (
        <div className="space-y-3">
            {/* ... rest of the form JSX remains the same ... */}
             <p className="text-xs font-semibold text-blue-700"> {isNewItem ? 'New Qualification' : 'Editing Qualification'} </p>
             {/* Degree Input */}
             <div> <label htmlFor={`degree-${item.id}`} className={labelClass}>Degree*</label> <input type="text" id={`degree-${item.id}`} name="degree" value={item.degree || ''} onChange={(e) => handleInputChange(item.id, 'degree', e.target.value)} className={inputClass} placeholder="e.g., Bachelor of Science" required disabled={isPending} /> </div>
             {/* Institution Input */}
             <div> <label htmlFor={`institution-${item.id}`} className={labelClass}>Institution*</label> <input type="text" id={`institution-${item.id}`} name="institution" value={item.institution || ''} onChange={(e) => handleInputChange(item.id, 'institution', e.target.value)} className={inputClass} placeholder="e.g., San Pedro College" required disabled={isPending} /> </div>
             {/* Program Input */}
             <div> <label htmlFor={`program-${item.id}`} className={labelClass}>Program/Major*</label> <input type="text" id={`program-${item.id}`} name="program" value={item.program || ''} onChange={(e) => handleInputChange(item.id, 'program', e.target.value)} className={inputClass} placeholder="e.g., Medical Laboratory Science" required disabled={isPending} /> </div>
             {/* Year Completed Input */}
             <div> <label htmlFor={`yearCompleted-${item.id}`} className={labelClass}>Year Completed*</label> <input type="number" id={`yearCompleted-${item.id}`} name="yearCompleted" value={item.yearCompleted || ''} onChange={(e) => handleInputChange(item.id, 'yearCompleted', parseInt(e.target.value, 10) || '')} className={inputClass} placeholder="YYYY" required min="1900" max={new Date().getFullYear() + 5} disabled={isPending} /> </div>
             {/* File Input */}
             <div> <label htmlFor={`diplomaFile-${item.id}`} className={labelClass}> Upload Diploma/Transcript {isNewItem ? '(Optional)' : '(Replace Existing - Optional)'} </label> {!isNewItem && item.diplomaFileUrl && !item._selectedFile && ( <div className="mb-1.5 flex items-center gap-1 text-xs text-gray-600"> <PaperClipIcon className="h-3 w-3 flex-shrink-0" /> Current: <a href={item.diplomaFileUrl} target="_blank" rel="noreferrer" className="text-blue-600 hover:underline truncate max-w-[150px]">{item.diplomaFileUrl.split('/').pop()}</a> </div> )} <input type="file" id={`diplomaFile-${item.id}`} name="diplomaFile" onChange={(e) => handleFileChange(item.id, e.target.files?.[0])} className="block w-full text-xs text-gray-500 file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:text-xs file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 disabled:opacity-70" accept=".pdf,.png,.jpg,.jpeg" disabled={isPending} /> {item._selectedFile && ( <div className="mt-1.5 flex items-center gap-1 text-xs text-gray-600"> <PaperClipIcon className="h-3 w-3 flex-shrink-0" /> New: <span>{item._selectedFile.name}</span> <button type="button" onClick={() => handleFileChange(item.id, null)} className="ml-1 text-red-500 hover:text-red-700 focus:outline-none" title="Remove selection" disabled={isPending}></button> </div> )} <p className="text-xs text-gray-500 mt-1">Max 5MB. PDF, PNG, JPG.</p> </div>
        </div>
    );
}


--- END FILE: src\components\profile\AcademicQualificationForm.tsx ---

--- START FILE: src\components\providers\NextAuthProvider.tsx ---
// src/components/providers/NextAuthProvider.tsx
'use client'; // This component wraps SessionProvider, so it must be a Client Component

import { SessionProvider } from 'next-auth/react';
import React from 'react';

interface Props {
    children: React.ReactNode;
    // We might pass the session from the server later for optimization,
    // but for now, SessionProvider will fetch it client-side.
}

export default function NextAuthProvider({ children }: Props) {
    return <SessionProvider>{children}</SessionProvider>;
}


--- END FILE: src\components\providers\NextAuthProvider.tsx ---

--- START FILE: src\lib\auth.ts ---
[EMPTY FILE]

--- END FILE: src\lib\auth.ts ---

--- START FILE: src\lib\db.ts ---
[EMPTY FILE]

--- END FILE: src\lib\db.ts ---

--- START FILE: src\lib\prisma.ts ---
// src/lib/prisma.ts
import { PrismaClient } from '@/generated/prisma';

// Declare a global variable to hold the Prisma Client instance.
// We use 'globalThis' which works in different environments (Node, browser, edge).
// We add '_prisma' to avoid potential naming conflicts.
declare global {
  // eslint-disable-next-line no-var
  var _prisma: PrismaClient | undefined;
}

// Check if we already have an instance in the global scope.
// If not, create a new one. In development, due to Next.js hot reloading,
// 'global._prisma' might already exist, so we reuse it to avoid creating too many connections.
const prisma = globalThis._prisma ?? new PrismaClient();

// In non-production environments, assign the instance to the global scope.
if (process.env.NODE_ENV !== 'production') {
  globalThis._prisma = prisma;
}

// Export the single instance.
export default prisma;


--- END FILE: src\lib\prisma.ts ---

--- START FILE: src\lib\userActions.ts ---
// src/lib/userActions.ts
'use server'; // Mark this file as containing Server Actions

import { getServerSession } from 'next-auth/next';
import { authOptions } from '@/app/api/auth/[...nextauth]/route';
import prisma from '@/lib/prisma';
import type {
    User, AcademicQualification, ProfessionalLicense, WorkExperience,
    ProfessionalAffiliation, AwardRecognition, ProfessionalDevelopment,
    CommunityInvolvement, Publication, ConferencePresentation
 } from '@/generated/prisma';
import { revalidatePath } from 'next/cache';
import fs from 'fs/promises'; // Import Node.js file system promises API
import path from 'path';     // Import Node.js path module
import { v4 as uuidv4 } from 'uuid'; // Import UUID generator

// Type received from the frontend JSON string (doesn't include File objects)
// Exclude fields managed by server or temporary frontend state
type IncomingAcademicQualification = Omit<AcademicQualification, '_selectedFile' | 'createdAt' | 'updatedAt' | 'userId'> & {
    _isNew?: boolean;
    id: string; // Ensure ID is always present (temp or real)
    // Ensure yearCompleted is parsed as number from frontend
    yearCompleted: number;
};

// --- Helper Function to ensure upload directory exists ---
async function ensureUploadDirExists(subDir: string, userId: string): Promise<string> {
    const userDirPath = path.join(process.cwd(), 'public', 'uploads', subDir, userId);
    try {
        await fs.mkdir(userDirPath, { recursive: true });
        // console.log(`Ensured directory exists: ${userDirPath}`); // Keep commented unless debugging
        return userDirPath;
    } catch (error) {
        console.error(`Error creating upload directory (${subDir}):`, error);
        throw new Error(`Could not create upload directory for ${subDir}.`);
    }
}

// --- Helper Function for safe file deletion ---
async function safeDeleteFile(filePath: string | null | undefined) {
    if (!filePath || !filePath.startsWith('/uploads/')) {
        // console.log(`Skipping deletion for invalid or non-local path: ${filePath}`);
        return; // Skip invalid or non-local paths
    }
    try {
        const localFilePath = path.join(process.cwd(), 'public', filePath);
        await fs.unlink(localFilePath);
        console.log(`Successfully deleted file: ${localFilePath}`);
    } catch (error: any) {
        // Log error if file not found (ENOENT) or other issues, but don't throw
        if (error.code === 'ENOENT') {
            console.warn(`File not found during deletion attempt: ${filePath}`);
        } else {
            console.error(`Error deleting file ${filePath}:`, error.message);
        }
    }
}

// --- Helper Function to upload a file ---
async function uploadFile(
    file: File,
    userId: string,
    subDir: string
): Promise<string> { // Returns the relative URL path
    try {
        // Basic validation within upload function as well
        const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB
        const ALLOWED_TYPES = ['application/pdf', 'image/png', 'image/jpeg', 'image/jpg'];
        if (file.size > MAX_FILE_SIZE) { throw new Error(`File size exceeds limit.`); }
        if (!ALLOWED_TYPES.includes(file.type)) { throw new Error('Invalid file type.'); }

        const uploadDir = await ensureUploadDirExists(subDir, userId);
        const fileExtension = path.extname(file.name);
        const uniqueFilename = `${uuidv4()}${fileExtension}`;
        const localFilePath = path.join(uploadDir, uniqueFilename);
        const fileBuffer = Buffer.from(await file.arrayBuffer());
        await fs.writeFile(localFilePath, fileBuffer);
        const relativeUrl = `/uploads/${subDir}/${userId}/${uniqueFilename}`;
        console.log(`File uploaded successfully: ${relativeUrl}`);
        return relativeUrl;
    } catch (uploadError: any) {
        console.error(`Error uploading file:`, uploadError);
        // Re-throw a more specific error or the original one
        throw new Error(`Failed to upload file: ${uploadError.message}`);
    }
}


// --- Get Profile Data Action ---
interface GetUserProfileDataResponse {
    user: { id: string; name: string | null; email: string | null; role: string | null; } | null;
    academicQualifications: AcademicQualification[];
    professionalLicenses: ProfessionalLicense[];
    workExperiences: WorkExperience[];
    professionalAffiliations: ProfessionalAffiliation[];
    awardsRecognitions: AwardRecognition[];
    professionalDevelopments: ProfessionalDevelopment[];
    communityInvolvements: CommunityInvolvement[];
    publications: Publication[];
    conferencePresentations: ConferencePresentation[];
    error?: string;
}
export async function getMyProfileData(): Promise<GetUserProfileDataResponse> {
    const session = await getServerSession(authOptions);
    const userId = (session?.user as any)?.id;
    const defaultResponse: Omit<GetUserProfileDataResponse, 'user' | 'error'> = { academicQualifications: [], professionalLicenses: [], workExperiences: [], professionalAffiliations: [], awardsRecognitions: [], professionalDevelopments: [], communityInvolvements: [], publications: [], conferencePresentations: [], };
    if (!userId) { return { user: null, ...defaultResponse, error: 'Not authenticated' }; }
    try {
        // Include all relations needed for the profile page
        const userWithProfile = await prisma.user.findUnique({
            where: { id: userId },
            include: {
                academicQualifications: { orderBy: { yearCompleted: 'desc' } },
                professionalLicenses: { orderBy: { expiration: 'desc' } },
                workExperiences: { orderBy: { createdAt: 'desc' } }, // Adjust ordering as needed
                professionalAffiliations: { orderBy: { createdAt: 'desc' } },
                awardsRecognitions: { orderBy: { yearReceived: 'desc' } },
                professionalDevelopments: { orderBy: { createdAt: 'desc' } },
                communityInvolvements: { orderBy: { createdAt: 'desc' } },
                publications: { orderBy: { datePublished: 'desc' } },
                conferencePresentations: { orderBy: { createdAt: 'desc' } },
            },
        });
        if (!userWithProfile) { return { user: null, ...defaultResponse, error: 'User not found' }; }
        // Return structured data, ensuring arrays are returned even if relations are null
        return {
             user: { id: userWithProfile.id, name: userWithProfile.name, email: userWithProfile.email, role: userWithProfile.role },
             academicQualifications: userWithProfile.academicQualifications ?? [],
             professionalLicenses: userWithProfile.professionalLicenses ?? [],
             workExperiences: userWithProfile.workExperiences ?? [],
             professionalAffiliations: userWithProfile.professionalAffiliations ?? [],
             awardsRecognitions: userWithProfile.awardsRecognitions ?? [],
             professionalDevelopments: userWithProfile.professionalDevelopments ?? [],
             communityInvolvements: userWithProfile.communityInvolvements ?? [],
             publications: userWithProfile.publications ?? [],
             conferencePresentations: userWithProfile.conferencePresentations ?? [],
        };
    } catch (error) { console.error("Error fetching profile data:", error); return { user: null, ...defaultResponse, error: 'Failed to fetch profile data' }; }
}


// --- Add Qualification Action (Keep for now, maybe deprecated later if updateMyProfile is sufficient) ---
interface AddQualificationResponse { success: boolean; qualification?: AcademicQualification; error?: string; }
export async function addMyQualification(formData: FormData): Promise<AddQualificationResponse> {
    const session = await getServerSession(authOptions);
    const userId = (session?.user as any)?.id;
    if (!userId) { return { success: false, error: 'Not authenticated' }; }
    const degree = formData.get('degree') as string | null;
    const institution = formData.get('institution') as string | null;
    const program = formData.get('program') as string | null;
    const yearCompletedStr = formData.get('yearCompleted') as string | null;
    const diplomaFile = formData.get('diplomaFile') as File | null;
    if (!degree || !institution || !program || !yearCompletedStr) { return { success: false, error: 'Missing required text fields' }; }
    const yearCompleted = parseInt(yearCompletedStr, 10);
    if (isNaN(yearCompleted) || yearCompleted < 1900 || yearCompleted > new Date().getFullYear() + 5) { return { success: false, error: 'Invalid year completed' }; }
    let fileUrl: string | undefined = undefined;
    try {
        if (diplomaFile) { fileUrl = await uploadFile(diplomaFile, userId, 'qualifications'); } // Use helper
        const newQualification = await prisma.academicQualification.create({ data: { degree, institution, program, yearCompleted, userId, diplomaFileUrl: fileUrl }, });
        revalidatePath('/profile'); return { success: true, qualification: newQualification };
    } catch (error: any) { console.error("Error adding academic qualification:", error); await safeDeleteFile(fileUrl); return { success: false, error: `Failed to add qualification: ${error.message}` }; }
}

// --- Delete Qualification Action (Keep for now) ---
interface DeleteQualificationResponse { success: boolean; error?: string; }
export async function deleteMyQualification(qualificationId: string): Promise<DeleteQualificationResponse> {
    const session = await getServerSession(authOptions);
    const userId = (session?.user as any)?.id;
    if (!userId) { return { success: false, error: 'Not authenticated' }; }
    if (!qualificationId) { return { success: false, error: 'Qualification ID is required' }; }
    try {
        const qualification = await prisma.academicQualification.findUnique({ where: { id: qualificationId, userId: userId } });
        if (!qualification) { return { success: false, error: 'Qualification not found or permission denied.' }; }
        const filePathToDelete = qualification.diplomaFileUrl;
        await prisma.academicQualification.delete({ where: { id: qualificationId } });
        await safeDeleteFile(filePathToDelete); // Use helper
        revalidatePath('/profile'); return { success: true };
    } catch (error) { console.error("Error deleting academic qualification:", error); return { success: false, error: 'Failed to delete qualification' }; }
}


// --- Update Profile Action (Handles Creates, Updates, Deletes with Files) ---
interface UpdateProfileResponse { success: boolean; error?: string; }

export async function updateMyProfile(formData: FormData): Promise<UpdateProfileResponse> {
    'use server';
    const session = await getServerSession(authOptions);
    const userId = (session?.user as any)?.id;
    if (!userId) { return { success: false, error: 'Not authenticated' }; }
    console.log(`updateMyProfile called for user: ${userId}`);

    // Extract and Parse Academic Qualifications JSON
    const qualificationsJson = formData.get('academicQualifications_json') as string | null;
    let incomingQualifications: IncomingAcademicQualification[] = [];
    if (qualificationsJson) { try { incomingQualifications = JSON.parse(qualificationsJson); if (!Array.isArray(incomingQualifications)) { throw new Error("Parsed academic qualifications is not an array."); } } catch (e: any) { console.error("Error parsing academicQualifications_json:", e); return { success: false, error: "Invalid data format received." }; } }
    else { console.log("No academic qualifications JSON data provided."); /* Might be okay if other sections exist */ }

    // TODO: Extract other sections similarly

    let filesToDelete: (string | null | undefined)[] = []; // Collect file URLs to delete after transaction

    try {
        const result = await prisma.$transaction(async (tx) => {
            // --- Process Academic Qualifications ---
            const currentQualifications = await tx.academicQualification.findMany({
                where: { userId: userId },
                select: { id: true, diplomaFileUrl: true, degree: true, institution: true, program: true, yearCompleted: true } // Fetch fields needed for comparison
            });
            const currentQualificationMap = new Map(currentQualifications.map(q => [q.id, q]));
            const incomingIds = new Set(incomingQualifications.map(q => q.id));
            const qualificationIdsToDeleteInternal: string[] = [];

            // Identify DB records to delete
            for (const currentQual of currentQualifications) {
                if (!incomingIds.has(currentQual.id)) {
                    qualificationIdsToDeleteInternal.push(currentQual.id);
                    filesToDelete.push(currentQual.diplomaFileUrl); // Mark file for deletion
                }
            }

            // Delete DB records
            if (qualificationIdsToDeleteInternal.length > 0) {
                console.log("Deleting qualification records:", qualificationIdsToDeleteInternal);
                await tx.academicQualification.deleteMany({ where: { id: { in: qualificationIdsToDeleteInternal }, userId: userId } });
            }

            // Process Creates and Updates
            for (const incomingQual of incomingQualifications) {
                const fileKey = `academicQualification_file_${incomingQual.id}`;
                const file = formData.get(fileKey) as File | null;
                let uploadedFileUrl: string | null | undefined = undefined; // undefined = no change/no file provided, null = clear existing file (future use), string = new file URL

                // Upload file if provided
                if (file) {
                    uploadedFileUrl = await uploadFile(file, userId, 'qualifications'); // This will throw on error
                }

                if (incomingQual._isNew) {
                    // --- Create ---
                    if (!incomingQual.degree || !incomingQual.institution || !incomingQual.program || !incomingQual.yearCompleted) { throw new Error(`Missing required fields for new qualification.`); }
                    console.log(`Creating qualification: ${incomingQual.degree}`);
                    await tx.academicQualification.create({
                        data: {
                            degree: incomingQual.degree, institution: incomingQual.institution, program: incomingQual.program, yearCompleted: incomingQual.yearCompleted,
                            diplomaFileUrl: uploadedFileUrl, // Use result from uploadFile (can be null)
                            userId: userId,
                        }
                    });
                } else {
                    // --- Update ---
                    const currentQual = currentQualificationMap.get(incomingQual.id);
                    if (!currentQual) { console.warn(`Trying to update non-existent qualification ID: ${incomingQual.id}`); continue; }

                    const updateData: Partial<AcademicQualification> = {};
                    let needsDbUpdate = false;
                    // Compare text fields
                    if (incomingQual.degree !== currentQual.degree) { updateData.degree = incomingQual.degree; needsDbUpdate = true; }
                    if (incomingQual.institution !== currentQual.institution) { updateData.institution = incomingQual.institution; needsDbUpdate = true; }
                    if (incomingQual.program !== currentQual.program) { updateData.program = incomingQual.program; needsDbUpdate = true; }
                    if (incomingQual.yearCompleted !== currentQual.yearCompleted) { updateData.yearCompleted = incomingQual.yearCompleted; needsDbUpdate = true; }

                    // Check if file needs update/replacement
                    if (uploadedFileUrl !== undefined) { // A file was processed (either uploaded or explicitly cleared/not provided)
                        // Only update URL if the new URL is different from the old one
                        if (uploadedFileUrl !== currentQual.diplomaFileUrl) {
                            updateData.diplomaFileUrl = uploadedFileUrl; // Set the new URL (or null)
                            needsDbUpdate = true;
                            // If replacing an existing file, mark the old one for deletion
                            if (currentQual.diplomaFileUrl) {
                                filesToDelete.push(currentQual.diplomaFileUrl);
                                console.log(`Marking old file for deletion (update): ${currentQual.diplomaFileUrl}`);
                            }
                        }
                    } // If uploadedFileUrl is undefined, it means no file was provided for this existing item in the form, so we don't touch the existing diplomaFileUrl

                    if (needsDbUpdate) {
                        console.log(`Updating qualification ID: ${incomingQual.id}`);
                        await tx.academicQualification.update({
                            where: { id: incomingQual.id, userId: userId },
                            data: updateData
                        });
                    }
                }
            } // End loop

            // TODO: Process other sections similarly

            return { success: true }; // Transaction successful
        }); // End transaction

        // --- Perform File Deletions (Outside Transaction) ---
        if (result.success && filesToDelete.length > 0) {
            console.log("Attempting file deletions post-transaction:", filesToDelete);
            await Promise.all(filesToDelete.map(fileUrl => safeDeleteFile(fileUrl)));
        }

        // Revalidate Path
        if (result.success) {
            revalidatePath('/profile');
            console.log("Profile revalidated.");
        }

        return { success: result.success };

    } catch (error: any) {
        console.error("Error in updateMyProfile transaction or file deletion:", error);
        return { success: false, error: error.message || 'Failed to update profile data' };
    }
}


--- END FILE: src\lib\userActions.ts ---

--- START FILE: src\lib\utils.ts ---
[EMPTY FILE]

--- END FILE: src\lib\utils.ts ---

--- START FILE: src\types\index.ts ---
// src/types/index.ts
import type {
    AcademicQualification, ProfessionalLicense, WorkExperience,
    ProfessionalAffiliation, AwardRecognition, ProfessionalDevelopment,
    CommunityInvolvement, Publication, ConferencePresentation
} from '@/generated/prisma'; // Adjust path if your generated client is elsewhere

// Common temporary properties used during editing state
export type TempCommon = {
    _isNew?: boolean; // Flag to indicate if the item was added locally
    id: string;      // Needs ID (can be temporary UUID for new items or real ID for existing)
};

// Specific temporary types for each section
// Add _selectedFile property only to types that handle file uploads locally
export type TempAcademicQualification = AcademicQualification & TempCommon & { _selectedFile?: File | null; };
export type TempProfessionalDevelopment = ProfessionalDevelopment & TempCommon & { _selectedFile?: File | null; };

// For sections without file uploads managed via _selectedFile in frontend state currently
export type TempProfessionalLicense = ProfessionalLicense & TempCommon;
export type TempWorkExperience = WorkExperience & TempCommon;
export type TempProfessionalAffiliation = ProfessionalAffiliation & TempCommon;
export type TempAwardRecognition = AwardRecognition & TempCommon;
export type TempCommunityInvolvement = CommunityInvolvement & TempCommon;
export type TempPublication = Publication & TempCommon;
export type TempConferencePresentation = ConferencePresentation & TempCommon;

// Union type representing any possible item within the editableData state arrays
export type EditableItem =
    | TempAcademicQualification
    | TempProfessionalLicense
    | TempWorkExperience
    | TempProfessionalAffiliation
    | TempAwardRecognition
    | TempProfessionalDevelopment
    | TempCommunityInvolvement
    | TempPublication
    | TempConferencePresentation;

// You can add other shared application-wide types here as needed
// e.g., export type AdminViewFaculty = { ... };


--- END FILE: src\types\index.ts ---

